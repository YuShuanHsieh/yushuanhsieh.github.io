<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Cross-Network Container Communication - 文組工程師
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="在 Docker 的網路規則中，由於 DOCKER-ISOLATION-STAGE-1、DOCKER-ISOLATION-STAGE-2 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 Linux Bridge 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。" />
    
  <meta name="generator" content="Hugo 0.71.0 with theme pure" />
  <title>Cross-Network Container Communication - 文組工程師</title>
  
  
  <link rel="stylesheet" href="https://yushuanhsieh.github.io/css/style.min.77e7a4b079ffc2025082028f8e6fe3266891d5a844d08c55dc4edb39079aa481.css">
  
    
    <link rel="stylesheet" href="https://yushuanhsieh.github.io/scss/cherie.min.9d783e1aff5bd8d61fd74551461bf2a5c62c232caf17ddaef3c681e53b429d8e.css" async>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="Cross-Network Container Communication" />
<meta property="og:description" content="在 Docker 的網路規則中，由於 DOCKER-ISOLATION-STAGE-1、DOCKER-ISOLATION-STAGE-2 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 Linux Bridge 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yushuanhsieh.github.io/post/2020-07-05-docker-network/" />
<meta property="article:published_time" content="2020-07-05T08:00:00+08:00" />
<meta property="article:modified_time" content="2020-07-05T08:00:00+08:00" />
<meta itemprop="name" content="Cross-Network Container Communication">
<meta itemprop="description" content="在 Docker 的網路規則中，由於 DOCKER-ISOLATION-STAGE-1、DOCKER-ISOLATION-STAGE-2 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 Linux Bridge 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。">
<meta itemprop="datePublished" content="2020-07-05T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-05T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="1201">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cross-Network Container Communication"/>
<meta name="twitter:description" content="在 Docker 的網路規則中，由於 DOCKER-ISOLATION-STAGE-1、DOCKER-ISOLATION-STAGE-2 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 Linux Bridge 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="/" target="">
            <img class="img-circle img-rotate" src="https://yushuanhsieh.github.io/author.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Cherie Hsieh</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Taiwan</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                  <span class="menu-title">Categories</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/conference/" class="category-list-link">conference</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/coscup/" class="category-list-link">coscup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/devops/" class="category-list-link">devops</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/docker/" class="category-list-link">docker</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/game/" class="category-list-link">game</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/gnu/" class="category-list-link">gnu</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/go/" class="category-list-link">go</a><span class="category-list-count">15</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/google-cloud-platform/" class="category-list-link">google-cloud-platform</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/kubernetes/" class="category-list-link">kubernetes</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/life/" class="category-list-link">life</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/meetup/" class="category-list-link">meetup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/network/" class="category-list-link">network</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/operating-system/" class="category-list-link">operating-system</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">7</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/study/" class="category-list-link">study</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/web/" class="category-list-link">web</a><span class="category-list-count">28</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/" class="title">CSE 506 Lab2 - Memory Management and Virtual Memory Mapping</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-11-15 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-11-15</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-11-14-gophercon_2020/" class="title">GopherCon TW 2020 場務組心得</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-11-14 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-11-14</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/" class="title">CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-09-12 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-09-12</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-09-04-vault-security/" class="title">Vault Initialization and Keys Security</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-09-04 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-09-04</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-08-25-comp790-lab1/" class="title">CSE 506 Lab1 - The Stack</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-08-25 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-08-25</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="single-" class="article article-type-single" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/post/2020-07-05-docker-network/"
    >
    
      
        
          <span class="title-cat">Network</span>
        
          <span class="title-cat">Docker</span>
        
      
    Cross-Network Container Communication</a>
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://yushuanhsieh.github.io/post/2020-07-05-docker-network/" class="article-date">
  <time datetime="2020-07-05 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-07-05</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>
  
    <a class="article-category-link" href="/categories/network/"> Network </a>
    <a class="article-category-link" href="/categories/docker/"> Docker </a>
</span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/post/2020-07-05-docker-network/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>在 Docker 的網路規則中，由於 <code>DOCKER-ISOLATION-STAGE-1</code>、<code>DOCKER-ISOLATION-STAGE-2</code> 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 <code>Linux Bridge</code> 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。</p>
<h2 id="docker-container-network">Docker Container Network</h2>
<p>我們知道，Docker 的網路實現是基於 Linux network namespace，Linux network bridge，與 virtual ethernet device 所架構而成的(可參閱 <a href="https://success.docker.com/article/networking#linuxnetworkfundamentals">Linux Network Fundamentals</a>)。</p>
<p>假設我們建立兩個 container，一個連結自定義網路(User-Defined Bridge Networks) host1 與連結預設網路的 host2：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>sudo docker network create h1r1br
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>sudo docker run -d -it --network h1r1br --rm --name h1 ubuntu:16.04
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>sudo docker run -d -it --rm --name h2 ubuntu:16.04
</code></pre></div><p>其結構圖示如下：</p>
<p><img src="/posts/docker-network_1.png" alt="hugo"></p>
<p>我們可以使用 <code>brctl</code> 來查看 bridge 和 veth 關係</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>yu-shuan@:~$ brctl show
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>bridge name	bridge id		STP enabled	interfaces
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>br-0e510c1eeb44	 8000.02429a48a474	no		veth8b7aaa8
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>docker0		         8000.024288b35644	no		vethfa6f0c4
</code></pre></div><p>也可以用 <code>ifconfig</code> 來查看 bridge 與 veth 的資訊</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>yu-shuan@:~$ ifconfig br-0e510c1eeb44
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>br-0e510c1eeb44: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>        inet 172.22.0.1  netmask 255.255.0.0  broadcast 172.22.255.255
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>        inet6 fe80::42:9aff:fe48:a474  prefixlen 64  scopeid 0x20&lt;link&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>        ether 02:42:9a:48:a4:74  txqueuelen 0  (Ethernet)
</code></pre></div><p>我們進入 <code>host1</code> container，來看 routing 設定：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>root@fb1431179a56:/# ip route
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>default via 172.22.0.1 dev eth0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>172.22.0.0/16 dev eth0  proto kernel  scope link  src 172.22.0.2
</code></pre></div><p>由於 host1 只有一個 interface，因此無論 Dst IP 是什麼，都會從 eth0 出去，而 host2 也同理。</p>
<h2 id="connection-test">Connection Test</h2>
<h3 id="case-1-host1-connects-to-the-internet">Case 1: host1 connects to the internet</h3>
<p>接著我們看一下從 host1 container 是如何與外部 internet 聯繫的。我們從 host1 container ping google server (169.254.169.254)。</p>
<p><img src="/posts/docker-network_2.png" alt="hugo"></p>
<p>從 host1 發送 icmp 封包，由於沒有 169.254.169.254 的 MAC 資訊，因此將封包轉送到 default gateway(dst_Mac 改成 gatyeway 的 mac address)，也就是 bridge br-0e510c1eeb44(h1r1br)，從 eth0 出去。</p>
<p>當封包抵達 bridge br-0e510c1eeb44 後，就是在本機端處理此封包，因此會使用本機端的 iptable 設定。同樣地，由於沒有 169.254.169.254 的資訊，因此會轉發到本機設定的 default gateway，並檢查 filter table 中的對應 rules，最後發送到外部網路。</p>
<h3 id="case-2-host11722202-ping-host21721702">Case 2: host1(172.22.0.2) ping host2(172.17.0.2)</h3>
<p>再來討論 host1 ping host2 的場景～我們第一直覺就能夠判斷一定不能通。那為什麼不能通呢？</p>
<p>封包處理流程跟上面第一個例子相似， icmp 封包會被轉發到本機端，其中最大的差別在於：<strong>此 icmp 封包會被 filter.FORWARD table Drop 掉</strong>，因此就無法將封包發送到目標 host2 container 中。</p>
<p>透過 iptables command-lin tool 來查看 table 設定：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>yu-shuan@:~$ sudo iptables -nL --line-numbers -v -t filter
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>Chain INPUT (policy ACCEPT 1921 packets, 227K bytes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>1     199K 1215M sshguard   all  --  *      *       0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>Chain FORWARD (policy DROP 0 packets, 0 bytes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>1    49568   61M DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>2    49568   61M DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>Chain DOCKER-ISOLATION-STAGE-1 (1 references)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>1     9119  499K DOCKER-ISOLATION-STAGE-2  all  --  br-0e510c1eeb44 !br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>2     4729  252K DOCKER-ISOLATION-STAGE-2  all  --  br-5004af5170da !br-5004af5170da  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>3       78 18422 DOCKER-ISOLATION-STAGE-2  all  --  br-a0789b166030 !br-a0789b166030  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>4      901 48486 DOCKER-ISOLATION-STAGE-2  all  --  br-e7d606a081d9 !br-e7d606a081d9  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>5        0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-e0e7a31ff7d4 !br-e0e7a31ff7d4  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>6    70549 8287K DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>7    1161K  805M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>Chain DOCKER-ISOLATION-STAGE-2 (6 references)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>1        0     0 DROP       all  --  *      br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>2        0     0 DROP       all  --  *      br-5004af5170da  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>3        0     0 DROP       all  --  *      br-a0789b166030  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>4       31 15348 DROP       all  --  *      br-e7d606a081d9  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>5        6   504 DROP       all  --  *      br-e0e7a31ff7d4  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>6        2   168 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>7    85337 9089K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</code></pre></div><p>封包會進入 <code>DOCKER-ISOLATION-STAGE-1</code>，接著 match 到其中 number 1 的 rule</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Chain DOCKER-ISOLATION-STAGE-1 (1 references)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>1     9119  499K DOCKER-ISOLATION-STAGE-2  all  --  br-0e510c1eeb44 !br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
</code></pre></div><p>最後進入 <code>DOCKER-ISOLATION-STAGE-2</code>，match 到 number 6 的 rule，封包被 Drop 掉。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Chain DOCKER-ISOLATION-STAGE-2 (6 references)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>num   pkts bytes target     prot opt in     out     source               destination
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>6        2   168 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
</code></pre></div><h2 id="cross-network-container-communication-via-a-router">Cross-Network Container Communication via a Router</h2>
<p>如果要讓兩個分別在不同 bridge 的 container 互相溝通，最重要的是如何符合 docker 本身在 iptables 所設定的規則。而在實體網路中，我們會使用 router 來連結兩個網段的網路，相同的概念也可以應用在 docker container 上，以實現跨 network bridge 溝通的目的。</p>
<p>首先，我們先起一個 router container，並且使用不同的 network 把 host1、host2、與 router 連結在一起。</p>
<p><img src="/posts/docker-network_3.png" alt="hugo"></p>
<p>如此一來，host1 的封包可以透過 h1r1br Bridge 傳送到 router1 ，接著再經過 docker0 bridge 將封包從 router1 傳送到 host2。</p>
<p>當然，只是將 router 1 連結 host1、host2 還不夠，我們還要設定 host1、host2 的 default gateway，這樣才能確保封包能正確地走到 router1 再傳出去。</p>
<p>Host1</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>ip route del default
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>ip route add default via 172.22.0.3
</code></pre></div><p>Host2</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>ip route del default
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>ip route add default via 172.17.0.3
</code></pre></div><p>經過這樣的調整後，封包處理流程會變成：</p>
<p><img src="/posts/docker-network_4.png" alt="hugo"></p>
<ol>
<li>host1 ping <code>172.17.0.2</code> (host2)</li>
<li>host1 routing table 沒有 172.17.0.0/16 的資訊，走 default gatway</li>
<li>default gatway 被設定為 <code>172.22.0.3</code> 因此 dst_mac 會變成 router1 eth0 的 mac address(如果 host1 的 arp table 沒有紀錄 <code>172.22.0.3</code> mac address，則 host1 會發送 <strong>ARP request</strong> 去詢問，而因為 <code>172.22.0.3</code> 在同一個 bridge 上，因此可以得到 ARP response)</li>
<li>封包傳送至 h1r1br Bridge，而由於 dst_mac <strong>不是</strong> h1r1br Bridge 的 mac address，且 <code>dst_mac</code> <code>src_mac</code> interface 皆在同一個 bridge 上，因此符合 docker 網路規範，封包不會被 drop 掉。</li>
</ol>
<h3 id="the-importance-of-bridges-decision">The importance of bridge&rsquo;s decision</h3>
<p>這裡有一個<strong>非常重要</strong>的概念，就是封包的 dst_mac mac address 會影響 Linux Bridge 處理封包的流程。根據 <a href="http://ebtables.netfilter.org/br_fw_ia/br_fw_ia.html">ebtables/iptables interaction on a Linux-based bridge</a> 中有提到：</p>
<p>The bridge&rsquo;s decision for a frame can be one of these:</p>
<ul>
<li>bridge it, if the destination MAC address is <strong>on another side of the bridge</strong>;</li>
<li>flood it over all the forwarding bridge ports, if the position of the box with the destination MAC is unknown to the bridge;</li>
<li>pass it to the higher protocol code (the IP code), if the destination MAC address is <strong>that of the bridge or of one of its ports</strong>;</li>
<li>ignore it, if the destination MAC address is located <strong>on the same side of the bridge</strong>.</li>
</ul>
<p>如果我們<strong>沒有</strong>設定 host1 的 default gateway 是 router1 的 eth0，那麼 default gateway 的 mac address 就會變成 h1r1br Bridge 的 mac address，並且根據上面 bridge&rsquo;s decision 所描述，會將封包 <strong>pass 到 IP Network Layer</strong>， 接著根據 <strong>routing table</strong> 來決定 output interface，此時 dst_mac mac address 就會變成 docker0，最後就會在 filter.FORWARD 階段被 Drop 掉。</p>
<h3 id="etableiptable-logs">etable/iptable Logs</h3>
<p>我們從 log 來確認剛剛的敘述是否正確。</p>
<ul>
<li>Default Gateway is router1 eth0</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817044] [raw.PREROUTING]IN=br-0e510c1eeb44 OUT= PHYSIN=veth8b7aaa8 MAC=02:42:ac:16:00:03:02:42:ac:16:00:02:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=64082 DF PROTO=ICMP TYPE=8 CODE=0 ID=1164 SEQ=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817061] TRACE: eb:filter:FORWARD IN=veth8b7aaa8 OUT=veth6d5ff81 MAC source = 02:42:ac:16:00:02 MAC dest = 02:42:ac:16:00:03 proto = 0x0800 IP SRC=172.22.0.2 IP DST=172.21.0.2, IP tos=0x00, IP proto=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817070] [filter.FORWARD]IN=br-0e510c1eeb44 OUT=br-0e510c1eeb44 PHYSIN=veth8b7aaa8 PHYSOUT=veth6d5ff81 MAC=02:42:ac:16:00:03:02:42:ac:16:00:02:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=64082 DF PROTO=ICMP TYPE=8 CODE=0 ID=1164 SEQ=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817130] [raw.PREROUTING]IN=br-5004af5170da OUT= PHYSIN=veth83ddfd8 MAC=02:42:ac:15:00:02:02:42:ac:15:00:03:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=64082 DF PROTO=ICMP TYPE=8 CODE=0 ID=1164 SEQ=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817134] TRACE: eb:filter:FORWARD IN=veth83ddfd8 OUT=veth56a6af1 MAC source = 02:42:ac:15:00:03 MAC dest = 02:42:ac:15:00:02 proto = 0x0800 IP SRC=172.22.0.2 IP DST=172.21.0.2, IP tos=0x00, IP proto=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817141] [filter.FORWARD]IN=br-5004af5170da OUT=br-5004af5170da PHYSIN=veth83ddfd8 PHYSOUT=veth56a6af1 MAC=02:42:ac:15:00:02:02:42:ac:15:00:03:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=64082 DF PROTO=ICMP TYPE=8 CODE=0 ID=1164 SEQ=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817209] TRACE: eb:filter:FORWARD IN=veth56a6af1 OUT=veth83ddfd8 MAC source = 02:42:ac:15:00:02 MAC dest = 02:42:ac:15:00:03 proto = 0x0800 IP SRC=172.21.0.2 IP DST=172.22.0.2, IP tos=0x00, IP proto=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>Jul  6 06:56:45 sdn-experi-project kernel: [313896.817220] TRACE: eb:filter:FORWARD IN=veth6d5ff81 OUT=veth8b7aaa8 MAC source = 02:42:ac:16:00:03 MAC dest = 02:42:ac:16:00:02 proto = 0x0800 IP SRC=172.21.0.2 IP DST=172.22.0.2, IP tos=0x00, IP proto=1
</code></pre></div><ul>
<li>Default Gateway is h1r1br Bridge</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Jul  6 07:06:23 sdn-experi-project kernel: [314474.517447] [raw.PREROUTING]IN=br-0e510c1eeb44 OUT= PHYSIN=veth8b7aaa8 MAC=02:42:9a:48:a4:74:02:42:ac:16:00:02:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=52580 DF PROTO=ICMP TYPE=8 CODE=0 ID=1180 SEQ=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>Jul  6 07:06:23 sdn-experi-project kernel: [314474.517594] TRACE: eb:filter:INPUT IN=veth8b7aaa8 OUT= MAC source = 02:42:ac:16:00:02 MAC dest = 02:42:9a:48:a4:74 proto = 0x0800 IP SRC=172.22.0.2 IP DST=172.21.0.2, IP tos=0x00, IP proto=1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>Jul  6 07:06:23 sdn-experi-project kernel: [314474.517622] [filter.FORWARD]IN=br-0e510c1eeb44 OUT=br-5004af5170da PHYSIN=veth8b7aaa8 MAC=02:42:9a:48:a4:74:02:42:ac:16:00:02:08:00 SRC=172.22.0.2 DST=172.21.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=52580 DF PROTO=ICMP TYPE=8 CODE=0 ID=1180 SEQ=1
</code></pre></div><p>比對 netfilter package flow：</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg" alt=""></p>
<p>可以看到最重要的差異在於 default gateway 是 router1 eth0 的時候，會走 <code>bridge-level filter.FORWARD</code>，反之如果是 h1r1br Bridge， 則會走 <code>bridge-level filter.INPUT</code> 並經過 routing decision，而造成此差異的原因就在於 <strong>bridge&rsquo;s decision</strong>。</p>
<h2 id="結論">結論</h2>
<p>我們使用 router 的方式來實現 cross-network container communication，由於 Docker container network 結合 linux bridge 來實作網路模型，因此上述透過實驗來驗證封包在 bridge 的流向和處理方式，了解這樣的流程，對於未來在 debug 相關議題上都非常有幫助。</p>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://yushuanhsieh.github.io/post/2020-07-05-docker-network/" title="Cross-Network Container Communication" target="_blank" rel="external">https://yushuanhsieh.github.io/post/2020-07-05-docker-network/</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://yushuanhsieh.github.io/author.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">Cherie Hsieh</span><small class="ml-1x">Software Engineer</small></a></h3>
        <div>Gopher</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://yushuanhsieh.github.io/post/2020-06-25-study-05/" title="2020/05 月份自我學習回顧"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://yushuanhsieh.github.io/post/2020-08-04-coscup-go/"
                    title="COSCUP 2020 - Goroutine stack and local variable allocation in Go"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
  <div class="copyright">
    &copy;2017  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="https://yushuanhsieh.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://yushuanhsieh.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/yushuanhsieh.github.io',
            CONTENT_URL: 'https:\/\/yushuanhsieh.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://yushuanhsieh.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
