<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1) - 文組工程師
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="前言 之前是看 COMP790 的課程，但是實作起來發現有點問題，而且題目跟實際 source code 說明不太一樣。在花了很多時間釐清之後，發現原課程內容可能來自於 CSE 506: Lecture from Stony Brook University，仔細看了一下 CSE 506 的 Lab 課程，發現題目與 source code 相符程度較高，因此後續會改看 CSE 506 這系列課程。" />
    
  <meta name="generator" content="Hugo 0.71.0 with theme pure" />
  <title>CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1) - 文組工程師</title>
  
  
  <link rel="stylesheet" href="https://yushuanhsieh.github.io/css/style.min.77e7a4b079ffc2025082028f8e6fe3266891d5a844d08c55dc4edb39079aa481.css">
  
    
    <link rel="stylesheet" href="https://yushuanhsieh.github.io/scss/cherie.min.9d783e1aff5bd8d61fd74551461bf2a5c62c232caf17ddaef3c681e53b429d8e.css" async>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)" />
<meta property="og:description" content="前言 之前是看 COMP790 的課程，但是實作起來發現有點問題，而且題目跟實際 source code 說明不太一樣。在花了很多時間釐清之後，發現原課程內容可能來自於 CSE 506: Lecture from Stony Brook University，仔細看了一下 CSE 506 的 Lab 課程，發現題目與 source code 相符程度較高，因此後續會改看 CSE 506 這系列課程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/" />
<meta property="article:published_time" content="2020-09-12T08:00:00+08:00" />
<meta property="article:modified_time" content="2020-09-12T08:00:00+08:00" />
<meta itemprop="name" content="CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)">
<meta itemprop="description" content="前言 之前是看 COMP790 的課程，但是實作起來發現有點問題，而且題目跟實際 source code 說明不太一樣。在花了很多時間釐清之後，發現原課程內容可能來自於 CSE 506: Lecture from Stony Brook University，仔細看了一下 CSE 506 的 Lab 課程，發現題目與 source code 相符程度較高，因此後續會改看 CSE 506 這系列課程。">
<meta itemprop="datePublished" content="2020-09-12T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-09-12T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="1346">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)"/>
<meta name="twitter:description" content="前言 之前是看 COMP790 的課程，但是實作起來發現有點問題，而且題目跟實際 source code 說明不太一樣。在花了很多時間釐清之後，發現原課程內容可能來自於 CSE 506: Lecture from Stony Brook University，仔細看了一下 CSE 506 的 Lab 課程，發現題目與 source code 相符程度較高，因此後續會改看 CSE 506 這系列課程。"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="/" target="">
            <img class="img-circle img-rotate" src="https://yushuanhsieh.github.io/author.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Cherie Hsieh</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Taiwan</small>
        </div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/post/1900-01-01-about/">
                  <span class="menu-title">About</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                  <span class="menu-title">Categories</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/conference/" class="category-list-link">conference</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/coscup/" class="category-list-link">coscup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/devops/" class="category-list-link">devops</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/docker/" class="category-list-link">docker</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/game/" class="category-list-link">game</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/gnu/" class="category-list-link">gnu</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/go/" class="category-list-link">go</a><span class="category-list-count">16</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/google-cloud-platform/" class="category-list-link">google-cloud-platform</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/kubernetes/" class="category-list-link">kubernetes</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/life/" class="category-list-link">life</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/linux-kernel/" class="category-list-link">linux-kernel</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/meetup/" class="category-list-link">meetup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/network/" class="category-list-link">network</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/operating-system/" class="category-list-link">operating-system</a><span class="category-list-count">7</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">11</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/security/" class="category-list-link">security</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/study/" class="category-list-link">study</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/web/" class="category-list-link">web</a><span class="category-list-count">30</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-05-23-lab4-multiprocessor/" class="title">CSE 506 Lab 4 - Multiprocessor Support and Cooperative Multitasking</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-05-23 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-05-23</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-04-24-go-calling-convention/" class="title">Switch to a register-based calling convention for Go functions</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-24 01:00:00 &#43;0800 CST" itemprop="datePublished">2021-04-24</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-04-22-life/" class="title">近況雜談</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-22 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-04-22</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-02-18-l1-cache-arm/" class="title">L1 Cache architecture in ARM</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-02-18 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-02-18</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-02-11-th02-driver/" class="title">TH02 sensor device driver</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-02-10 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-02-10</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="single-" class="article article-type-single" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/post/2020-09-12-lab2-1/"
    >
    
      
        
          <span class="title-cat">Operating System</span>
        
      
    CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)</a>
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/" class="article-date">
  <time datetime="2020-09-12 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-09-12</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>
  
    <a class="article-category-link" href="/categories/operating-system/"> Operating System </a>
</span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/post/2020-09-12-lab2-1/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h2 id="前言">前言</h2>
<p>之前是看 <a href="https://www.cs.unc.edu/~porter/courses/comp790/s20/index.html">COMP790</a> 的課程，但是實作起來發現有點問題，而且題目跟實際 source code 說明不太一樣。在花了很多時間釐清之後，發現原課程內容可能來自於 <a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/schedule.html">CSE 506: Lecture from Stony Brook University</a>，仔細看了一下 CSE 506 的 Lab 課程，發現題目與 source code 相符程度較高，因此後續會改看 CSE 506 這系列課程。</p>
<p>這次 Lab 花了大概 20 小時來實作，主要原因是有些 source code 的註解是錯誤的，所以單看註解會產生很多疑問，必須實作和觀察才能釐清。這次實驗也讓我體會到，如果覺得哪邊有不太理解的地方，就直接做實驗來驗證，而不要單看註解來去試圖理解它上面的意思，因為如果註解不是正確的，那這些時間也就浪費了。</p>
<p>因為這次實驗要整理的內容蠻多的，擔心文章太長，所以會分成數篇來貼！</p>
<h2 id="lab-實驗介紹">Lab 實驗介紹</h2>
<p>Lab 2 是實作 physical memory allocator 和 virtual memory allocator，其中最重要的是清楚 physical memory 與 virtual memory 之間的轉換，以及如何運用 Lab 2 的 <code>PageInfo</code> c structure 把兩者 mapping 起來。</p>
<h3 id="預前知識">預前知識</h3>
<ol>
<li>
<p><a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">AMD64 Architecture Programmer&rsquo;s Reference Manual: Chapter 5 Page Translation and Protection</a>
JOS 大量使用 paging 進行 virtual memory 與 physical memory 轉換，因此首要知識就是要了解 processor 的 page translation 規則，尤其是 long mode page translation。另外，flag 解釋也要先行看過，這樣在看 source code 的時候可以更快進入狀況。</p>
</li>
<li>
<p><a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">GNU Multiboot Specification</a>
在 boot loader 階段，會透過 BIOS function 來取得當前 physical memory 的配置狀態(<a href="https://wiki.osdev.org/Detecting_Memory_(x86)#Getting_an_E820_Memory_Map">Getting an E820 Memory Map</a>)，其中我們需要解讀回傳後的 buffer 的資訊，而 GNU Multiboot Specification 提供完整的解讀說明。</p>
</li>
</ol>
<h2 id="問題">問題</h2>
<p>在進入實驗之前，有幾個問題需要先釐清：</p>
<ol>
<li>文件說明提到 JOS kernel 在執行時，是以 <code>0x8004000000</code> 位置開始執行，那這麼 address 是在哪裡設置的？又，processor 是如何知道該怎麼解析這個 virtual address？</li>
<li></li>
<li>我們可以使用的 physical memory 上限？</li>
</ol>
<p>為了瞭解這些問題，就要先從 bootloader / bootstrap source code 著手。</p>
<h3 id="1-get-e820-memory-map">1. Get E820 Memory Map</h3>
<p>首先，在 bootloader 階段，JOS 透過 x86 的 BIOS function 來取得目前記憶體配置狀態。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>.set multiboot_info, 0x7000 // After the boot block
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>.set e820_map, multiboot_info + 52
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>.set e820_map4, multiboot_info + 56
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>.set MB_flag, multiboot_info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>.set MB_mmap_len, multiboot_info + 44
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>.set MB_mmap_addr, multiboot_info + 48
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>do_e820:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  movl $0xe820, %eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  movl $e820_map4, %edi <span style="color:#008000"># e820_map4 = buffer address of destination</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  xorl %ebx, %ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  movl $0x534D4150, %edx # 0x534D4150 = ASCII for &#39;SMAP&#39;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  movl $24, %ecx <span style="color:#008000"># 24bytes = the size of destination buffer</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  int $0x15
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  jc failed
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  cmpl %eax, %edx <span style="color:#008000"># %eax will be set to 0x534D4150 if succeed</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  jne failed
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  testl %ebx, %ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  je failed
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  movl $24, %ebp # %ebp records the length of result
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>next_entry:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  <span style="color:#008000">#increment di</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  movl %ecx, -4(%edi)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  addl $24, %edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  movl $0xe820, %eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  movl $24, %ecx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  int $0x15
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  jc done
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  addl $24, %ebp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  testl %ebx, %ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  jne next_entry
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>done:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  movl %ecx, -4(%edi)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  movw $0x40, (MB_flag) <span style="color:#008000"># the flag value for multiboot_info</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  movl $e820_map, (MB_mmap_addr)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  movl %ebp, (MB_mmap_len)
</code></pre></div><p>每次執行 e820 BIOS function 會得到一條 memory map entry 的資訊(<code>%ebx</code> value 表示 entry 的 index，所以在一開始執行時先將 <code>%ebx</code> index 設置為 0)，透過 loop 的方式來獲得所有的 entries。</p>
<h4 id="note-1-the-address-of-multiboot_info">Note 1: The address of <code>multiboot_info</code></h4>
<p>在 code 會看到關於 multiboot_info address 設定：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>.set multiboot_info, 0x7000 // After the boot block
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>.set e820_map, multiboot_info + 52
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>.set e820_map4, multiboot_info + 56
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>.set MB_flag, multiboot_info
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>.set MB_mmap_len, multiboot_info + 44
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>.set MB_mmap_addr, multiboot_info + 48
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>
</code></pre></div><p>multiboot_info 的起始 address 被設定在<code>0x7000</code>，根據 <a href="https://wiki.osdev.org/Memory_Map_(x86)">Memory Map (x86)</a> ，<code>0x7C00</code> 是 bootloader sector 位置，而 BIOS data 後的 <code>0x00000500 - 0x00007BFF</code> 這段 30 KiB 記憶體位置可供使用，因此才設定在 <code>0x7000</code> 此位置，只要有足夠的 buffer 來放 multiboot_info 資訊，那麼將 <code>0x7C00</code> 調整成其他位址也可以。</p>
<p>有了 multiboot_info 起始位址之後，就可以根據 <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">GNU Multiboot Specification</a> 中的 multiboot information structure 來推算 <code>e820_map</code>、<code>MB_mmap_len</code>、<code>MB_mmap_addr</code> 的位址，所以<code>+52</code>、<code>+56</code> 等看似 magic number 的數字，其實只是 multiboot information structure 的對應位置。</p>
<h3 id="2-switch-from-bootloader-to-kernel-bootstrap">2. Switch from bootloader to kernel bootstrap</h3>
<p>取得 e820 memory map 資訊後，還有幾個步驟需要執行，包含：</p>
<ol>
<li>Load e820 map -&gt; 目前完成階段</li>
<li>Switch from real mode to protcted mode (這樣才能使用 1MB 以上的 memory)</li>
<li>Load kernel (ELF)</li>
<li>Execute the entry point of ELF and pass multiboot_info to kernel</li>
</ol>
<p>其中，processor 在執行 code 時是使用哪些記憶體區段，是值得注意的地方。</p>
<p>x86 BIOS 會將 bootloader load 到 <code>0x7C00 - 0x7DFF</code> 記憶體區段，那麼 kernel code 會是在哪個記憶體區段呢？我們查看 GNU JOS 的 GNU link script <code>kernel.ld</code> 得到解答。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>SECTIONS
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    . = 0x100000;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    .bootstrap : {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        obj/kern/bootstrap.o (.text .data .bss)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    /* Link the kernel at this address: <span style="color:#a31515">&#34;.&#34;</span> means the current address */
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    . = 0x8004200000;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    .text : AT(0x200000) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        *(EXCLUDE_FILE(obj/kern/bootstrap.o) .text .stub .text.* .gnu.linkonce.t.*)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    PROVIDE(etext = .);	/* Define the <span style="color:#a31515">&#39;etext&#39;</span> symbol to this value */
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    .rodata : {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        *(EXCLUDE_FILE(obj/kern/bootstrap.o) .rodata .rodata.* .gnu.linkonce.r.*)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    /* Adjust the address for the data segment to the next page */
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    . = ALIGN(0x1000);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    /* The data segment */
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    .data : {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        *(EXCLUDE_FILE(obj/kern/bootstrap.o) .data)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    PROVIDE(edata = .);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    .bss : {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        *(EXCLUDE_FILE(obj/kern/bootstrap.o) .bss)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>}
</code></pre></div><p>上面 code 可以看到兩個關鍵 address <code>0x100000</code> 與 <code>0x8004200000</code>。</p>
<p>透過 script 可以知道，<code>bootstrap.o</code> 的 start address 為 <code>0x100000</code>，而 <code>0x100000</code> 還在 256 MB 實體記憶體的範圍，只要該記憶體段是可被使用的，那 processor 就可以正常執行 code。不過 <code>0x8004200000</code> 可就超出實體記憶體範圍，所以可以猜想在 bootstrap 階段，勢必要進行一些配置，才能讓 processor 正確地處理 <code>0x8004200000</code> 位址。</p>
<p>了解 excute code 和 data 被放在哪些記憶體區段，對於看 asm code 來說很重要。舉例來說，上面有提及我們要把 multiboot_info 位址 pass 到 kernel 中，在 bootstrap.S 可以看到這段：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#008000"># Save multiboot_info addr passed by bootloader</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>movl $multiboot_info, %eax # the address of multiboot_info is 0x107000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>movl %ebx, (%eax) # %ebx value is 0x7000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>
</code></pre></div><p>要注意，<strong>bootloader boot.S 中定義的 multiboot_info 位址和 bootstrap.S 中定義的 multiboot_info 位址是不一樣的</strong>，因為 bootstrap.S 經過 linker re-location，multiboot_info 的位址會以 <code>0x100000</code> 為基準點。因此，上述這段 code 的解釋會變成：在 0x107000 記憶體位址的值是 0x7000，而 0x7000 才是我們真正儲存 multiboot_info 資訊的位址。</p>
<h3 id="3-setup-page-translation-in-bootstrap-stage">3. Setup page translation in bootstrap stage</h3>
<p>在真正進入 kernel main function 之前，我們還有一些事情需要先做，而 bootstrap 階段就是用來進行這些準備任務，包含：</p>
<ol>
<li>setup page translation</li>
<li>switch from protected mode to long mode</li>
</ol>
<p>其中 page translation 是重點，bootstrap 階段的 page translation 設置是讓 kernel code 可以正確被執行，而我們在 kerel code 中會再根據需求來配置<strong>新的</strong> page translation (就是 Lab 2的實作內容)，最後切換到我們所配置的 page translation。</p>
<p>所以，我們可以先透過觀察 bootstrap 的 page translation 配置方式，搭配 <a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">AMD64 Architecture Programmer&rsquo;s Reference Manual</a>，來實際理解 page translation 的運作流程，有助於我們後續實作。</p>
<h4 id="setup-page-translation">Setup page translation</h4>
<p>首先，來看一下 long mode 如何進行 page translation (<a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">image source</a>)。</p>
<p><img src="https://i.imgur.com/sDBkI9T.png" alt=""></p>
<p>從圖中可以看到，long mode 的 page translation 被分成四個階層的 page table：</p>
<ol>
<li>Level 4 - PML4</li>
<li>Level 3 - PDPT</li>
<li>Level 2 - PDT</li>
<li>Level 1 - PT</li>
</ol>
<p>而 processor 透過 <code>CR3 register</code> 來獲得 PML4 位址，接著解析 virtual address 來取得各階層 table 的 offset，最後逐步得到實體記憶體位置。</p>
<p>有了這個概念之後，再來看 bootstrap.S 的 code：</p>
<p>起初，配置 PML4、PDPT 和 PDT ，每個 table 大小為 4096 bytes。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>.set pml4, pml4phys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>.set pdpt1,  pml4 + 0x1000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>.set pdpt2,  pml4 + 2*0x1000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>.set pde1, pml4 + 3*0x1000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>.set pde2, pml4 + 4*0x1000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>
</code></pre></div><p>再將這些 table 的 entry 初始化為 0。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>movl $pml4,%edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>xorl %eax,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>movl $((4096/4)*5),%ecx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>rep stosl <span style="color:#008000"># 將 eax 的值儲存到 edi 中，重複 (4096/4)*5 次，每次 edi 增加 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>
</code></pre></div><p>接著配置 PML4 table 的 entry，從下方 code 可以知道有兩個 PML4 entry 指向 pdpt1 和 pdpt2，其權限 PTE_P(present) 和 PTE_W (write)。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>movl $pml4,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>movl $pdpt1, %ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>orl $PTE_P,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>orl $PTE_W,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>movl %ebx,(%eax)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>movl $pdpt2, %ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>orl $PTE_P,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>orl $PTE_W,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>movl %ebx,0x8(%eax)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
</code></pre></div><p>再來配置 PDPT 的 entry。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>movl $pdpt1,%edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>movl $pde1,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>orl $PTE_P,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>orl $PTE_W,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>movl %ebx,(%edi)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>movl $pdpt2,%edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>movl $pde2,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>orl $PTE_P,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>orl $PTE_W,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>movl %ebx,(%edi)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
</code></pre></div><p>接下來到比較核心的配置。
上面提到，kernel 的 start address 是 <code>0x8004000000</code>，我們根據 page translation 的格式，將 <code>0x8004000000</code> 拆解開來，會發現 <code>0x8004000000</code> 是指：</p>
<ul>
<li>PML4 table offset 1</li>
<li>PDPT table offset 0</li>
<li>PD table offset 32</li>
</ul>
<p>這也就是為什麼下方 code <code>addl $256,%ebx</code> 的原因，因為 256/8(一個 entry 佔 8 bytes) = 32 entry offset。我們需要配置 32th PDE 才能夠讓 processor 解讀 <code>0x8004000000</code> 位址。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>movl $128,%ecx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>movl $pde1,%edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>movl $pde2,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>addl $256,%ebx 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#008000"># PTE_P|PTE_W|PSE</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>movl $0x00000183,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>1:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span> movl %eax,(%edi)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span> movl %eax,(%ebx)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span> addl $0x8,%edi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span> addl $0x8,%ebx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span> addl $0x00200000,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span> subl $1,%ecx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span> cmp $0x0,%ecx
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span> jne 1b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
</code></pre></div><p>此外，code 中也額外配置 128 個 PDE ($128,%ecx，然後跑 loop)，其中重點是 PDE 的 flag 設定：PTE_P|PTE_W | <strong>PSE</strong>，PSE 是特殊 flag，根據手冊說明：</p>
<blockquote>
<p>PS bit in the page directory entry (PDE.PS) selects between 4-Kbyte and 2-Mbyte page sizes。</p>
</blockquote>
<p>因此， page translation 會變成下圖，取消 Level 1 PT 這層級 (<a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">image source</a>)：</p>
<p><img src="https://i.imgur.com/uLJV9hh.png" alt=""></p>
<p>配置好各階層的 table 之後，最後把 PML4 table 位址記錄在 CR3 register 上。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>movl $pml4,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>movl %eax, %cr3
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>
</code></pre></div><p>如此一來就完成 page translation 的重點配置，最後再 enable paging 功能，processor 就會根據這些配置來查找出實體記憶體位址。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>movl %cr0,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>orl $CR0_PE,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>orl $CR0_PG,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>orl $CR0_AM,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>orl $CR0_WP,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>orl $CR0_MP,%eax
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>movl %eax,%cr0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>
</code></pre></div><h3 id="4-switch-from-bootstrap-to-kernel-main-function-and-parse-multiboot_info">4. Switch From bootstrap to kernel main function and parse <code>multiboot_info</code></h3>
<p>Page translation 設置好後，就可以進入到 kernel main function 並且使用定義好的 c multiboot_info structure 解析 e820 memory map 的資料，解析完的資料會如下：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>size: 20, address: 0x0000000000000000, length: 0x000000000009fc00, type: USABLE
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>size: 20, address: 0x000000000009fc00, length: 0x0000000000000400, type: RESERVED
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>size: 20, address: 0x00000000000f0000, length: 0x0000000000010000, type: RESERVED
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>size: 20, address: 0x0000000000100000, length: 0x000000000fefe000, type: USABLE
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>size: 20, address: 0x000000000fffe000, length: 0x0000000000002000, type: RESERVED
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>size: 20, address: 0x00000000feffc000, length: 0x0000000000004000, type: RESERVED
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>size: 20, address: 0x00000000fffc0000, length: 0x0000000000040000, type: RESERVED
</code></pre></div><p>可以看到起始位址為 <code>0x100000</code> 的記憶體區段（<code>Extended Memory</code>），而這會是我們主要用來執行 code 的區段。</p>
<p>另外，透過 MIT 特製的 qemu monitor 來查看 page translation 配置情況，驗證是否與我們所推想的一致（正常版本的 qemu 沒有此功能）：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-s" data-lang="s"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>(qemu) info pg
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>VPN range             Entry         Flags            Physical page
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>[000000000-000000000] PML4[000]     ----A---WP
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  [000000000-00003ffff]  PDP[000]     ----A---WP
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    [000000000-0000001ff]  PDE[000]     -GSDA---WP 0000000000-00000001ff
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    [000000200-0000003ff]  PDE[001]     -GS-A---WP 0000000200-00000003ff
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    [000000400-00000ffff]  PDE[002-07f] -GS-----WP 0000000400-000000ffff
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>[008000000-008000000] PML4[001]     ----A---WP
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  [008000000-00803ffff]  PDP[000]     ----A---WP
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    [008004000-0080043ff]  PDE[020-021] -GSDA---WP 0000000000-00000003ff
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    [008004400-008013fff]  PDE[022-09f] -GS-----WP 0000000400-000000ffff    
</code></pre></div><h2 id="問題解答">問題解答</h2>
<p><strong>1. 文件說明提到 JOS kernel 在執行時，是以 <code>0x8004000000</code> 位址開始執行，那這麼 address 是在哪裡設置的？又，processor 是如何知道該怎麼解析這個 virtual address？</strong></p>
<p><code>0x8004000000</code> 位址是在 JOS 的 linker script 中定義的，而在進入 kernel main function 之前，先配置好 page translation (PML4, PDPT, PDT, PT 等)並且 enable page translation 功能，就能讓 processor 解讀 virtual memory address。</p>
<p><strong>2. 我們可以使用的 physical memory 上限？</strong></p>
<p>根據 e820 memory map 資訊，可以得知 USABLE 的記憶體空間約為 256 MiB。</p>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/" title="CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)" target="_blank" rel="external">https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://yushuanhsieh.github.io/author.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">Cherie Hsieh</span><small class="ml-1x">Software Engineer</small></a></h3>
        <div>Gopher</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://yushuanhsieh.github.io/post/2020-09-04-vault-security/" title="Vault Initialization and Keys Security"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://yushuanhsieh.github.io/post/2020-11-14-gophercon_2020/"
                    title="GopherCon TW 2020 場務組心得"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://yushuanhsieh.github.io/cjamhe01385@gmail.com" target="_blank" title="email" data-toggle=tooltip data-placement=top >
            <i class="icon icon-email"></i></a></li>
    <li><a href="https://www.facebook.com/cjamhe01385" target="_blank" title="facebook" data-toggle=tooltip data-placement=top >
            <i class="icon icon-facebook"></i></a></li>
    <li><a href="https://yushuanhsieh.github.io/true" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2017  -
    2021
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="https://yushuanhsieh.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://yushuanhsieh.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/yushuanhsieh.github.io',
            CONTENT_URL: 'https:\/\/yushuanhsieh.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://yushuanhsieh.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
