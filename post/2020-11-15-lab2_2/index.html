<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        CSE 506 Lab2 - Memory Management and Virtual Memory Mapping - 文組工程師
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="閒聊 上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。" />
    
      <meta property="og:image" content="https://yushuanhsieh.github.io/posts/lab2_1.png" />
    
  <meta name="generator" content="Hugo 0.71.0 with theme pure" />
  <title>CSE 506 Lab2 - Memory Management and Virtual Memory Mapping - 文組工程師</title>
  
  
  <link rel="stylesheet" href="https://yushuanhsieh.github.io/css/style.min.77e7a4b079ffc2025082028f8e6fe3266891d5a844d08c55dc4edb39079aa481.css">
  
    
    <link rel="stylesheet" href="https://yushuanhsieh.github.io/scss/cherie.min.9d783e1aff5bd8d61fd74551461bf2a5c62c232caf17ddaef3c681e53b429d8e.css" async>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="CSE 506 Lab2 - Memory Management and Virtual Memory Mapping" />
<meta property="og:description" content="閒聊 上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/" />
<meta property="og:image" content="https://yushuanhsieh.github.io/posts/lab2_1.png" />
<meta property="article:published_time" content="2020-11-15T08:00:00+08:00" />
<meta property="article:modified_time" content="2020-11-15T08:00:00+08:00" />
<meta itemprop="name" content="CSE 506 Lab2 - Memory Management and Virtual Memory Mapping">
<meta itemprop="description" content="閒聊 上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。">
<meta itemprop="datePublished" content="2020-11-15T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-11-15T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="1215">
<meta itemprop="image" content="https://yushuanhsieh.github.io/posts/lab2_1.png">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://yushuanhsieh.github.io/posts/lab2_1.png"/>

<meta name="twitter:title" content="CSE 506 Lab2 - Memory Management and Virtual Memory Mapping"/>
<meta name="twitter:description" content="閒聊 上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="/" target="">
            <img class="img-circle img-rotate" src="https://yushuanhsieh.github.io/author.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Cherie Hsieh</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Taiwan</small>
        </div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/post/1900-01-01-about/">
                  <span class="menu-title">About</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                  <span class="menu-title">Categories</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/conference/" class="category-list-link">conference</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/coscup/" class="category-list-link">coscup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/devops/" class="category-list-link">devops</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/docker/" class="category-list-link">docker</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/game/" class="category-list-link">game</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/gnu/" class="category-list-link">gnu</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/go/" class="category-list-link">go</a><span class="category-list-count">16</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/google-cloud-platform/" class="category-list-link">google-cloud-platform</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/kubernetes/" class="category-list-link">kubernetes</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/life/" class="category-list-link">life</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/linux-kernel/" class="category-list-link">linux-kernel</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/meetup/" class="category-list-link">meetup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/network/" class="category-list-link">network</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/operating-system/" class="category-list-link">operating-system</a><span class="category-list-count">7</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">11</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/raspberry-pi/" class="category-list-link">raspberry-pi</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/security/" class="category-list-link">security</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/study/" class="category-list-link">study</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/web/" class="category-list-link">web</a><span class="category-list-count">30</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-06-19-pico-memory/" class="title">Boot Flow of Raspberry Pi Pico</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-06-30 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-06-30</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-06-23-c-extern/" class="title">C extern keyword</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-06-23 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-06-23</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-05-23-lab4-multiprocessor/" class="title">CSE 506 Lab 4 - Multiprocessor Support and Cooperative Multitasking</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-05-23 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-05-23</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-04-24-go-calling-convention/" class="title">Switch to a register-based calling convention for Go functions</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-24 01:00:00 &#43;0800 CST" itemprop="datePublished">2021-04-24</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2021-04-22-life/" class="title">近況雜談</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2021-04-22 08:00:00 &#43;0800 CST" itemprop="datePublished">2021-04-22</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="single-" class="article article-type-single" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/post/2020-11-15-lab2_2/"
    >
    
      
        
          <span class="title-cat">Operating System</span>
        
      
    CSE 506 Lab2 - Memory Management and Virtual Memory Mapping</a>
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/" class="article-date">
  <time datetime="2020-11-15 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-11-15</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>
  
    <a class="article-category-link" href="/categories/operating-system/"> Operating System </a>
</span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/post/2020-11-15-lab2_2/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h2 id="閒聊">閒聊</h2>
<p>上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。</p>
<p>這時間還遇上 Macbook 螢幕完全無法顯示的意外，經由朋友提醒，2016 年產的 13 吋 Macbook Pro 有螢幕背光災情，Apple 有提供免費召回維修的服務，因此花了一些時間送修。而 Apple 的服務也還不錯，整個螢幕換新，看來又可以撐好一陣子了 &lt;3</p>
<h2 id="lab-2">Lab 2</h2>
<p><a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/lab2.html">實驗說明文件</a></p>
<h2 id="part-1-physical-page-management">Part 1: Physical Page Management</h2>
<p>Part 1 是實作 physical memory allocator。在 <a href="https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/">CSE 506 Lab2 - E820 Memory Map &amp; Page Translation (1)</a> 可以看到系統在執行 kernel code 前，有先在 bootstrap 階段建立 page translation 所需的 pml4 table，以確保 kernel code 可以正確地被執行，不過在 kernel code 運行階段，我們需要建立新的 pml4 table ，來讓我們可以有更多控制權。</p>
<h3 id="boot_alloc">boot_alloc</h3>
<p>Page translation 機制最重要的就是先有 <code>pml4 table</code>，我們透過實作 <code>boot_alloc</code> 來分配 pml4 table 的記憶體空間。而在實作之前，第一個問題就是：alloc 的初始記憶體位置在哪裡？</p>
<p>而在 boot_alloc code 中可以看到：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#00f">if</span> (!nextfree) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#00f">extern</span> <span style="color:#2b91af">char</span> end[];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    nextfree = ROUNDUP((<span style="color:#2b91af">char</span> *) end, PGSIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>}
</code></pre></div><p><code>end</code> 這個 variable 是在其他地方定義，這也告訴我們只要取得 <code>end</code> address，就可以知道我們該從哪個記憶體位置開始執行 allocation。<code>end</code> variable 定義在 link script：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>.bss : {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>		*(EXCLUDE_FILE(vmm/guest/obj/kern/bootstrap.o) .bss)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>PROVIDE(end = .);
</code></pre></div><p>緊接在 .bss section 下方，這也意味著記憶體位置是在 .bss section 結束之後，以確保 kernel text 和 data 這些記憶體位置不會 overlap。</p>
<blockquote>
<p>The PROVIDE keyword may be used to define a symbol, such as <code>etext</code>, only if it is referenced but not defined. The syntax is PROVIDE(symbol = expression).</p>
</blockquote>
<p>有了這些資訊就可以來實作 boot_alloc function 。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#00f">static</span> <span style="color:#2b91af">void</span> *boot_alloc(uint32_t n)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#00f">static</span> <span style="color:#2b91af">char</span> *nextfree;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#2b91af">char</span> *result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#00f">if</span> (!nextfree) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        <span style="color:#00f">extern</span> <span style="color:#2b91af">char</span> end[];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        nextfree = ROUNDUP((<span style="color:#2b91af">char</span> *) end, PGSIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    result = nextfree;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#00f">if</span> (!n)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#00f">return</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    nextfree = ROUNDUP(nextfree + n, PGSIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#008000">// npages: the number of physical pages available
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#008000"></span>    <span style="color:#008000">// in both base and extended memory
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#008000"></span>    <span style="color:#00f">if</span> (npages * PGSIZE &lt; PADDR(nextfree))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        panic(<span style="color:#a31515">&#34;boot_alloc: out of memory</span><span style="color:#a31515">\n</span><span style="color:#a31515">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#00f">return</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>}
</code></pre></div><h3 id="page_init">page_init</h3>
<p>接著，我們透過 <code>struct PageInfo *pages</code> 來追蹤 page 的使用狀況，將 physical memory 切割成 PGSIZE 的陣列，並用 struct PageInfo 紀錄當前 reference 次數。同時，struct PageInfo 是 list 結構，所以也用於 free page list ，這樣可以讓我們快速地找到哪些 page 是可以使用的。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#00f">struct</span> PageInfo {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>	<span style="color:#00f">struct</span> PageInfo *pp_link;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>	uint16_t pp_ref;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>};
</code></pre></div><p>在使用 page_alloc 之前，先使用 page_init 來初始化 pageInfo list。而初始化最重要的事情就是<strong>標記已被使用的 page</strong>，例如 kernel code、I/O、BIOS 等。</p>
<p>根據題目，我們使用圖示來看目前用到的記憶體區塊：</p>
<p><img src="/posts/lab2_1.png" alt="memory area"></p>
<p>其中，已被佔用的記憶體包含：</p>
<ol>
<li>BIOS data (0x0 ~ 0x1000)</li>
<li>Bootstrap page table (0x7000 ~ 0xC000)
這是我們目前正在使用的 page table，所以要設為佔用。</li>
<li>I/O holes (0xA0000 ~ 0x100000)</li>
<li>bootstrap code and kernel code (0x100000 ~ end pointer)</li>
</ol>
<p>因此，我們要將對應的 page 標示已使用，並把可供使用的 page 加入到 free list 中。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#2b91af">void</span> page_init(<span style="color:#2b91af">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    size_t i;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#00f">struct</span> PageInfo* last = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    uint64_t io_page = IOPHYSMEM / PGSIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    uint64_t free_page = PADDR(boot_alloc(0)) / PGSIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    pages[0].pp_ref = 1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    pages[0].pp_link = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#00f">for</span> (i = 1; i &lt; npages; i++) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        uint64_t va;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#2b91af">bool</span> used = false;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        pages[i].pp_link = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#00f">if</span> (i &gt;= io_page &amp;&amp; i &lt; free_page)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            used = true;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        va = KERNBASE + i * PGSIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#00f">if</span> (va &gt;= BOOT_PAGE_TABLE_START &amp;&amp; va &lt; BOOT_PAGE_TABLE_END)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            used = true;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#00f">if</span> (used) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>            pages[i].pp_ref = 1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            <span style="color:#00f">continue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>        pages[i].pp_ref = 0;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        <span style="color:#00f">if</span>(last)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>            last-&gt;pp_link = &amp;pages[i];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        <span style="color:#00f">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>            page_free_list = &amp;pages[i];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        last = &amp;pages[i];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>}
</code></pre></div><p>由於不知道 bootstrap code 的結束位置，因此把從 I/O 到 kernel code end 這段區域都標示成已使用。</p>
<h3 id="page_alloc--page_free">page_alloc &amp; page_free</h3>
<p>而有了 page free list，要處理 page allocation 和 page free 都簡單很多，只要將 page 從 free list 中取出和放回即可。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#00f">struct</span> PageInfo *page_alloc(<span style="color:#2b91af">int</span> alloc_flags)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	<span style="color:#00f">if</span> (!page_free_list)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>		<span style="color:#00f">return</span> NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>	<span style="color:#00f">struct</span> PageInfo *page = page_free_list;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>	page_free_list = page-&gt;pp_link;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>	<span style="color:#00f">if</span> (alloc_flags &amp; ALLOC_ZERO)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>		memset(page2kva(page), <span style="color:#a31515">&#39;\0&#39;</span>, PGSIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>	page-&gt;pp_link = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>	<span style="color:#00f">return</span> page;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#2b91af">void</span> page_free(<span style="color:#00f">struct</span> PageInfo *pp)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>	<span style="color:#00f">if</span> (pp-&gt;pp_ref != 0 || pp-&gt;pp_link)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>		panic(<span style="color:#a31515">&#34;&#39;the page could not be freed&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>	pp-&gt;pp_link = page_free_list;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>	page_free_list = pp;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>}
</code></pre></div><h2 id="part-2-virtual-memory">Part 2: Virtual Memory</h2>
<p>有了初始的 pml4 table 後，接下來就是對照 <a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">AMD64 Architecture Programmer&rsquo;s Reference Manual</a> virtual address 與  physical addresses 轉換機制，建立起 pysical pages 與 virtual memory 之間的關係。</p>
<blockquote>
<p>在 x86_64 架構中，定義了四種形態的 address：</p>
<ol>
<li>Logical addresses</li>
<li>Effective addresses</li>
<li>Linear (virtual) addresses</li>
<li>Physical addresses</li>
</ol>
<p>其對應關係為：</p>
<p><img src="/posts/address_mapping.png" alt="memory area"></p>
<p>早先的 x86 架構多採用 segmentation translation 機制，不過由於 page translation 機制能更有助於系統軟體處理 process isolation 和 relocation 等議題，因此在當前的 x86_64 long mode 中，是以 <strong>flat</strong> 64-bit virtual-address(segmentation disabled) 實現 page translation。</p>
</blockquote>
<p>在 <code>bootstrap.S</code> file 中可以看到 GDT(Global descriptor table) 相關設定，其中透過將 code / data segment 的 base address 設為 0 來停用 segmentation。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>gdt_64:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    SEG_NULL
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#008000">// 0af9a - flag, 000000 - segment&#39;s base addr, ffff - limit
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#008000"></span>    .quad  0x00af9a000000ffff            <span style="">#</span>64 bit CS
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>    .quad  0x00cf92000000ffff            <span style="">#</span>64 bit DS
</code></pre></div><p>:::</p>
<p>首先，我們需要能查找各 level page table 的 function，以利我們能依據 virtual address 一層一層地找到對應的 page table entry，其中包含：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>pte_t * pml4e_walk(pml4e_t *pml4e, <span style="color:#00f">const</span> <span style="color:#2b91af">void</span> *va, <span style="color:#2b91af">int</span> create);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>pte_t * pdpe_walk(pdpe_t *pdpe,<span style="color:#00f">const</span> <span style="color:#2b91af">void</span> *va,<span style="color:#2b91af">int</span> create);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>pte_t * pgdir_walk(pde_t *pgdir, <span style="color:#00f">const</span> <span style="color:#2b91af">void</span> *va, <span style="color:#2b91af">int</span> create);
</code></pre></div><p>預期的查找行為：pml4e_walk (Level 4) -&gt; pdpe_walk (Level 3) -&gt; pgdir_walk (Level 2) -&gt; 回傳 page table enrty (Level 1)。</p>
<p>根據上述內容，實作一部分的 code：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>pte_t *pml4e_walk(pml4e_t *pml4e, <span style="color:#00f">const</span> <span style="color:#2b91af">void</span> *va, <span style="color:#2b91af">int</span> create)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	pdpe_t *pdpe;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	<span style="color:#00f">struct</span> PageInfo *page = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>	pml4e_t *current_pml4e = &amp;pml4e[PML4(va)];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#008000">// KADDR: a macro takes a physical address and returns the corresponding kernel virtual address.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#008000"></span>	pdpe = (pdpe_t *) KADDR(PTE_ADDR(*current_pml4e));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>	<span style="color:#00f">return</span> pdpe_walk(pdpe, va, create);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>}
</code></pre></div><p>此外，在查找 table entry 過程中，當我們發現此 entry 為 NULL 時，就要幫它分配新的 physical page，分配完後繼續查找下一層 table。如此一來，就會需要我們在 Part 1 所實作的 page_alloc 和 page_free。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>pte_t *pml4e_walk(pml4e_t *pml4e, <span style="color:#00f">const</span> <span style="color:#2b91af">void</span> *va, <span style="color:#2b91af">int</span> create)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	pdpe_t *pdpe;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	<span style="color:#00f">struct</span> PageInfo *page = NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>	pml4e_t *current_pml4e = &amp;pml4e[PML4(va)];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>	<span style="color:#00f">if</span>(create &amp;&amp; !*current_pml4e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>		page = page_alloc(ALLOC_ZERO);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>		<span style="color:#00f">if</span> (!page)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>			<span style="color:#00f">return</span> NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>		page-&gt;pp_ref++;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#008000">// permissions: PTE_P | PTE_W | PTE_U
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#008000"></span>		*current_pml4e = (pml4e_t) (page2pa(page) &amp; ~0xFFF) | PTE_P | PTE_W | PTE_U;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>	pdpe = (pdpe_t *) KADDR(PTE_ADDR(*current_pml4e));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>	pte_t *pte = pdpe_walk(pdpe, va, create);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>	<span style="color:#00f">if</span> (!pte &amp;&amp; page) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#008000">// decrease the ref count and free the page if ref count is 0.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#008000"></span>		page_decref(page);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#008000">// clear the entry
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#008000"></span>		*current_pml4e = 0x0;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>	<span style="color:#00f">return</span> pte;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>}
</code></pre></div><p><code>page = page_alloc(ALLOC_ZERO);</code>，取得目前可以使用的 physical PageInfo 之後，再透過 <code>page2pa</code> 找出 PageInfo 所對應的 physical memory address。</p>
<p>接著，我們根據 pml4 table enrty 來找到 Level 3 page directory pointer table。
<code>pdpe = (pdpe_t *) KADDR(PTE_ADDR(*current_pml4e));</code>，pml4 table entry 儲存的是 <strong>physical address | flags</strong>，因此我們需要使用 <code>PTE_ADDR</code> 來移除到 flags，<code>KADDR</code> 將 physical address 轉換成 virtual address。</p>
<blockquote>
<p>這邊要注意的地方是 physical address 與 virtual virtual address 的使用。由於我們將 pdpe 參數傳遞給下一個 function <code>pdpe_walk(pdpe, va, create);</code>，因此 pdpe (physical address) 需要再轉換成 virtual address 好讓 address 能在程式運行中時正確被解讀。</p>
</blockquote>
<p>實作好 pml4e_walk 之後，後續的 pdpe_walk、pgdir_walk 基本上大同小異，只要參照 <a href="https://i.imgur.com/sDBkI9T.png">virtual address translation 圖表</a> 正確地從 virtual address 取出 entry offset 即可。</p>
<h2 id="part-3-kernel-address-space">Part 3: Kernel Address Space</h2>
<p>最後，實作 <code>boot_map_region</code> 將指定的 virtual address 和 physical address 關聯起來。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#2b91af">void</span> boot_map_region(pml4e_t *pml4e, uintptr_t la, size_t size, physaddr_t pa, <span style="color:#2b91af">int</span> perm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>	pte_t *pte;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>	<span style="color:#00f">for</span>(<span style="color:#2b91af">int</span> i = 0; i &lt; size; i += PGSIZE) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>		pte = pml4e_walk(pml4e, (<span style="color:#2b91af">void</span> *)la + i, true);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>		<span style="color:#00f">if</span> (!pte)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>			panic(<span style="color:#a31515">&#34;failed to find the physical memory&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>		*pte = (pa + i) | perm | PTE_P;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>	}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>}
</code></pre></div><p>舉例來說，我們要將 pages 的 <strong>physical address</strong> 對應到 <code>UPAGES</code> virtual address 上，並且給予 user read-only 權限。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>boot_map_region(pml4e, UPAGES, page_size, PADDR(pages), PTE_U);
</code></pre></div><p>mapping 所有的 physical address 到指定的 virtual address，只允許 kernel 使用。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>boot_map_region(pml4e, KERNBASE, npages * PGSIZE, (physaddr_t)0x0, PTE_W);
</code></pre></div><p><code>PTE_U</code> 和 <code>PTE_W</code> 表示 permission，以用來區別 user 被允許讀寫的記憶體區域。當然還有其他 permission bit 表示，可以參閱 <a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">AMD64 Architecture Programmer&rsquo;s Reference Manual</a> 的 5.4.1 節。</p>
<h2 id="recap">Recap</h2>
<ol>
<li>x86_64 架構使用 4 層 page table 來實作 page translation，透過解析 virtual address 可以取得各層級 table 的 entry offset。</li>
<li>注意 physical address 和 virtual address 的使用時機，配置 page table 時是使用  physical address。</li>
<li>PageInfo 用來表示 physical memory page 的使用狀況，透過 PageInfo 可以取得對應的 physical address 並且再轉換到 virtual address，要清楚這之間的關係。</li>
<li>了解基本的 memory layout，包含 real-mode address space 和 extended memory。也可以參考 source code - <a href="https://github.com/YuShuanHsieh/CSE-506-jos/blob/lab2/inc/memlayout.h">memlayout.h</a></li>
</ol>
<h2 id="source-code">Source code</h2>
<p><a href="https://github.com/YuShuanHsieh/CSE-506-jos">YuShuanHsieh / CSE-506-jos</a></p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf">AMD64 Architecture Programmer&rsquo;s Reference Manual: chapter 5</a></li>
<li><a href="https://wiki.osdev.org/Global_Descriptor_Table">Global Descriptor Table</a></li>
<li><a href="https://wiki.osdev.org/Setting_Up_Paging">Enable Paging</a></li>
</ol>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/" title="CSE 506 Lab2 - Memory Management and Virtual Memory Mapping" target="_blank" rel="external">https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://yushuanhsieh.github.io/author.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">Cherie Hsieh</span><small class="ml-1x">Software Engineer</small></a></h3>
        <div>Gopher</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://yushuanhsieh.github.io/post/2020-11-14-gophercon_2020/" title="GopherCon TW 2020 場務組心得"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://yushuanhsieh.github.io/post/2020-11-25-lab3_1/"
                    title="CSE 506 Lab 3 - User Environments(Processes)"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://yushuanhsieh.github.io/cjamhe01385@gmail.com" target="_blank" title="email" data-toggle=tooltip data-placement=top >
            <i class="icon icon-email"></i></a></li>
    <li><a href="https://www.facebook.com/cjamhe01385" target="_blank" title="facebook" data-toggle=tooltip data-placement=top >
            <i class="icon icon-facebook"></i></a></li>
    <li><a href="https://yushuanhsieh.github.io/true" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2017  -
    2021
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="https://yushuanhsieh.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://yushuanhsieh.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/yushuanhsieh.github.io',
            CONTENT_URL: 'https:\/\/yushuanhsieh.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://yushuanhsieh.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
