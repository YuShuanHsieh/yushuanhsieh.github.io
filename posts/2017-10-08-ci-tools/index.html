<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>新手入門 - Gitlab Continuous Integration & Deployment — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>新手入門 - Gitlab Continuous Integration & Deployment</h1><div class=post-meta><time datetime=2017-10-08>October 8, 2017</time>
<span class=separator>·</span>
<span class=reading-time>11 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/other/>Other</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>之前雖然有聽聞過CI(Continuous Integration)相關工具，但是一直沒有好好認真地研究，畢竟都是一個人寫，總認為自己也不太需要用到CI。直到最近開始上班了，看到了公司如何使用CI來進行build package流程，頓時覺得這工具實在很便利～而因為公司也早已經有完整架構，因此雖然看得到介面，卻還是不太清楚實際上到底是如何運作的，所以就趁雙十連假期間，決定自己來實際嘗試一下整個CI運作流程。</p><h2 id=涉及內容>涉及內容</h2><ol><li>Gitlab CI</li><li>Docker</li></ol><h2 id=gitlab底下的ci流程>Gitlab底下的CI流程</h2><p><img src=https://docs.gitlab.com/ee/ci/img/cicd_pipeline_infograph.png alt="Gitlab process"></p><p style=font-size:small>(Image reference: https://docs.gitlab.com/ee/ci/)</p><blockquote><p>GitLab offers a continuous integration service. If you add a <strong>.gitlab-ci.yml file</strong> to the root directory of your repository, and configure your GitLab project to use a <strong>Runner</strong>, then each commit or push, triggers your <strong>CI pipeline</strong>.</p></blockquote><p>Gitlab的流程其實蠻容易懂：<br><strong>(1)</strong> 每次用戶更新程式碼(commit or push)的時候，<br><strong>(2)</strong> Gitlab就會自動觸發用戶在.gitlab-ci.yml所設定好的工作流程，<br><strong>(3)</strong> 並且在指定的Runner上搭建虛擬測試環境並且執行這些工作。<br>這整個流程中我覺得最重要的是如何寫好.gitlab-ci.yml這份文件，畢竟所謂的自動化測試和自動化package，其實都是依賴這份文件的流程在運作啊！由於現在IDE很方便，所以很多指令都只需要操作UI即可完成，所以該如何將這些指令寫出來，並且能在command-line模式中執行，是使用CI工具中最具挑戰的環節，這樣也能了解為什麼公司在徵求CI工程師時，具備Linux shell相關經驗是最基本條件了。</p><h2 id=設定gitlab-ci>設定Gitlab CI</h2><h3 id=1建立project>1.建立Project</h3><p>在 Gitlab 中建一個Project，然後上傳code (廢話)</p><h3 id=2設定runner-選填>2.設定Runner (選填)</h3><p>Runner顧名思義就是會執行.gitlab-ci.yml文件內指令的環境了。雖然在Gitlab流程中會指引用戶註冊一個Runner，不過如果只是用來一般測試，又沒有多餘的機器來當Runner，其實可以使用 Gitlab 所提供的 <strong>Shared Runner</strong> 就好。<br>不過，什麼時候會需要用到自己設定的Runner呢？根據官方的建議，像是當工作流程中需要一些特別認證時，就需要自己設定好一台Runner來執行。或是code可能需要連結很多外部library，如果使用標準 Shared Runner ，每次測試前就需要花點時間配置環境，那倒不如直接在local先預裝好這些library。</p><blockquote><p>Specific Runners are useful for jobs that have <strong>special requirements or for projects with a specific demand.</strong> If a job has certain requirements, you can set up the specific Runner with this in mind, while not having to do this for all Runners. For example, if you want to <strong>deploy a certain project</strong>, you can setup a specific Runner to have the right credentials for this. The usage of tags may be useful in this case. Specific Runners process jobs using a FIFO queue.</p></blockquote><h4 id=-shared-runners->[ Shared Runners ]</h4><p>當建立好Project，就會自動有六組Shared Runner可以使用。可以在Project介面底下的 <strong>[Settings]</strong> -> <strong>[CI/CD]</strong> -> <strong>[Runners settings]</strong> 找到它們。
![GitLab - SharedRunner]({{ site.url }}/assets/images/GitLab-CI-Shared-Runner.png)<br>在Runner底下會看到一排Tag，這個是代表Runner中預設的功能，在 .gitlab-ci.yml 中設定想要的Runner Tag，這樣在執行工作時就會由這台Runner執行，讓專案可以有適當的環境。</p><h4 id=-specific-runners->[ Specific Runners ]</h4><p>如果想要設定一台Specific Runners，讓每次工作都可以在這台Runner上執行，那就必須要經過幾個設定和安裝步驟才可以。</p><ol><li><p>安裝GitLab Runner<br><a href=http://docs.gitlab.com/runner/install/>GitLab - Install GitLab Runner</a><br>首先要先安裝 GitLab Runner ，這樣 GitLab CI 才可以發送工作任務和將結果傳回到 GitLab 。安裝方式可以直接看官網安裝方式，這個安裝步驟相對簡單，途中的一些設定也可以事後改，所以不用擔心。另外，GitLab Runner也有搭配的指令可以使用，在進行一些進階設定時會用到，在安裝時也可以搭配參考一下。<br><a href=https://docs.gitlab.com/runner/commands/README.html>GitLab - GitLab Runner Commands</a><br>![GitLab - SharedRunner]({{ site.url }}/assets/images/GitLab-CI-Runner.png)<br>安裝和註冊好之後，就可以在 <strong>[Runners settings]</strong> 中看到你所設定的Runner了！</p></li><li><p>安裝Executors<br>接著， GitLab Runner 會透過 Executors 來執行工作。Executors簡單來說就是虛擬執行環境，像是大家很常聽到的 VirtualBox ，或是這幾年來很熱門的 Docker。而在安裝 GitLab Runner 的時候，會發現是預設 Docker 的，既然如此，那就毫不猶豫地選擇 Docker 了！（對這個實在不是很熟Orz）<br><a href=https://philipzheng.gitbooks.io/docker_practice/content/>Docker —— 從入門到實踐</a> - 想直接進行實作，可以參考這個內容<br><a href=https://docs.docker.com/engine/reference/commandline/cli/>Use the Docker command line</a> - Docker官方的command介紹，如果上面有看不懂的指令，可以在這邊找答案</p></li><li><p>在 Docker 中建立專案所需的image<br>安裝好 Docker ，再來就是使用 Docker 來建立所需要的虛擬環境。因為這打起來又會太長一篇，所以就先簡單帶過。實際實作辦法可以參考上面連結中的 <strong>使用鏡像</strong> 和 <strong>啟動容器</strong> 章節。舉例來說，因為我的專案是用c++寫成的，所以我就先 pull Docker 官方提供的標準 gcc 環境 image，然後根據這個 image 來啟動 container ，並且在這個 container 中下載安裝我需要的 library ，最後使用 commit 來建立出新的 image。</p></li><li><p>修改 <strong>config.toml</strong><br>再來，最重要的是該如何讓 Gitlab Runner 來讀取local端的 image 建立出正確的虛擬環境。因為 Gitlab Runner 在執行時，是預設所有的 image 都由 Docker 中 pull 下來的，這樣就代表即使本機端已經有設定好 image ，Gitlab Runner 在執行時還是會出現沒有該 image 檔的錯誤，因此要調整一下 config 內容，多加個一行就好，這樣就可以讀取本機端的 image。<br>![GitLab - Config]({{ site.url }}/assets/images/GitLab-CI-Config.png)<br><a href=https://docs.gitlab.com/ce/ci/docker/using_docker_images.html>GitLab - Using Docker images</a> - 詳細修改方式可以參考這篇說明</p></li></ol><blockquote><p>By default, the executor will only pull images from Docker Hub, but this can be configured in the gitlab-runner/config.toml by setting the Docker pull policy to allow using local images.</p></blockquote><h3 id=撰寫gitlab-ciyml文件>撰寫.gitlab-ci.yml文件</h3><p>最後，就是在本機端 Project 根目錄中，新建 .gitlab-ci.yml 檔案，然後 push 上 Gitlab！簡單範例如下：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#57606a># Use local docker image</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#0550ae>image</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gamecontainer:latest<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#0550ae>test</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>stage</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>test<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a># The sample command of building the program.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>script</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- cd CI/<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- cmake CMakeLists.txt<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- make<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- ./bin/UnitTest<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a># The build will only run when develop branch updates.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>only</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- develop<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a># Target runner.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>tags</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- mac<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>簡單來說，當 Gitlab Runner 收到工作任務之後，會先根據你指定的 image 來配置虛擬執行環境，然後將你在 GitLab 中的專案 clone 下來，接著執行在 script 中所寫入的流程。像是範例中，當專案下載好之後，會執行CMakeLists.txt和make來compile C++。
<a href=https://docs.gitlab.com/ee/ci/yaml/>GitLab - Configuration of your jobs with .gitlab-ci.yml</a> - 關於更多 .gitlab-ci.yml 規範可以參考這篇文章。</p><h3 id=結果圖>結果圖</h3><p>執行列表
![GitLab - Config]({{ site.url }}/assets/images/GitLab-CI-Pipeline.png)</p><p>詳細執行內容（以 Google unit test 為例）
![GitLab - Config]({{ site.url }}/assets/images/GitLab-CI-Pipeline-Result.png)</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2017-09-15-cocos-action-manager/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Discussing the Action Manager in Cocos2d-x</span>
</a><a href=https://yushuanhsieh.github.io/posts/2017-12-08-two-way-binding/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>AngularJS - Two way data binding</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>