<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Node.js Addons N-API example (v10.11.0) — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Node.js Addons N-API example (v10.11.0)</h1><div class=post-meta><time datetime=2018-09-24>September 24, 2018</time>
<span class=separator>·</span>
<span class=reading-time>9 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>由於專案需要整合 <a href=https://nodered.org/>Node-RED</a> ，我們必須開發自己的 Node 來讓用戶可以直接透過視覺化方式來建立簡單邏輯，又我們的 SDK 是 C 版本，因此有這機會可以接觸 Node.js 所提供的 C/C++ Addons 功能。另外，自己寫 server-side 都是使用 Golang，所以這也是難得的機會可以試試 Node.js。</p><p>目前網路上使用 Node.js <code>N-API v10.x</code> 版本的範例並不多，初期在使用時也因為對於原理不熟悉，因而踩過一些坑，希望這篇文章能講述基本概念，讓其他使用者能避免也踩到相同的坑。</p><h2 id=相關技術>相關技術</h2><ul><li>C</li><li>Node.js N-API 與v8一些原理知識</li><li>JavaScript</li></ul><h2 id=how-cc-addons-work-with-javascript>How C/C++ Addons Work With JavaScript</h2><blockquote><p><strong>C/C++ Addons</strong> Node.js Addons are dynamically-linked shared objects, written in C++, that can be loaded into Node.js using the require() function, and used just as if they were an ordinary Node.js module.</p></blockquote><p>簡單來說， C/C++ 編寫的Addons 能夠像 Node.js module 一樣被引入使用，如此一來，就可以使用 C/C++ 來處理邏輯。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#57606a>// Your addons module
</span></span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>example</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;../lib/build/Release/example.node&#39;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// use the function of Your addons module
</span></span></span><span style=display:flex><span><span style=color:#1f2328>example</span><span style=color:#1f2328>.</span><span style=color:#1f2328>success</span><span style=color:#1f2328>();</span>
</span></span></code></pre></td></tr></table></div></div><p>不過， 由 C/C++ 所寫成的 Addons 到底是如何和 JavaScript 協作的呢？</p><p>首先要提及 Google 的 opensource <strong>V8 JavaScript engine</strong>，V8 負責編譯 JavaScript Code 成機器碼，同時也提供 runtime 環境，而 Node.js 就是建立在 V8 Engine 的基礎之上。</p><p>當我們撰寫 JavaScript Code 來建立一個 object 時，則 V8 runtime 中就會分配一個記憶區塊來放置它。而我們在用 C/C++ 編寫 Addons 時，需要存取這個由 JavaScript 所產生的 objects，此時必須利用特殊方式來取得其 reference，這個特殊方式就是透過 <strong>N-API</strong> 來進行轉換。（為什麼需要透過 N-API 呢？回想一下， JavaScript 所定義的 Type 和 C/C++ Type 有很大差異，藉由 API 協助，才可以取得正確的值）。</p><h2 id=what-is-n-api>What is N-API?</h2><blockquote><p>N-API is an API for building native Addons. It is independent from the underlying JavaScript runtime (ex V8) and is maintained as part of Node.js itself. The set of APIs that are used by the native code. Instead of using the V8 or Native Abstractions for Node.js APIs, the functions available in the N-API are used.</p></blockquote><blockquote><p>APIs exposed by N-API are generally used to create and manipulate JavaScript values.</p></blockquote><p>N-API 主要功能是輔助 Addons 來對 JavaScript 所產生的值進行使用或操作。如果在網路上搜尋 Addons 教學，可能會看到很多透過 <code>include &lt;v8.h></code> 來實作的文章，不過 Node.js 另外開發了 N-API，它是之前使用 v8 API 撰寫 addons 的新方式，往後使用 N-API，就不再需要引入 v8 lib。</p><h2 id=create-a-cc-addons>Create a C/C++ addons</h2><h3 id=1-register-a-module-and-methods>1. Register a Module and methods</h3><p>前面簡單地概述觀念，現在就直接來實作一個 addons。首先寫個 <code>hello.c</code> 來註冊 methods 和 module。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>#define NAPI_EXPERIMENTAL
</span></span></span><span style=display:flex><span><span style=color:#57606a>// #define NAPI_EXPERIMENTAL (optional) 目前 N-API 有一些實驗性質的 function，透過 define NAPI_EXPERIMENTAL 來使用這些 methods
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;node_api.h&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>napi_value <span style=color:#6639ba>hello_word</span> <span style=color:#1f2328>(</span>napi_env env<span style=color:#1f2328>,</span> napi_callback_info info<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 邏輯實作，先暫時略過
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>napi_value <span style=color:#6639ba>Init</span> <span style=color:#1f2328>(</span>napi_env env<span style=color:#1f2328>,</span> napi_value exports<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 將實作的 method 註冊成 property，如果沒有此定義，則無法在 JavaScript code 中使用。
</span></span></span><span style=display:flex><span>    napi_property_descriptor desc <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span> <span style=color:#0a3069>&#34;helloWorld&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> hello_word<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> napi_default<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>    napi_status status <span style=color:#0550ae>=</span> <span style=color:#6639ba>napi_define_properties</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> exports<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>desc<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>status <span style=color:#0550ae>!=</span> napi_ok<span style=color:#1f2328>)</span> <span style=color:#cf222e>return</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> exports<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 註冊 module
</span></span></span><span style=display:flex><span><span style=color:#6639ba>NAPI_MODULE</span><span style=color:#1f2328>(</span>NODE_GYP_MODULE_NAME<span style=color:#1f2328>,</span> Init<span style=color:#1f2328>);</span> 
</span></span></code></pre></td></tr></table></div></div><p>在使用我們寫好的 addons 前，我們必須<strong>註冊此 module 與其 property</strong>，如此一來在程式執行時，才能根據註冊內容來取得正確的 mothods。
這邊會看到 <code>NODE_GYP_MODULE_NAME</code> ，這是指在 <code>binding.gyp</code> 定義好的名稱，下面會介紹， 至於在實務上，一律用 <code>NODE_GYP_MODULE_NAME</code> 這串文字即可。</p><h3 id=2-write-a-bindinggyp-file>2. Write a <code>binding.gyp</code> file</h3><p>寫好的 addons 必須再 compile 成 Node.js module，才能供 Node.js 引入。這流程是使用 <code>node-gyp</code> 這個內建工具，因此我們必須撰寫對應的 <code>.gyp</code> file，來讓 <code>node-gyp</code> 正確地 compile 成我們想要的 node。(實際上，node-gyp 是基於 <a href=https://gyp.gsrc.io/>GYP</a> 的延伸工具，如果想要了解更多 <code>.gyp file</code> 的撰寫方式，可以參考 <a href=https://gyp.gsrc.io/docs/LanguageSpecification.md>GYP LanguageSpecification</a>)</p><blockquote><p><code>node-gyp</code> is a cross-platform command-line tool written in Node.js for compiling native addon modules for Node.js.</p></blockquote><p>一個基本的 <code>.gyp</code> 包含以下內容：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;targets&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;target_name&#34;: &#34;hello&#34;,
</span></span><span style=display:flex><span>      &#34;sources&#34;: [ &#34;src/hello.c&#34; ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>其中 <code>target_name</code> 會成為 addons module name，而 <code>sources</code> 就是需要被 compile 的來源啦。</p><h3 id=3-work-with-javascript>3. Work with JavaScript</h3><p>處理好 module 部分之後，接下來我們來實作 Addons methods。要將 C/C++ 所寫成的 methods 透過 N-API expose 給 JavaScript 使用，必須使用 N-API 已定義好的 callback type <code>napi_callback</code>。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>typedef</span> <span style=color:#6639ba>napi_value</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>*</span>napi_callback<span style=color:#1f2328>)(</span>napi_env<span style=color:#1f2328>,</span> napi_callback_info<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>現在就來實作 hello.c</p><p>舉例來說， helloWorld methods 可以傳入兩個 string 參數，然後返回一個 1 值，在 JavaScript Code 中可以這樣使用。</p><ul><li>JavaScript code</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>addon</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;../lib/build/Release/hello.node&#39;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>addon</span><span style=color:#1f2328>.</span><span style=color:#1f2328>helloWorld</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;hello&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;world&#34;</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>c code</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// napi_callback_info 代表所有傳入的參數內容
</span></span></span><span style=display:flex><span>napi_value <span style=color:#6639ba>hello_word</span> <span style=color:#1f2328>(</span>napi_env env<span style=color:#1f2328>,</span> napi_callback_info info<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 總共有兩個參數 
</span></span></span><span style=display:flex><span>  <span style=color:#cf222e>size_t</span> argc <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 從 JavaScript 傳入的參數皆為 napi_value，所以定義一個 napi_value 的 array
</span></span></span><span style=display:flex><span>  napi_value args<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 透過 N-API method 來獲得參數內容
</span></span></span><span style=display:flex><span>  <span style=color:#6639ba>napi_get_cb_info</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> info<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>argc<span style=color:#1f2328>,</span> args<span style=color:#1f2328>,</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>,</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 不過 napi_value 無法直接被 c/c++ code 使用，所以要再使用 N-API，來獲得實際的值
</span></span></span><span style=display:flex><span>  <span style=color:#cf222e>char</span> str1<span style=color:#1f2328>[</span><span style=color:#0550ae>100</span><span style=color:#1f2328>],</span> str2<span style=color:#1f2328>[</span><span style=color:#0550ae>100</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>size_t</span> str_size<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#6639ba>napi_get_value_string_utf8</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> args<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>],</span> str1<span style=color:#1f2328>,</span> NAPI_AUTO_LENGTH<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>str_size<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>  <span style=color:#6639ba>napi_get_value_string_utf8</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> args<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>],</span> str2<span style=color:#1f2328>,</span> NAPI_AUTO_LENGTH<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>str_size<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#6639ba>printf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;%s, %s </span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span> str1<span style=color:#1f2328>,</span> str2<span style=color:#1f2328>);</span> <span style=color:#57606a>// output: Hello, world
</span></span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 反之，如果想要回傳值到 JavaScript code，必須也使用 N-API 來進行轉換
</span></span></span><span style=display:flex><span>  napi_value result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>int</span> number <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#6639ba>napi_create_int32</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> number<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>result<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由於每個 N-API methods 會引入多個參數，實際要引入的參數內容，建議可以參考 <a href=https://nodejs.org/api/n-api.html>N-API Document</a>，以便根據自己的程式來進行調整。</p><h3 id=4-build-a-nodejs-module>4. Build a Node.js module</h3><p>最後，讓 <code>node-gyp</code> 來執行 build 的工作，就算大功告成了。透過 <code>npm install node-gyp</code>，並且執行</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>node-gyp rebuild
</span></span></code></pre></td></tr></table></div></div><p>這樣就可以產生一個由 C/C++ 編寫的 Addons Node.js Module。目前介紹只是基本用法，接下來還會介紹 <code>thread safe function</code> 方式，讓 addons 可以應用在更廣的地方。</p><h2 id=reference>Reference</h2><ol><li><a href=https://nodeaddons.com/how-not-to-access-node-js-from-c-worker-threads/>https://nodeaddons.com/how-not-to-access-node-js-from-c-worker-threads/</a></li><li><a href=https://nodejs.org/api/n-api.html>https://nodejs.org/api/n-api.html</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2018-09-09-go-tar-file/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Go - Archive files with archive/tar lib</span>
</a><a href=https://yushuanhsieh.github.io/posts/2018-10-05-study-9/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>9月份自我學習日誌回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>