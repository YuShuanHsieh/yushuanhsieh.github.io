<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>工作 - Redux State 被異常更新除錯紀錄 — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>工作 - Redux State 被異常更新除錯紀錄</h1><div class=post-meta><time datetime=2019-01-23>January 23, 2019</time>
<span class=separator>·</span>
<span class=reading-time>6 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=問題>問題：</h2><p>今天收到 back-end 同事回饋，說是在新版本的 APP UI 中出現不正常行為。由於我們的 menu 必須根據 Embedded System 中的 Applcation 來增減，因此就使用 menu state 來讓其他 component 也可以透過 dispatch 控制 menu 項目。</p><p>menu state 中有一個 property 是用來記錄 menu 的縮放，結果現在這個縮放行為會在使用者按 menu item 時出現異常，property value 會回到原始狀態 (initial state)。</p><h2 id=找出原因>找出原因：</h2><p>當同事回報這個問題時，第一個想到的就是在 menu state 被 re-create，才會引發 re-render 行為，進而讓 menu 回到沒有縮放的初始狀態。</p><h3 id=那是什麼原因導致-state-被-re-create>那是什麼原因導致 state 被 re-create？</h3><p>前面有提到 menu 必須根據 Application 目前數量來做增減，而我們的 store 中就有存放 Applcations state，並且 subscribe 這個 Applcations state 來變動 menu items。所以說，如果 menu component 被 re-render，十之八九是因為 applications state 被更新。</p><p>接下來就很平常的開啟 redux dev tool 來驗證是不是哪段 code 邏輯有問題，導致在不正確的時間點更新到了 Application State。</p><h3 id=奇怪沒有任何跟-application-state-相關的-action-被-dispatch>奇怪，沒有任何跟 Application State 相關的 Action 被 Dispatch</h3><p>很有趣的是，從 tool 中沒有看到任何 action 觸發 application state 的更新，這讓我本來預想的結果完全不同，因為 store 的 state 照理說只會透過 dispatch action 來更新，如果不是，那問題就有點嚴重了，等於 state 會在意外之處被更動。</p><h3 id=既然沒有方向那就從-action-的流程開始找起吧>既然沒有方向，那就從 action 的流程開始找起吧！</h3><p>一時之間實在看不出來我的 code 是哪裡有問題，與其瞎猜或是 try and error，倒不如從 redux dev tool 找端倪。首先在看 action dispatch 時，發現：</p><p>(1) 在 dispatch <code>@ngrx/store-router/update-reducer</code> 這個 action 後，就會觸發 menu re-create 的行為。</p><p>(2) 當 Angular module 為 lazy-load 模式時， re-create 行為才會觸發。</p><p>從這兩點看起來，有可能是使用的 libs 有邏輯改變，不過還是不知道問題出在哪裡。於是：</p><p>(1) 先從相關 @ngrx/store 的 issues 板上看，看是不是其他使用者有類似的問題。</p><p>(2) 由於是從更新 libs 後才出現這樣的行為異常，所以看一下更新版本的 commit 到底是更新什麼內容。</p><h3 id=找到確切問題點>找到確切問題點</h3><p>就在這樣找尋當中，發現其中一個 libs 的 commit 竟然跟 <code>@ngrx/store-router/update-reducer</code> 有關，它擷取了這個 action 對 state 進行 deep copy 。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>((</span><span style=color:#1f2328>action</span><span style=color:#1f2328>.</span><span style=color:#1f2328>type</span> <span style=color:#0550ae>===</span> <span style=color:#1f2328>INIT_ACTION</span> <span style=color:#0550ae>||</span> <span style=color:#1f2328>action</span><span style=color:#1f2328>.</span><span style=color:#1f2328>type</span> <span style=color:#0550ae>===</span> <span style=color:#1f2328>UPDATE_ACTION</span><span style=color:#1f2328>)</span> 
</span></span><span style=display:flex><span>  <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#1f2328>rehydratedState</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>      <span style=color:#1f2328>nextState</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>merge</span><span style=color:#1f2328>({},</span> <span style=color:#1f2328>nextState</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>rehydratedState</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></td></tr></table></div></div><p>這個發現可真是不得了，因為一但更新 state object，所有相關的 components 都會 re-render。而這些 render 行為其實是沒必要的，因為 state value 根本沒有變化，只是因為 deep copy 行為，導致 reference 被更新。（重點是這些資訊完全不會顯示在 redux dev tool上，所以不會發現各 state 被默默更新了）</p><p>接著查看一下前面版本的 code，之前 code 是用 <code>Object.assign</code> 是屬於 shadow copy，跟 <code>lodash.merge</code> deep copy 是完全不一樣的。這也難怪之前不會出問題，而在 libs 換了新版本後就會出現異常。</p><h2 id=解決辦法>解決辦法</h2><p>找到這個問題後，有幾個解決辦法：</p><ol><li>首先發個 issue 給作者，看他要不要解決</li><li>降到可運行的版本。（當然我相信它改成 merge 一定是因為有 propery assign 的問題，不過之前版本我們並沒有出錯，在找到替代方式之前，先沿用舊版本）</li><li>Update 版本要更加嚴謹。由於 front-end 的 libs 更新速度相當快，所以一個不小心就很有可能會發生升版後的異常狀況，這部分可能需要想個比較好的流程或是 Test，才能避免沒有在一開始時就發現升版問題。</li></ol><p>由於這個問題是發生在第三方 lib 上，所以紀錄以下除錯流程。我覺得自己 code 邏輯還容易找，但是出在這種第三方 lib ，要找問題就會比較困難一些。</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-01-17-react-and-redux/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>使用 React-Redux 注意事項和運作原理</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-02-03-study-2019-01/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>2019/01月份自我學習回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>