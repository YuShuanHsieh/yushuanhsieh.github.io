<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>React Hooks with memoizedState — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>React Hooks with memoizedState</h1><div class=post-meta><time datetime=2019-02-27>February 27, 2019</time>
<span class=separator>·</span>
<span class=reading-time>7 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>React Hooks 自從正式 release 後，就出現很多相關教學文章，所以這篇不是講如何實作，而是說他如何在 stateless functional component 中保存當前 state。 此外，最近也開始嘗試把 class component 轉換成使用 hooks 的 components，但過程中還是需要蠻多調整，包含之前有使用一些 lifecycle functions ，藉此機會順便檢視是否真的必要使用這些 functions，是否可以透過其他架構方式來簡化。</p><h2 id=usestate>useState</h2><p>以下是我們使用 useState function 的基本範例：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>function</span> <span style=color:#1f2328>Example</span><span style=color:#1f2328>(</span><span style=color:#1f2328>props</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>[</span><span style=color:#1f2328>state</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>setState</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>useState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>initialState</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>/// ReactElement
</span></span></span><span style=display:flex><span>  <span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>依照 functional component 邏輯，我們應該每次都會新建一個 state，導致 state 值無法保存。不過透過 React Hooks，我們卻可以在每次 render 時得到上次更新後的 state 值，這是為什麼呢？</p><p>trace code 後，可以發現這個 function 其實是呼叫 internal dispatcher 的 useState</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>export</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>useState</span><span style=color:#0550ae>&lt;</span><span style=color:#1f2328>S</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span><span style=color:#1f2328>initialState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>S</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>|</span> <span style=color:#1f2328>S</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>const</span> <span style=color:#1f2328>dispatcher</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>resolveDispatcher</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#1f2328>dispatcher</span><span style=color:#1f2328>.</span><span style=color:#1f2328>useState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>initialState</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而 <code>dispatcher</code> 是什麼呢？其實可以把它想成每個 component 內部的 mount or update 調度器，這個 dispatcher 會在 component render 階段 <code>renderWithHooks</code> 被 assign。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>export</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>renderWithHooks</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span><span style=color:#57606a>/// 略過
</span></span></span><span style=display:flex><span><span style=color:#1f2328>ReactCurrentDispatcher</span><span style=color:#1f2328>.</span><span style=color:#1f2328>current</span> <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>nextCurrentHook</span> <span style=color:#0550ae>===</span> <span style=color:#cf222e>null</span> <span style=color:#0550ae>?</span> <span style=color:#1f2328>HooksDispatcherOnMount</span> <span style=color:#0550ae>:</span> <span style=color:#1f2328>HooksDispatcherOnUpdate</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>HooksDispatcherOnMount</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Dispatcher</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>//略過
</span></span></span><span style=display:flex><span>  <span style=color:#1f2328>useState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>mountState</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>HooksDispatcherOnUpdate</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Dispatcher</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>//略過
</span></span></span><span style=display:flex><span>  <span style=color:#1f2328>useState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>updateState</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>從上述 code 可以知道，<strong>HooksDispatcher 又分成 mount 和 update</strong>，當 hook 還未建立，會套用 mount ，反之則會使用 update methods。藉由這種方式，可以根據目前 render 的階段，讓 useState 實際上是執行不同的實作 function。</p><h2 id=memoizedstate>memoizedState</h2><p>接續以上 source code，我們先來看 mountState，在 mountState function 中會建立一個新的 Hook object:</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>function</span> <span style=color:#1f2328>mountWorkInProgressHook</span><span style=color:#1f2328>()</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Hook</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>const</span> <span style=color:#1f2328>hook</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Hook</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>memoizedState</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>baseState</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>queue</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>baseUpdate</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>next</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>workInProgressHook</span> <span style=color:#0550ae>===</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// This is the first hook in the list
</span></span></span><span style=display:flex><span>    <span style=color:#1f2328>firstWorkInProgressHook</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>workInProgressHook</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>hook</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Append to the end of the list
</span></span></span><span style=display:flex><span>    <span style=color:#1f2328>workInProgressHook</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>workInProgressHook</span><span style=color:#1f2328>.</span><span style=color:#1f2328>next</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>hook</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#1f2328>workInProgressHook</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>function</span> <span style=color:#1f2328>mountState</span><span style=color:#0550ae>&lt;</span><span style=color:#1f2328>S</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>initialState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>S</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>|</span> <span style=color:#1f2328>S</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>[</span><span style=color:#1f2328>S</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>Dispatch</span><span style=color:#0550ae>&lt;</span><span style=color:#1f2328>BasicStateAction</span><span style=color:#0550ae>&lt;</span><span style=color:#1f2328>S</span><span style=color:#0550ae>&gt;&gt;</span><span style=color:#1f2328>]{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 略
</span></span></span><span style=display:flex><span>  <span style=color:#cf222e>const</span> <span style=color:#1f2328>hook</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>mountWorkInProgressHook</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>hook</span><span style=color:#1f2328>.</span><span style=color:#1f2328>memoizedState</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>hook</span><span style=color:#1f2328>.</span><span style=color:#1f2328>baseState</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>initialState</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#1f2328>[</span><span style=color:#1f2328>hook</span><span style=color:#1f2328>.</span><span style=color:#1f2328>memoizedState</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>dispatch</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>queue</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>hook</span><span style=color:#1f2328>.</span><span style=color:#1f2328>queue</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>last</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>dispatch</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>eagerReducer</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>reducer</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>eagerState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>initialState</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>any</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>});</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到 initialState 會被 assign 給 <code>hook.memoizedState</code>。而從 <code>workInProgressHook.next = hook</code> 可以知道， hook 是一個 linked list 結構，紀錄了該 hook 的 state 值並有 pointer 指向下一個 hook。</p><p>而這個 hook linked list 又會被記錄在 fiber 的 memoizedState。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>renderedWork</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Fiber</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>currentlyRenderingFiber</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>any</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>renderedWork</span><span style=color:#1f2328>.</span><span style=color:#1f2328>memoizedState</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>firstWorkInProgressHook</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Hooks are stored as a linked list on the fiber&rsquo;s memoizedState field.</p></blockquote><p>這樣看下來就清楚了，原來在 stateless functional component 中使用 useState ，之所以能夠紀錄下當前 state 值，是因為這些 state 被組成一串 hook linked list 並保存在 fiber 欄位。</p><p>![React-Hooks]({{ site.url }}/assets/images/React-hooks.png)</p><p>當第一次 render 執行 <code>useState</code> 時，會執行 <code>mountState</code> 並把 user 設定的 initial State 放到 hook 中的 memoizedState。</p><p>而後續再次執行 render 或是 update state 時，就會<strong>直接從 fiber memoizedState (hook ) 中取出保存的 memoizedState</strong> (怎麼有點繞口令)。</p><h2 id=rules-of-hooks>Rules of Hooks</h2><p>知道了上面的流程後，再來看一下官方聲明的 Hooks 使用規則：</p><h3 id=1-only-call-hooks-at-the-top-level-dont-call-hooks-inside-loops-conditions-or-nested-functions>1. Only Call Hooks at the Top Level. Don’t call Hooks inside loops, conditions, or nested functions.</h3><p>由於 Hooks 是使用 Linked List 的方式來保存，所以順序對於 Hooks 來說相當重要，如果像是使用 conditions 導致 useState 順序出現變動，那在透過 Linked List 依序取出 memoizedState 就會出現問題。</p><h3 id=2-only-call-hooks-from-react-functions>2. Only Call Hooks from React Functions</h3><p>從 source code 可以知道 hooks 其實是呼叫 dispatcher 的 functions，如果是非 React Component，那麼在 get dispatcher 就會出現 error 啦！</p><h2 id=class-component-的-state-保存>Class Component 的 State 保存</h2><p>既然說到使用 hooks 就可以保存 state，那不免要來談一下我們常用的 class component 是如何保存 state 的。</p><p>在 <code>ReactFiberClassComponent.js</code> 中有提到新建 ClassInstance 的method:</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>function</span> <span style=color:#1f2328>constructClassInstance</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>workInProgress</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>Fiber</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>ctor</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>any</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>props</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>any</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>renderExpirationTime</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>ExpirationTime</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>){</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 略
</span></span></span><span style=display:flex><span>  <span style=color:#cf222e>const</span> <span style=color:#1f2328>instance</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>new</span> <span style=color:#1f2328>ctor</span><span style=color:#1f2328>(</span><span style=color:#1f2328>props</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>context</span><span style=color:#1f2328>);</span> <span style=color:#57606a>//ctor 就是 component class
</span></span></span><span style=display:flex><span>  <span style=color:#57606a>// 將我們所寫的 this.state assign 給 fiber memoizedState
</span></span></span><span style=display:flex><span>  <span style=color:#cf222e>const</span> <span style=color:#1f2328>state</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>workInProgress</span><span style=color:#1f2328>.</span><span style=color:#1f2328>memoizedState</span> <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>instance</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span> <span style=color:#0550ae>!==</span> <span style=color:#cf222e>null</span> <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#1f2328>instance</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span> <span style=color:#0550ae>!==</span> <span style=color:#cf222e>undefined</span>
</span></span><span style=display:flex><span>      <span style=color:#0550ae>?</span> <span style=color:#1f2328>instance</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span>
</span></span><span style=display:flex><span>      <span style=color:#0550ae>:</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>adoptClassInstance</span><span style=color:#1f2328>(</span><span style=color:#1f2328>workInProgress</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>instance</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// 略
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>透過上面程式碼可以知道， class component state 最後還是會被 assign 給 fiber memoizedState，這樣說起來， hooks 只是使用另一種方式來達到一樣的效果。</p><h2 id=references>References</h2><ol><li><a href=https://github.com/facebook/react>React source code</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-02-03-study-2019-01/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>2019/01月份自我學習回顧</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-03-03-study-2019-02/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>2019/02月份自我學習回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>