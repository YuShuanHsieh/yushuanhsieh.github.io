<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Golang - Request test using net/http/httptrace — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Golang - Request test using net/http/httptrace</h1><div class=post-meta><time datetime=2019-03-14>March 14, 2019</time>
<span class=separator>·</span>
<span class=reading-time>8 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>在撰寫 HTTP request test 測試程式時，除了測試 response 結果是否如預期之外，我們還需要知道過程中需要耗費多少時間（request latency）。市面上有一些 libraries (e.g <code>opencensus</code>) 能提供相關的 HTTP 事件 trace，不過仔細看會發現他們大多也是整合 golang 本身提供的 <code>httptrace</code> 來實現追蹤功能，因此我們就直接來了解 <code>httptrace</code> 的運作原理和應用方式，再結合 <code>http/httptest</code>，讓 handler test 更完整。</p><h2 id=request-處理流程>Request 處理流程</h2><p>在說明 <code>httptrace</code> 之前，由於 request test 中是藉由 http package 來發起的 ，所以先來了解一下 golang 中，透過 <code>http</code> package 的 client 處理 http request 的流程。</p><h3 id=new-request>New Request</h3><p>首先我們透過 <code>http.Get</code> 發出 request， 過程中會經由 NewRequest 產出 request instance 並交由 client.Do(request) method 處理。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/example&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// is equal to: </span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;GET&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;/example&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>resp</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultClient</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Do</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=send-request>Send Request</h3><p><code>client.do</code> method 主要負責發送 request 和回傳 response，可說是整段流程的核心，而過程中會先處理 HTTP Headers 相關內容，接著將 request 正式透過 <code>client.send</code> 送出。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// source code from client.go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 1. Client Do</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>c</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Client</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>do</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>retres</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Response</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>reterr</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// ...some code to deal with Headers</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>resp</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>didTimeout</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#6639ba>send</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>deadline</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	  </span><span style=color:#57606a>// error handle	</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// ...more</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 2. Send Request</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>c</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Client</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>send</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>deadline</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#1f2328>)</span><span style=color:#fff> 
</span></span></span><span style=display:flex><span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>resp</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Response</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>didTimeout</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// ...some code to add cookies</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// send request with transport method</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>resp</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>didTimeout</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>send</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#6639ba>transport</span><span style=color:#1f2328>(),</span><span style=color:#fff> </span><span style=color:#1f2328>deadline</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// ...more</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=roundtripper-transport>RoundTripper (Transport)</h3><p>接著來到重頭戲啦，上面 code 中可以看到 <code>c.transport()</code>，它會回傳 <code>RoundTripper</code>，真正執行整個 <strong>http transaction</strong> 就是 RoundTripper 中的 <code>RoundTrip</code> method。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// 3. Start RoundTrip</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>send</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ireq</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>rt</span><span style=color:#fff> </span><span style=color:#1f2328>RoundTripper</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>deadline</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>resp</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Response</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>didTimeout</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// ...more</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>resp</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>rt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RoundTrip</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// ..more</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p><code>RoundTripper</code> 是一個 interface，http package 在預設情況下是使用實作 RoundTripper 的 DefaultTransport 進行基本傳輸， 如果對於 http 流程很清楚的使用者，當然可以自己自製一個 transport 來完成整個 transaction。</p><p>緊接著繼續看 DefaultTransport 是如何實作 RoundTrip 的。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// source code from transport.go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// internel RoundTrip methods</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>t</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Transport</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>roundTrip</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>Response</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// get trace from ctx</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Context</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>trace</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ContextClientTrace</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>頭幾行馬上看到我們今天要介紹的主角 - <code>httptrace</code> 中的 trace instance，它在 <code>roundTrip</code> method 被取出來，而從這邊我們就可以很快地了解到為什麼 <code>httptrace</code> 可以實現追蹤 http 的流程了，因為在接下來的 transaction 過程中，這個 trace 中的 functions 都會在適時的階段觸發。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>pc</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>persistConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>readResponse</span><span style=color:#1f2328>(</span><span style=color:#1f2328>rc</span><span style=color:#fff> </span><span style=color:#1f2328>requestAndChan</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientTrace</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>resp</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Response</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;&amp;</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotFirstResponseByte</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>peek</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>pc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>br</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Peek</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;&amp;</span><span style=color:#fff> </span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>peek</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#57606a>// trigger trace hook functions</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>trace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>GotFirstResponseByte</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>![httptrace]({{ site.url }}/assets/images/httptrace-1.png)</p><h2 id=httptrace-packages>httptrace packages</h2><p>httptrace 主要提供 HTTP client requests 的事件中追蹤，package 中包含了 <code>ClientTrace</code> struct，我們可以客製化 <code>ClientTrace</code> 中的 methods，並把 trace 放入 request context，這樣的話，這個 trace 就會在上面剛剛所提到的 roundTrip 中被觸發。</p><blockquote><p>Package httptrace provides mechanisms to trace the events within HTTP client requests.</p></blockquote><p>目前 ClientTrace 有幾個 hooks methods ，分別是：</p><ol><li><code>GetConn func(hostPort string)</code> - called before a connection is created</li><li><code>GotConn func(GotConnInfo)</code> - called after a successful connection is obtained</li><li><code>PutIdleConn func(err error)</code> - called when the connection is returned to the idle pool</li><li><code>GotFirstResponseByte func()</code></li><li><code>Got100Continue func()</code></li><li><code>Got1xxResponse func(code int, header textproto.MIMEHeader) error</code></li><li><code>DNSStart func(DNSStartInfo)</code></li><li><code>DNSDone func(DNSDoneInfo)</code></li><li><code>ConnectStart func(network, addr string)</code></li><li><code>ConnectDone func(network, addr string, err error)</code></li><li><code>TLSHandshakeStart func()</code></li><li><code>TLSHandshakeDone func(tls.ConnectionState, error)</code></li><li><code>WroteHeaderField func(key string, value []string)</code> - called after the Transport has written each request header</li><li><code>WroteHeaders func()</code></li><li><code>Wait100Continue func()</code></li><li><code>WroteRequest func(WroteRequestInfo)</code> - called with the result of writing the request and any body</li></ol><p>蠻多節點可以追蹤的，就看使用者自己的需求。</p><h2 id=實作>實作</h2><p>了解上述的流程之後，我們就可以實際實作一次，在 request test 中追蹤 http request 流程了! 假設我們要追蹤 <code>GotConn</code> 到 <code>GotFirstResponseByte</code> 這段時間。</p><ol><li>首先引入必要的 packages</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;time&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http/httptest&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http/httptrace&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li>接著產生一個包含我們自己實作 methods 的 trace</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>Tracer</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>start</span><span style=color:#fff>       </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>end</span><span style=color:#fff>         </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>latency</span><span style=color:#fff>     </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Duration</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Tracer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>GotConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connInfo</span><span style=color:#fff> </span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotConnInfo</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>start</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Now</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Tracer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>GotFirstResponseByte</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>end</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Now</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>latency</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>end</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Sub</span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>start</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>trace</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientTrace</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>GotConn</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>tracer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotConn</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>GotFirstResponseByte</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>tracer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotFirstResponseByte</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ol start=3><li>然後把 trace 放入 request context 內</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;POST&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>server</span><span style=color:#1f2328>.</span><span style=color:#1f2328>URL</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>bytes</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>data</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithContext</span><span style=color:#1f2328>(</span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithClientTrace</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Context</span><span style=color:#1f2328>(),</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ol start=4><li>執行 RoundTrip</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// Use DefaultTransport directly</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>res</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultTransport</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RoundTrip</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>剛剛上述流程中有介紹到，預設下是使用 <code>http.DefaultTransport</code> 這個 <code>RoundTripper</code> 來執行 HTTP transaction 的，所以我們在測試時，就直接呼叫 <code>http.DefaultTransport.RoundTrip(req)</code> 即可。如此一來，就可以看到剛剛所設定好的 trace hooks 在過程中被觸發，同時也會獲得最後 response 結果。</p><h2 id=notice-use-httptest-to-start-your-test-server>Notice: use <code>httptest</code> to start your test server</h2><p>上面是包含 client 發 request 階段，所以別忘了要先啟動 server，測試才可以正常執行。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>server</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>httptest</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServer</span><span style=color:#1f2328>(</span><span style=color:#1f2328>handler</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#57606a>// Your test handler</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=demo-code>Demo code</h2><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;time&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http/httptest&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http/httptrace&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;testing&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>Tracer</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>start</span><span style=color:#fff>       </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>end</span><span style=color:#fff>         </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Time</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>latency</span><span style=color:#fff>     </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Duration</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Tracer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>GotConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connInfo</span><span style=color:#fff> </span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotConnInfo</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>start</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Now</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Tracer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>GotFirstResponseByte</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>end</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Now</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>latency</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>end</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Sub</span><span style=color:#1f2328>(</span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#1f2328>start</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>trace</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientTrace</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>GotConn</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>tracer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotConn</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>GotFirstResponseByte</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>tracer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GotFirstResponseByte</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>TestRequest</span><span style=color:#1f2328>(</span><span style=color:#1f2328>t</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>testing</span><span style=color:#1f2328>.</span><span style=color:#1f2328>T</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// handler := your handler</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>server</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>httptest</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServer</span><span style=color:#1f2328>(</span><span style=color:#1f2328>handler</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#57606a>// New test server</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;POST&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>server</span><span style=color:#1f2328>.</span><span style=color:#1f2328>URL</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>bytes</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>data</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithContext</span><span style=color:#1f2328>(</span><span style=color:#1f2328>httptrace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithClientTrace</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Context</span><span style=color:#1f2328>(),</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>res</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultTransport</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RoundTrip</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// check your response</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>server</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Close</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=references>References:</h2><ul><li><a href=https://golang.org/pkg/net/http/httptrace/>https://golang.org/pkg/net/http/httptrace/</a></li></ul></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-03-10-functional-options/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Functional options pattern in GO</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-04-04-study-201903/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>2019/03月份自我學習回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>