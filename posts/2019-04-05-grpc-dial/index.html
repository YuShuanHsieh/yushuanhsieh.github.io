<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>grpc-go source code trace - gRPC client 與 server 建立連線過程 — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>grpc-go source code trace - gRPC client 與 server 建立連線過程</h1><div class=post-meta><time datetime=2019-04-05>April 5, 2019</time>
<span class=separator>·</span>
<span class=reading-time>9 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 <code>grpc.Dial</code> 後所執行的連線流程，包含 gRPC 實現 load-balancing 的機制。</p><h2 id=packages>packages</h2><p>grpc-go v1.19.1</p><h2 id=grpcdial-的背後>grpc.Dial 的背後</h2><p>以下是 client 向 server 連線的基本方式。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>grpc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Dial</span><span style=color:#1f2328>(</span><span style=color:#1f2328>serverIpAddress</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>grpc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInsecure</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>Dial</span><span style=color:#1f2328>(</span><span style=color:#1f2328>target</span><span style=color:#fff> </span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>opts</span><span style=color:#fff> </span><span style=color:#0550ae>...</span><span style=color:#1f2328>DialOption</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>DialContext</span><span style=color:#1f2328>(</span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Background</span><span style=color:#1f2328>(),</span><span style=color:#fff> </span><span style=color:#1f2328>target</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>opts</span><span style=color:#0550ae>...</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>首先， Client 需要透過 <strong>Name Resolver</strong> 解析 Dial 中的 <code>target string</code> 來取得 Server 正確的 IP Addresses 和 port，以利後續建立 connection。例如使用 DNS Name Resolver，就可以透過 <code>conn, err := grpc.Dial("dns:///your.target.name:8888")</code> 這種 Domain name 的方式來發送 RPCs。</p><p>關於 Name Resolution 部分可以參閱 <a href=https://github.com/grpc/grpc/blob/master/doc/naming.md>官方文件</a> 說明。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// Notice: 部分 source code 被移除</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>DialContext</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>target</span><span style=color:#fff> </span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>opts</span><span style=color:#fff> </span><span style=color:#0550ae>...</span><span style=color:#1f2328>DialOption</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>conn</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverBuilder</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	  </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>parseTarget</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>target</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	  </span><span style=color:#1f2328>grpclog</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Infof</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;parsed scheme: %q&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Scheme</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	  </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverBuilder</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Scheme</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverBuilder</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#57606a>// If resolver builder is still nil, the parsed target&#39;s scheme is</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#57606a>// not registered. Fallback to default resolver and set Endpoint to</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#57606a>// the original target.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>grpclog</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Infof</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;scheme %q not registered, fallback to default scheme&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Scheme</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Target</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>Scheme</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#6639ba>GetDefaultScheme</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>Endpoint</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>target</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#57606a>// Default use passthrough resolver builder (passthrough.go)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverBuilder</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Scheme</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>rWrapper</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>newCCResolverWrapper</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Errorf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to build resolver: %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p><code>Resolver</code> 是一個 interface，使用者可以根據需求來註冊不同實作的 resolver，例如 <code>etcd-io/etcd</code> 。而在沒有指定 resolver 情況下（我們可以使用 URI scheme 來選擇特定 resolver， e.g. <code>etcd://</code> ）， grpc-go 會使用預設 <code>passthrough resolver</code> 去解析名稱。(passthrough 其實就是很單純地把 target 再返回來，因此僅適用於簡單應用或是測試。另外在 gRPC 文件中有提到，預設是使用 DNS，不過 grpc-go 卻是用 passthrough)。</p><p>想參考第三方實作 resolver ，可參見 <a href=https://github.com/etcd-io/etcd/blob/master/clientv3/balancer/resolver/endpoint/endpoint.go>etcd clientv3 resolver</a></p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>newCCResolverWrapper</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>ccResolverWrapper</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ccr</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>ccResolverWrapper</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>:</span><span style=color:#fff>     </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>addrCh</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Address</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>scCh</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Create a resolver from resolver builder</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ccr</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>rb</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Build</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parsedTarget</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>ccr</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>BuildOption</span><span style=color:#1f2328>{</span><span style=color:#1f2328>DisableServiceConfig</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>disableServiceConfig</span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>以下以 default 的 passthrough resolver 來說明接下去的流程。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// Default use passthrough Builder.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>passthroughBuilder</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>Build</span><span style=color:#1f2328>(</span><span style=color:#1f2328>target</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Target</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>opts</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>BuildOption</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Resolver</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>r</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>passthroughResolver</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>target</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>target</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>:</span><span style=color:#fff>     </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>r</span><span style=color:#1f2328>.</span><span style=color:#6639ba>start</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>r</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>passthroughResolver</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>start</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// 直接返回使用者輸入的 target</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>r</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>UpdateState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>State</span><span style=color:#1f2328>{</span><span style=color:#1f2328>Addresses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Address</span><span style=color:#1f2328>{{</span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>r</span><span style=color:#1f2328>.</span><span style=color:#1f2328>target</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Endpoint</span><span style=color:#1f2328>}}})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>ccr</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ccResolverWrapper</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>UpdateState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>State</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// 透過 wrapper 通知 ClientConn 更新 State</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ccr</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>updateResolverState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>當 Name Resolver 解析完 target 之後，會透過 balancer wrapper 產生的 watcher 通知 <code>Balancer</code> 最新的 Addresses。</p><p>![gRPC-Dial-1.png]({{ site.url }}/assets/images/gRPC-Dial-1.png)</p><p><strong>Balancer</strong> 是 gRPC 實現 load-balacing 要角，它最主要負責 Handle connection 和 addresses 的狀態變化（例如當 Addresses 更新時則更新連線），以及在後續 transport 階段決定該選擇哪個 server connection(又稱為 balancer policy)。 gRPC Load Balance 採用 <a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md#external-load-balancing-service>External Load Balancing Service</a>，讓使用者可以選擇其他實作的 Balancer。</p><blockquote><p><strong>Balancer</strong> takes input from gRPC, manages SubConns, and collects and aggregates the connectivity states. It also generates and updates the Picker used by gRPC to pick SubConns for RPCs.</p></blockquote><blockquote><p><strong>SubConn</strong> represents a gRPC sub connection. Each sub connection contains a list of addresses. gRPC will try to connect to them (in sequence), and stop trying the remainder once one connection is successful.</p></blockquote><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>updateResolverState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>State</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>dopts</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancerBuilder</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>isGRPCLB</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>newBalancerName</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>grpclbName</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;&amp;</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>LB</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>newBalancerName</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>LB</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#57606a>// Default use pick first balancer(pick_first.go)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>newBalancerName</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>PickFirstBalancerName</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>switchBalancer</span><span style=color:#1f2328>(</span><span style=color:#1f2328>newBalancerName</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancerWrapper</span><span style=color:#1f2328>.</span><span style=color:#6639ba>updateResolverState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// Use resolverUpdateCh to pass resolved Addresses to Balancer</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>ccb</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ccBalancerWrapper</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>updateResolverState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>State</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverUpdateCh</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>s</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>switchBalancer</span><span style=color:#1f2328>(</span><span style=color:#1f2328>name</span><span style=color:#fff> </span><span style=color:#cf222e>string</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancerWrapper</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>newCCBalancerWrapper</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>builder</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancerBuildOpts</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>newCCBalancerWrapper</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Builder</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>bopts</span><span style=color:#fff> </span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>BuildOptions</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ccBalancerWrapper</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ccb</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>ccBalancerWrapper</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>:</span><span style=color:#fff>               </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>stateChangeQueue</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#6639ba>newSCStateUpdateBuffer</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>resolverUpdateCh</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>State</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>done</span><span style=color:#1f2328>:</span><span style=color:#fff>             </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>subConns</span><span style=color:#1f2328>:</span><span style=color:#fff>         </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>map</span><span style=color:#1f2328>[</span><span style=color:#0550ae>*</span><span style=color:#1f2328>acBalancerWrapper</span><span style=color:#1f2328>]</span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// Create a watcher for name resolved events.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>go</span><span style=color:#fff> </span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#6639ba>watcher</span><span style=color:#1f2328>()</span><span style=color:#fff> 
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancer</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Build</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>bopts</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>ccb</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>以下擷取 watcher 接收 resolver Update 的後續處理：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// watcher balancer functions sequentially, so the balancer can be implemented</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// lock-free.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>ccb</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>ccBalancerWrapper</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>watcher</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>select</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolverUpdateCh</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>select</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>done</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Close</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>default</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>ub</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.(</span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>V2Balancer</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ub</span><span style=color:#1f2328>.</span><span style=color:#6639ba>UpdateResolverState</span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>s</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ccb</span><span style=color:#1f2328>.</span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#6639ba>HandleResolvedAddrs</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Addresses</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>這邊以簡單地 pick first balancer 為例，觀察 Balancer Handle resolved addresses 實際行為。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>pickfirstBalancer</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientConn</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>sc</span><span style=color:#fff> </span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>SubConn</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>pickfirstBalancer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>HandleResolvedAddrs</span><span style=color:#1f2328>(</span><span style=color:#1f2328>addrs</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Address</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>grpclog</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Infof</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pickfirstBalancer: HandleResolvedAddrs called with error %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewSubConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>addrs</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>balancer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>NewSubConnOptions</span><span style=color:#1f2328>{})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>grpclog</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Errorf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pickfirstBalancer: failed to NewSubConn: %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>UpdateBalancerState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Idle</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>picker</span><span style=color:#1f2328>{</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Connect</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#57606a>// Connect to server (b.sc is balancer_conn_wrapper)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>UpdateAddresses</span><span style=color:#1f2328>(</span><span style=color:#1f2328>addrs</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>sc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Connect</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>上面可以看到如果沒有 subConn ，則會透過 <code>balancer_conn_wrapper</code> 通知 ClientConn 新建一條 SubConn，接著觸發 Connnect。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>ac</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>addrConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>connect</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#6639ba>updateConnectivityState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Connecting</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// Start a goroutine connecting to the server asynchronously.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>go</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#6639ba>resetTransport</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>此時就會另起 goroutine 來正式與 Server 建立連線。
![gRPC-Dial-2.png]({{ site.url }}/assets/images/gRPC-Dial-2.png)</p><p><code>resetTransport</code> 是一個無限循環的迴圈，意味著如果 Server 端異常導致 disconnect 時，client 端會重新嘗試連線，直到連線成功或是 <code>connectivity.Shutdown</code> 為止。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>ac</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>addrConn</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>resetTransport</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Reconnect forever</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>i</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff> </span><span style=color:#1f2328>;</span><span style=color:#fff> </span><span style=color:#1f2328>i</span><span style=color:#0550ae>++</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>i</span><span style=color:#fff> </span><span style=color:#1f2328>&gt;</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>resolveNow</span><span style=color:#1f2328>(</span><span style=color:#1f2328>resolver</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ResolveNowOption</span><span style=color:#1f2328>{})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Lock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Shutdown</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>newTr</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>addr</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>reconnect</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#6639ba>tryAllAddrs</span><span style=color:#1f2328>(</span><span style=color:#1f2328>addrs</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connectDeadline</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Lock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Shutdown</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#6639ba>updateConnectivityState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>TransientFailure</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#57606a>// Backoff.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resetBackoff</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#57606a>// wait and reconnect</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		  </span><span style=color:#1f2328>timer</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewTimer</span><span style=color:#1f2328>(</span><span style=color:#1f2328>backoffFor</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>select</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>timer</span><span style=color:#1f2328>.</span><span style=color:#1f2328>C</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Lock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>backoffIdx</span><span style=color:#0550ae>++</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>b</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>timer</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Stop</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Done</span><span style=color:#1f2328>():</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#1f2328>timer</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Stop</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>				</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>continue</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Lock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>state</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Shutdown</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>newTr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Close</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>curAddr</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>addr</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>transport</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>newTr</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>backoffIdx</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// A connection with Ready state can be picked</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>!</span><span style=color:#1f2328>healthcheckManagingState</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#6639ba>updateConnectivityState</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectivity</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Ready</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ac</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mu</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Unlock</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#57606a>// Block until the created transport is down. And when this happens,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#57606a>// we restart from the top of the addr list.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0550ae>&lt;-</span><span style=color:#1f2328>reconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Done</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#6639ba>hcancel</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>如果在一開始的 <code>grpc.Dial</code> 額外設置 <code>grpc.WithBlock</code>，則會等到確認 <code>connectivity.Ready</code> 後才會返回。不然在預設狀態下是 non-blocking ，讓 Client 在等待連線成功之餘可以做更多事情。</p><p>最後可以透過實驗來觀察 gRPC log，對流程有更深刻的了解。只要加入 environment variable
<code>GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info</code></p><p>就會看到在無法與 server 連線的情況下， client 會不斷地進行反覆重新連線行為。</p><p>![gRPC-Dial-3.png]({{ site.url }}/assets/images/gRPC-Dial-3.png)</p><h2 id=references>References</h2><ol><li><a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md>https://github.com/grpc/grpc/blob/master/doc/load-balancing.md</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-04-04-study-201903/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>2019/03月份自我學習回顧</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-05-04-study-201904/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>2019/04月份自我學習回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>