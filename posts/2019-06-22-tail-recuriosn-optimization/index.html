<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Tail Recursion in Go — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Tail Recursion in Go</h1><div class=post-meta><time datetime=2019-06-14>June 14, 2019</time>
<span class=separator>·</span>
<span class=reading-time>12 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/web/>Web</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>最近在實驗效能分析時，有使用到 Tail Recursion 寫法，因此也好奇在 Go 中是否有跟 C 一樣進行 Tail Recursion optimization 優化。在文章中，首先會用 C asm 來說明 tail call optimization，接著 dump Go asm code 來觀察結果。</p><h2 id=tail-call>Tail Call</h2><p>在說明 Tail Recursion Optimization 之前，先來說說 <a href=https://en.wikipedia.org/wiki/Tail_call>Tail Call</a>。 Tail Call 概念很簡單，就是在 function 的最後語句執行另一個 function call。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>search</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> data<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>advanced_search</span><span style=color:#1f2328>(</span>data<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>要注意的是， <code>Tail Call</code> 意指最後的行為只允許使用 function call，所以以下的寫法就不是 <code>Tail Call</code>，因為它需要先進行 <code>2 * 1 + funcB(a-1)</code> 的運算，才能返回。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>non_tail</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span> <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>a <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>   <span style=color:#cf222e>return</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span> <span style=color:#cf222e>return</span> <span style=color:#0550ae>2</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>1</span> <span style=color:#0550ae>+</span> <span style=color:#6639ba>funcB</span><span style=color:#1f2328>(</span>a<span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tail-recursion>Tail recursion</h2><p>Tail Call 可以應用在 Recursion 上，在尾端再次呼叫自身程式，就被稱為 <code>Tail recursion</code>。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>search</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> data<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#57606a>// some conditions..
</span></span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>search</span><span style=color:#1f2328>(</span>data<span style=color:#1f2328>);</span> <span style=color:#57606a>// call itself.
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>提到 Tail recursion，很多人常用的例子是透過將 Recursion 改寫成 Tail recursion 的方式，來改善 <strong>Find Fibonacci Number</strong> 的效能。回想當初我們在初學習實作 Fibonacci Number 所使用的 Recursion 寫法：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>recursion_fib</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> n<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>n <span style=color:#0550ae>&lt;=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> 
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> n<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span>  <span style=color:#6639ba>recursion_fib</span><span style=color:#1f2328>(</span>n <span style=color:#0550ae>-</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>+</span> <span style=color:#6639ba>recursion_fib</span><span style=color:#1f2328>(</span>n <span style=color:#0550ae>-</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以改寫成 <code>Tail recursion</code> 版本：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>tail_recursion_fib</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> n<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> left<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> right<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>n <span style=color:#0550ae>==</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> left<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>tail_recursion_fib</span><span style=color:#1f2328>(</span>n<span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> right<span style=color:#1f2328>,</span> left <span style=color:#0550ae>+</span> right<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>透過以上改寫，我們就能避免掉因為 Recursion 造成的 <a href=http://www-inst.eecs.berkeley.edu/~cs61bl/r//cur/trees/fibonacci-tree.html>Fibonacci Trees</a>，進而提升執行效率（<a href="https://hackmd.io/@sysprog/rJ8BOjGGl?type=view#Fibonacci-sequence">Fibonacci with recursion and tail recursion 效率比較</a>）。</p><p>不過，單就上面我們無法看出 <code>Tail recursion</code> 的優勢，以上面提到的 Fibonacci Number 為例，將 Recursion 改成 Tail recursion，因為減少一個自身的 function 運算，避免 Recursion 發散，本來就對效能有所提升。</p><h2 id=tail-recursion-optimization>Tail recursion Optimization</h2><p>之所以採用 <code>Tail recursion</code> 寫法的主要原因，是因為很多語言可以透過 compile 將 <code>Tail recursion</code> 的效能最佳化，以避免因為執行到 function 而需要為它建立新的 <a href=https://www.cs.auckland.ac.nz/software/AlgAnim/stacks.html>Stack Frame</a>。</p><p><img src=https://www.cs.auckland.ac.nz/software/AlgAnim/fig/stackframe.gif alt="stack frame"></p><p>舉例:</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>tail</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> result<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>a <span style=color:#0550ae>==</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>tail</span><span style=color:#1f2328>(</span>a<span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span> <span style=color:#0550ae>+</span> result<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>![study]({{ site.url }}/assets/images/tail-recursion-2.png)</p><p>可以看到在 <code>Tail recursion Optimization</code> 部分，只需要把處理過後的數值儲存起來，接著跳轉到同一個 function 最前端重複執行即可。反過來看，如果沒有經過優化的話，那麼就需要耗費 stack 空間為相同的 function 建立新的 stack frame。</p><h2 id=tail-recursion-optimization--iteration>Tail Recursion (Optimization) / Iteration</h2><p>看到這裡或許你會覺得很奇怪，這樣透過 <code>Tail recursion Optimization</code> 所產生的結果不就跟 <code>iteration</code> 差不多嗎？</p><p>其實 Iteration 與 Tail Recursion 在大部分情況下可以相互轉換。</p><blockquote><p>All iterative functions can be converted to recursion because iteration is just a special case of recursion <strong>(tail recursion)</strong>. In functional languages like Scheme, iteration is defined as tail recursion.
(<a href=https://www.ocf.berkeley.edu>www.ocf.berkeley.edu</a>)</p></blockquote><p>只是差別在於如果沒有經過 Optimization 階段，那麼 Tail Recursion 會需要處理額外的 stack frame，因此比 Iteration 慢。而 Tail recursion Optimization 後，就能有跟 Iteration 相似的表現。</p><blockquote><p>In functional programming languages, tail call elimination is often guaranteed by the language standard, allowing tail recursion to use a similar amount of memory as an equivalent loop.
(<a href=https://en.wikipedia.org/wiki/Tail_call>https://en.wikipedia.org/wiki/Tail_call</a>)</p></blockquote><h2 id=使用-tail-recursion-的時機>使用 <code>Tail Recursion</code> 的時機</h2><ol><li>Language 有支援 Tail Recursion Optimization（如果沒有支援，就有可能讓 stack 空間耗盡）。</li><li>提升 code 的簡潔與可讀性。</li><li>需要操作 recursive data structures 像是 linklist or tree 等
。</li></ol><h2 id=效能實驗>效能實驗</h2><p>簡單實驗一下會在有無 <code>Tail recursion Optimization</code> 的情況下，會有多少差距。</p><h3 id=機器>機器</h3><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Raspberry B3 ARM Cortex-A53 <span style=color:#0550ae>64</span> bit
</span></span><span style=display:flex><span>gcc target: aarch64-linux-gnu
</span></span></code></pre></td></tr></table></div></div><h3 id=test-code>Test code</h3><p>測試程式則是大家熟悉的 Fibonacci Number</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>tail_recursion_fib</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> n<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> left<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> right<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>n <span style=color:#0550ae>==</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> left<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>tail_recursion_fib</span><span style=color:#1f2328>(</span>n<span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> right<span style=color:#1f2328>,</span> left <span style=color:#0550ae>+</span> right<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，先把 c file compile 成沒有優化過後的 assembly code file。
（之所以不直接用 -Os 來進行 code 優化，是因為 -Os 會影響很多 assembly code，不好進行評估）</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>gcc -S tail.c
</span></span></code></pre></td></tr></table></div></div><p>可以獲得 *.s 的 assembly code file。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#900;font-weight:700>tail_fib</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        stp     x29<span style=color:#1f2328>,</span> x30<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>32</span><span style=color:#1f2328>]</span> <span style=color:#57606a>// 移動 stack pointer
</span></span></span><span style=display:flex><span>        add     x29<span style=color:#1f2328>,</span> sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>        str     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        str     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        str     w2<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        cmp     w0<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>        bne     <span style=color:#1f2328>.</span>L2
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        b       <span style=color:#1f2328>.</span>L3
</span></span><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>L2</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        sub     w3<span style=color:#1f2328>,</span> w0<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>#</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>        ldr     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        add     w0<span style=color:#1f2328>,</span> w1<span style=color:#1f2328>,</span> w0
</span></span><span style=display:flex><span>        mov     w2<span style=color:#1f2328>,</span> w0
</span></span><span style=display:flex><span>        ldr     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        mov     w0<span style=color:#1f2328>,</span> w3
</span></span><span style=display:flex><span>        bl      tail_fib <span style=color:#57606a>// branch 執行 function
</span></span></span><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>L3</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        ldp     x29<span style=color:#1f2328>,</span> x30<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>],</span> <span style=color:#0550ae>32</span>
</span></span><span style=display:flex><span>        ret
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>size   tail_fib<span style=color:#1f2328>,</span> <span style=color:#1f2328>.</span><span style=color:#0550ae>-</span>tail_fib
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>section        <span style=color:#1f2328>.</span>rodata
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>align  <span style=color:#0550ae>3</span>
</span></span></code></pre></td></tr></table></div></div><p>然後參照優化行為，把 <code>bl tail_fib</code> 改成 goto 到原有 stack frame head：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#900;font-weight:700>tail_fib</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        stp     x29<span style=color:#1f2328>,</span> x30<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>32</span><span style=color:#1f2328>]</span><span style=color:#0550ae>!</span>
</span></span><span style=display:flex><span>        add     x29<span style=color:#1f2328>,</span> sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>	b	<span style=color:#1f2328>.</span>L5
</span></span><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>L5</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        str     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        str     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        str     w2<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        cmp     w0<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>        bne     <span style=color:#1f2328>.</span>L2
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        b       <span style=color:#1f2328>.</span>L3
</span></span><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>L2</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>28</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        sub     w3<span style=color:#1f2328>,</span> w0<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>#</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>        ldr     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        ldr     w0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        add     w0<span style=color:#1f2328>,</span> w1<span style=color:#1f2328>,</span> w0
</span></span><span style=display:flex><span>        mov     w2<span style=color:#1f2328>,</span> w0
</span></span><span style=display:flex><span>        ldr     w1<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>x29<span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        mov     w0<span style=color:#1f2328>,</span> w3
</span></span><span style=display:flex><span>	b	<span style=color:#1f2328>.</span>L5 <span style=color:#57606a>// 用途類似 x86 的 jmp. 跳至 .L5 避免移動 SP
</span></span></span><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>L3</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        ldp     x29<span style=color:#1f2328>,</span> x30<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>],</span> <span style=color:#0550ae>32</span>
</span></span><span style=display:flex><span>        ret
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>size   tail_fib<span style=color:#1f2328>,</span> <span style=color:#1f2328>.</span><span style=color:#0550ae>-</span>tail_fib
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>section        <span style=color:#1f2328>.</span>rodata
</span></span><span style=display:flex><span>        <span style=color:#1f2328>.</span>align  <span style=color:#0550ae>3</span>
</span></span></code></pre></td></tr></table></div></div><p>另外也提供 <code>x86_64-apple-darwin</code> 的 assembly code，可以很清楚看出 <code>Tail Recursion Optimization</code>。(說明一下，由於 <code>aarch64-linux-gnu</code> 在經過 compiler 優化後變化很大，如果不熟悉 assembly code 的話，可能看不出差異點，所以提供 x86_64-apple-darwin 版本)</p><p>Normal</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#900;font-weight:700>LBB0_2</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>-</span><span style=color:#0550ae>8</span><span style=color:#1f2328>(</span><span style=color:#0550ae>%</span>rbp<span style=color:#1f2328>),</span> <span style=color:#0550ae>%</span>eax
</span></span><span style=display:flex><span>	subl	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>eax
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>-</span><span style=color:#0550ae>16</span><span style=color:#1f2328>(</span><span style=color:#0550ae>%</span>rbp<span style=color:#1f2328>),</span> <span style=color:#0550ae>%</span>esi
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>-</span><span style=color:#0550ae>12</span><span style=color:#1f2328>(</span><span style=color:#0550ae>%</span>rbp<span style=color:#1f2328>),</span> <span style=color:#0550ae>%</span>ecx
</span></span><span style=display:flex><span>	addl	<span style=color:#0550ae>-</span><span style=color:#0550ae>16</span><span style=color:#1f2328>(</span><span style=color:#0550ae>%</span>rbp<span style=color:#1f2328>),</span> <span style=color:#0550ae>%</span>ecx
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>eax<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>edi
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>ecx<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>edx
</span></span><span style=display:flex><span>	callq	_tail_fib <span style=color:#57606a>// call function and then move down SP
</span></span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>eax<span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>4</span><span style=color:#1f2328>(</span><span style=color:#0550ae>%</span>rbp<span style=color:#1f2328>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Optimization</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#900;font-weight:700>LBB0_3</span><span style=color:#1f2328>:</span>                                 <span style=color:#f6f8fa;background-color:#82071e>##</span> <span style=color:#0550ae>=&gt;</span>This Inner Loop <span style=color:#900;font-weight:700>Header</span><span style=color:#1f2328>:</span> Depth<span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>edx<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>esi
</span></span><span style=display:flex><span>	decl	<span style=color:#0550ae>%</span>edi
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>eax<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>edx
</span></span><span style=display:flex><span>	addl	<span style=color:#0550ae>%</span>esi<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>edx
</span></span><span style=display:flex><span>	incl	<span style=color:#0550ae>%</span>ecx
</span></span><span style=display:flex><span>	movl	<span style=color:#0550ae>%</span>esi<span style=color:#1f2328>,</span> <span style=color:#0550ae>%</span>eax
</span></span><span style=display:flex><span>	jne	LBB0_3 <span style=color:#57606a>// Use loop
</span></span></span></code></pre></td></tr></table></div></div><h3 id=result>Result</h3><p>在 recusion 數量少的情況下，效率沒有太多變化，不過當到了 recusive function call 多的時候，就會看出兩者之間的時間差距。</p><p>![study]({{ site.url }}/assets/images/tail-recursion.png)</p><h2 id=recursion-in-go>Recursion in Go</h2><p>在說明 Tail Recursion in Go 之前，先來說說 Recursion 在 Go 的表現。回想在 default stack size 8MB 使用 Recursion 都有可能會遇到 stack overflow 情況，更何況是在每個 goroutine init stack size 為 2 KB (go version 1.12.X) 開發。</p><p>幸好的是使用 Go 時，遇到 stack 沒空間，那麼 runtime 就會幫 goroutine 擴展 stack size，好讓程式能執行下去。不過相對應的代價是需要處理 grow stack 部分而導致影響執行時間。也因此 Recursion 在 Go 下更要謹慎使用。</p><h2 id=tail-recursion-optimization-in-go>Tail Recursion Optimization in Go</h2><p>終於進入到正式主題了，那個 Go 到底沒有支援 <code>Tail Recursion Optimization</code> 呢？</p><p>答案是<strong>目前沒有</strong>(go version 1.12.X)。</p><p>之前有蠻多相關的討論，例如：</p><ul><li><a href=https://github.com/golang/go/issues/22624>proposal: Go 2: add become statement to support tail calls</a></li><li><a href=https://github.com/golang/go/issues/16798>proposal: cmd/compile: add tail call optimization for self-recursion only</a></li></ul><p>主要原因在於：</p><ol><li>Make stack traces clean</li><li>大部分情況下，tail recursion 可以 rewrite 成 loop，所以必要性不是太高</li></ol><p>基於上面兩點，Go lang 維護者覺得目前應該專注在其他更重要的議題上，因此這個功能預計在 go 2.0 也不會做。</p><p>當然，你也可以用 gccgo 來 compile go file，由於是採用 gcc compiler，所以透過優化選項就可以編譯成 <code>Tail Recursion Optimization</code> 版本。</p><h2 id=實驗分析>實驗分析</h2><h3 id=test-code-1>Test code</h3><p>一樣使用 <code>Fibonacci Number</code> Tail Recursion 寫法為例：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>TailRecursionFib</span><span style=color:#1f2328>(</span><span style=color:#1f2328>n</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>left</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>right</span><span style=color:#fff> </span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>int</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>n</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>left</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>TailRecursionFib</span><span style=color:#1f2328>(</span><span style=color:#1f2328>n</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>right</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>left</span><span style=color:#0550ae>+</span><span style=color:#1f2328>right</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=assembly-code-with-go-compiler>Assembly code with Go compiler</h3><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span>TailRecursionFib STEXT size<span style=color:#0550ae>=</span><span style=color:#0550ae>121</span> args<span style=color:#0550ae>=</span><span style=color:#0550ae>0x20</span> locals<span style=color:#0550ae>=</span><span style=color:#0550ae>0x28</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0000</span> <span style=color:#0550ae>00000</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	TEXT	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span><span style=color:#6639ba>TailRecursionFib</span><span style=color:#1f2328>(</span>SB<span style=color:#1f2328>),</span> ABIInternal<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>40</span><span style=color:#0550ae>-</span><span style=color:#0550ae>32</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0000</span> <span style=color:#0550ae>00000</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	<span style=color:#6639ba>MOVQ</span>	<span style=color:#1f2328>(</span>TLS<span style=color:#1f2328>),</span> CX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0009</span> <span style=color:#0550ae>0000</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	CMPQ	SP<span style=color:#1f2328>,</span> <span style=color:#0550ae>16</span><span style=color:#1f2328>(</span>CX<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x000d</span> <span style=color:#0550ae>00013</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	JLS	<span style=color:#0550ae>114</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x000f</span> <span style=color:#0550ae>00015</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	SUBQ	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>40</span><span style=color:#1f2328>,</span> SP
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0013</span> <span style=color:#0550ae>0001</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	MOVQ	BP<span style=color:#1f2328>,</span> <span style=color:#0550ae>32</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0018</span> <span style=color:#0550ae>00024</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	LEAQ	<span style=color:#0550ae>32</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> BP
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	FUNCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> gclocals<span style=color:#f6f8fa;background-color:#82071e>·</span><span style=color:#0550ae>33</span>cdeccccebe80329f1fdbee7f5874cb<span style=color:#1f2328>(</span>SB<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	FUNCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> gclocals<span style=color:#f6f8fa;background-color:#82071e>·</span><span style=color:#0550ae>33</span>cdeccccebe80329f1fdbee7f5874cb<span style=color:#1f2328>(</span>SB<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>38</span><span style=color:#1f2328>)</span>	FUNCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>3</span><span style=color:#1f2328>,</span> gclocals<span style=color:#f6f8fa;background-color:#82071e>·</span><span style=color:#0550ae>33</span>cdeccccebe80329f1fdbee7f5874cb<span style=color:#1f2328>(</span>SB<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>39</span><span style=color:#1f2328>)</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>2</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>39</span><span style=color:#1f2328>)</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x001d</span> <span style=color:#0550ae>0002</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>39</span><span style=color:#1f2328>)</span>	MOVQ	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span>n<span style=color:#0550ae>+</span><span style=color:#0550ae>48</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0022</span> <span style=color:#0550ae>00034</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>39</span><span style=color:#1f2328>)</span>	TESTQ	AX<span style=color:#1f2328>,</span> AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0025</span> <span style=color:#0550ae>00037</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>39</span><span style=color:#1f2328>)</span>	JNE	<span style=color:#0550ae>59</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0027</span> <span style=color:#0550ae>0003</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>40</span><span style=color:#1f2328>)</span>	MOVQ	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span>left<span style=color:#0550ae>+</span><span style=color:#0550ae>56</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x002c</span> <span style=color:#0550ae>00044</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>40</span><span style=color:#1f2328>)</span>	MOVQ	AX<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span><span style=color:#0550ae>~</span>r3<span style=color:#0550ae>+</span><span style=color:#0550ae>72</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0031</span> <span style=color:#0550ae>0004</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>40</span><span style=color:#1f2328>)</span>	MOVQ	<span style=color:#0550ae>32</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> BP
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0036</span> <span style=color:#0550ae>00054</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>40</span><span style=color:#1f2328>)</span>	ADDQ	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>40</span><span style=color:#1f2328>,</span> SP
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x003a</span> <span style=color:#0550ae>0005</span><span style=color:#0550ae>8</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>40</span><span style=color:#1f2328>)</span>	RET
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x003b</span> <span style=color:#0550ae>0005</span><span style=color:#0550ae>9</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	DECQ	AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x003e</span> <span style=color:#0550ae>00062</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	MOVQ	AX<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0042</span> <span style=color:#0550ae>00066</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	MOVQ	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span>right<span style=color:#0550ae>+</span><span style=color:#0550ae>64</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0047</span> <span style=color:#0550ae>00071</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	MOVQ	AX<span style=color:#1f2328>,</span> <span style=color:#0550ae>8</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x004c</span> <span style=color:#0550ae>00076</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	MOVQ	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span>left<span style=color:#0550ae>+</span><span style=color:#0550ae>56</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> CX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0051</span> <span style=color:#0550ae>000</span><span style=color:#0550ae>81</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	ADDQ	CX<span style=color:#1f2328>,</span> AX
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0054</span> <span style=color:#0550ae>000</span><span style=color:#0550ae>84</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	MOVQ	AX<span style=color:#1f2328>,</span> <span style=color:#0550ae>16</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>0x0059</span> <span style=color:#0550ae>000</span><span style=color:#0550ae>89</span> <span style=color:#1f2328>(</span>main<span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>go</span><span style=color:#1f2328>:</span><span style=color:#0550ae>42</span><span style=color:#1f2328>)</span>	CALL	<span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>.</span><span style=color:#6639ba>TailRecursionFib</span><span style=color:#1f2328>(</span>SB<span style=color:#1f2328>)</span> <span style=color:#57606a>// Call itself
</span></span></span></code></pre></td></tr></table></div></div><h3 id=效能>效能</h3><p>執行時，可以明顯看出在 grow stack size 時出現的執行時間高峰，進而降低整體速度。</p><p>![study]({{ site.url }}/assets/images/stack-size-comp.png)</p><h3 id=tail-recursion-vs-iteration>Tail Recursion v.s. Iteration</h3><p>![study]({{ site.url }}/assets/images/fib-comp.png)</p><p>如果是 Go 的話，使用 Iteration 的效能會遠比 Tail Recursion 好。</p><h2 id=references>References</h2><ol><li><a href=https://en.wikipedia.org/wiki/Tail_call>https://en.wikipedia.org/wiki/Tail_call</a></li><li><a href=https://www.cs.auckland.ac.nz/software/AlgAnim/stacks.html>https://www.cs.auckland.ac.nz/software/AlgAnim/stacks.html</a></li><li><a href=https://www.ocf.berkeley.edu/~shidi/cs61a/wiki/Iteration_vs._recursion>https://www.ocf.berkeley.edu/~shidi/cs61a/wiki/Iteration_vs._recursion</a></li><li><a href=https://www.ardanlabs.com/blog/2013/09/recursion-and-tail-calls-in-go_26.html>https://www.ardanlabs.com/blog/2013/09/recursion-and-tail-calls-in-go_26.html</a></li><li><a href=https://gcc.gnu.org/wiki/SplitStacks>https://gcc.gnu.org/wiki/SplitStacks</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-06-04-study-201906/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>2019/05月份自我學習回顧</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-06-15-side-project/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Side Project for daily study trello</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>