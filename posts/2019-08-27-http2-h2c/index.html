<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Start HTTP/2 running over cleartext TCP — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Start HTTP/2 running over cleartext TCP</h1><div class=post-meta><time datetime=2019-08-27>August 27, 2019</time>
<span class=separator>·</span>
<span class=reading-time>14 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/network/>Network</a>
<a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><nav class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#http2-version-identification>HTTP/2 Version Identification</a><ul><li><a href=#1-h2>1. h2</a></li><li><a href=#2-h2c>2. h2c</a><ul><li><a href=#upgrading-from-http2>Upgrading from HTTP/2</a></li></ul></li></ul></li><li><a href=#h2c-http2-server>h2c HTTP/2 Server</a><ul><li><a href=#httpserver-with-h2c-handler><code>http.Server</code> with <code>h2c handler</code></a></li><li><a href=#h2c-server-example>H2c Server Example</a></li></ul></li><li><a href=#h2c-client>H2c Client</a><ul><li><a href=#1-建立-upgrade-request>1. 建立 upgrade request</a></li><li><a href=#2-加入更多-http2-upgrade-requirement>2. 加入更多 HTTP/2 upgrade requirement</a></li><li><a href=#3-send-upgrade-request-and-get-response>3. Send upgrade request and get response</a></li><li><a href=#4-starting-http2-with-prior-knowledge>4. Starting HTTP/2 with Prior Knowledge</a><ul><li><a href=#http2transportnewclientconn>http2.Transport.NewClientConn</a></li></ul></li><li><a href=#5-communicating-communications>5. Communicating communications</a></li></ul></li><li><a href=#831-補充關於-http2transport>8/31 補充：關於 http2.Transport</a></li><li><a href=#sample-codes>Sample Codes</a><ul><li><a href=#server>Server</a></li><li><a href=#client>Client</a></li></ul></li></ul></nav></nav><div class=post-content><p>![flow]({{ site.url }}/assets/images/h2c-flow.png)</p><h2 id=前言>前言</h2><p>主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。</p><h2 id=http2-version-identification>HTTP/2 Version Identification</h2><p>在 <a href=https://httpwg.org/specs/rfc7540.html#versioning>RFC7540 3.1</a> 中有明確定義出 HTTP/2 on TLS protocol or cleartext TCP 的識別號，這個識別主要用於 client 端詢問 server 對於 HTTP/2 的 protocol 支援，以及切換到 HTTP/2 的過程。</p><h3 id=1-h2>1. h2</h3><p>The string &ldquo;h2&rdquo; identifies the protocol where HTTP/2 uses Transport Layer Security (TLS).</p><h3 id=2-h2c>2. h2c</h3><p>The string &ldquo;h2c&rdquo; identifies the protocol where HTTP/2 is run over cleartext TCP.</p><p>為了方便辨識，以下會直接以 <code>h2</code> <code>h2c</code> 代號來表示基於不同 protocol 的 HTTP/2。</p><p>而在h2c 部分，有更細節的說明：</p><blockquote><p>This identifier is used in the <strong>HTTP/1.1 Upgrade header field</strong> and in any place where HTTP/2 over TCP is identified.</p><p>The &ldquo;h2c&rdquo; string is <strong>reserved from the ALPN identifier</strong> space but describes a protocol that does not use TLS.</p></blockquote><p>Client 與 server 在決定要用什麼 protocol 溝通時，h2 基於 TLS ，因此是採用 <code>TLS-ALPN(Application-Layer Protocol Negotiation)</code> 方式；至於 h2c 沒有 TLS ，所以就走 HTTP/1.1 Upgrade 機制，在 request header 中會加入 <code>Upgrade:h2c</code>，讓 server 可以根據此來辨識是否支援並且 upgrade。</p><h4 id=upgrading-from-http2>Upgrading from HTTP/2</h4><p>(<a href=https://httpwg.org/specs/rfc7540.html#versioning>RFC7540 8.1.1</a>)雖然 HTTP/1.1 可以透過 <code>Upgrade</code> 機制來切換到 HTTP/2 protocol，但是 HTTP/2 卻是明確禁止這樣的行為，也因此無法透過這樣的 upgrade 機制從 HTTP/2 轉換到其他 protocol。</p><h2 id=h2c-http2-server>h2c HTTP/2 Server</h2><p>在上面內容有提到，h2c HTTP/2 server 要能識別 HTTP/1.1 Upgrade 機制，並且給予適當回應，因此這也是在實作 server 時的首要功能。</p><h3 id=httpserver-with-h2c-handler><code>http.Server</code> with <code>h2c handler</code></h3><p>用 Go 建立 h2c server 的方式很簡單，一樣是使用大家熟悉的 <code>net/http</code> package <code>Server.ListenAndServe</code> 來啟動 server 並接收後續的 request，不過因為必須處理 HTTP/2 型態的 request，所以可以猜到我們需要調整 <code>Handler</code> 設定，來讓 server 能了解 HTTP/2 格式的 request。</p><p>調整 Handler 的方式，可以透過 <code>"golang.org/x/net/http2/h2c"</code> package 來達成目的。使用 <code>h2c.NewHandler</code> method 就能產生 <code>h2cHandler</code>， h2cHandler 會根據 request 的內容來判斷後續執行方式：</p><ol><li><p><strong>HTTP/2</strong>: 如果讀到 client HTTP/2 Connection Preface(<a href=https://httpwg.org/specs/rfc7540.html#ConnectionHeader>RFC7540-3.5</a>，後面會說明)，就會建立額外的 http2.serverConn，後續 request 將由這新的 connect 來接收處理。</p></li><li><p><strong>HTTP/1.1 upgrade to HTTP/2 h2c</strong>: 第二種情況則是 request 包含 protocol upgrade 資訊(<a href=https://httpwg.org/specs/rfc7540.html#discover-http>RFC7540-3.2</a>)，如果可以 upgrade，就會將 HTTP 內容轉換成 HTTP/2 格式，接著同樣地新建 http2.serverConn 來處理 request。</p></li><li><p><strong>HTTP</strong>: 如果沒有包含任何 HTTP/2 和 Upgrade 資訊，就當成一般 HTTP request 處理。</p></li></ol><p>有了這些概念後，我們就可以知道 h2c server 該如何建立。</p><h3 id=h2c-server-example>H2c Server Example</h3><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;fmt&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;log&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;golang.org/x/net/http2&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;golang.org/x/net/http2/h2c&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>h2serv</span><span style=color:#fff> </span><span style=color:#1f2328>http2</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>handler</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>HandlerFunc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>w</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ResponseWriter</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>r</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fprint</span><span style=color:#1f2328>(</span><span style=color:#1f2328>w</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;HTTP/2 Server Example&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>serv</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>:</span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;:9090&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#57606a>// Create a h2c handler to dispatch incoming requests.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>h2c</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewHandler</span><span style=color:#1f2328>(</span><span style=color:#1f2328>handler</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>h2serv</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Printf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Start server %s&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>serv</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>serv</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ListenAndServe</span><span style=color:#1f2328>();</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ErrServerClosed</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Panicln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>在網路上可能會看到以下寫法：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>server</span><span style=color:#fff> </span><span style=color:#1f2328>http2</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>l</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>net</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Listen</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;tcp&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;localhost:9090&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>l</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Accept</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>server</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ServeConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>http2</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ServeConnOpts</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>HandlerFunc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>w</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ResponseWriter</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>r</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fprintf</span><span style=color:#1f2328>(</span><span style=color:#1f2328>w</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;HTTP/2 Server Example&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>}),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>這種 low-level API <code>l.Accept()</code> Loop，並且直接使用 <code>server.ServeConn</code> 的做法等於省略了 <code>h2cHandler</code> 這層判斷，讓 request 直接進入 HTTP/2 格式處理。建議還是使用 <code>h2c.NewHandler</code> 作法，讓 server handler 比較有彈性。</p><h2 id=h2c-client>H2c Client</h2><p>有了 HTTP/2 server 後，就寫個簡單的 client 來進行測試吧！</p><p>首先，Client 端發出含有 <code>Upgrade:h2c</code> 的 HTTP request 到 server 端，然後確認 response 是否如預期。</p><h3 id=1-建立-upgrade-request>1. 建立 upgrade request</h3><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>MethodGet</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;http://localhost:9090&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Header</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Add</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Upgrade&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;h2c&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-加入更多-http2-upgrade-requirement>2. 加入更多 HTTP/2 upgrade requirement</h3><p>光有 <code>Upgrade:h2c</code> 還不夠，還要有 <code>HTTP2-Settings</code> Header Field 以及其內容。</p><blockquote><p>The content of the HTTP2-Settings header field is the payload of a SETTINGS frame, encoded as a base64url string.</p></blockquote><p>HTTP2-Settings 其實就是 HTTP/2 的 SETTINGS frame(<a href=https://httpwg.org/specs/rfc7540.html#SETTINGS>RFC7540 6.5</a>)，其值用來進行溝通期間的參數設定，例如更新 window size 或是 設定 max frame size 等。只不過因為我們起初是發送 HTTP request，所以就將值 encoding 後放入到 <code>HTTP2-Settings</code> header field 中。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>settings</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>5</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0xa</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>3</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0xfa</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>6</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>01</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0x40</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>4</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>MethodGet</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;http://localhost:9000&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Header</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Add</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Connection&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;HTTP2-Settings&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Header</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Add</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;HTTP2-Settings&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>base64</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RawURLEncoding</span><span style=color:#1f2328>.</span><span style=color:#6639ba>EncodeToString</span><span style=color:#1f2328>(</span><span style=color:#1f2328>settings</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>簡單說明一下，settings 的內容是由數個 Identifier (16 bit) + Value (32 bit) 所組成，其格式定義在 <a href=https://httpwg.org/specs/rfc7540.html#SettingFormat>RFC7540 6.5.1 SETTINGS FORMAT</a>。</p><p>舉例來說：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>5</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0xa</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// big-endian</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 0x5 - SETTINGS_MAX_FRAME_SIZE, value - 0xa0000 = 655360</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>最後，為什麼 upgrade request 需要 <code>HTTP2-Settings</code>，在 <a href=https://httpwg.org/specs/rfc7540.html#Http2SettingsHeader>RFC7540 3.2.1</a> 有解答：</p><blockquote><p>Providing these values (HTTP2-Settings) in the upgrade request gives a client an opportunity to provide parameters prior to receiving any frames from the server.</p></blockquote><h3 id=3-send-upgrade-request-and-get-response>3. Send upgrade request and get response</h3><p>Client sample code</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>net</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Dial</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;tcp&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;localhost:9000&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>newUpgradeRequest</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// send a request</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Write</span><span style=color:#1f2328>(</span><span style=color:#1f2328>conn</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// get data from server</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>buf</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>bufio</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>conn</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// convert data to HTTP response format. </span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>resp</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ReadResponse</span><span style=color:#1f2328>(</span><span style=color:#1f2328>buf</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>resp</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StatusCode</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StatusSwitchingProtocols</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;server does not support h2c&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>為了 re-use <code>net.Conn</code> 以及使用 http2.Client，因此就採用 low level API 的方式來發送 HTTP request。</p><p>我們從 Wireshark 可以看到結果，在正確設置了 upgrade header 後，就會回應 switching protocols response，而這也正是我們所預期的。</p><p>![flow]({{ site.url }}/assets/images/h2c-upgrade-1.png)</p><p>而從 Go server Debug tool 來看 (其實就是在 go run server.go 前面加上<code>GODEBUG=http2debug=2</code>)</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0550ae>2019</span><span style=color:#0550ae>/</span><span style=color:#0550ae>08</span><span style=color:#0550ae>/</span><span style=color:#0550ae>27</span> <span style=color:#0550ae>15</span><span style=color:#0550ae>:</span><span style=color:#0550ae>23</span><span style=color:#0550ae>:</span><span style=color:#0550ae>33</span> <span style=color:#900;font-weight:700>http2</span><span style=color:#1f2328>:</span> Framer <span style=color:#0550ae>0xc0001420e0</span><span style=color:#0550ae>:</span> wrote SETTINGS len<span style=color:#0550ae>=</span><span style=color:#0550ae>24</span><span style=color:#1f2328>,</span> <span style=color:#900;font-weight:700>settings</span><span style=color:#1f2328>:</span> MAX_FRAME_SIZE<span style=color:#0550ae>=</span><span style=color:#0550ae>655360</span><span style=color:#1f2328>,</span> MAX_CONCURRENT_STREAMS<span style=color:#0550ae>=</span><span style=color:#0550ae>250</span><span style=color:#1f2328>,</span> MAX_HEADER_LIST_SIZE<span style=color:#0550ae>=</span><span style=color:#0550ae>655680</span><span style=color:#1f2328>,</span> INITIAL_WINDOW_SIZE<span style=color:#0550ae>=</span><span style=color:#0550ae>655360</span>
</span></span></code></pre></td></tr></table></div></div><p>MAX_FRAME_SIZE value 也有正確被 server 讀取，皆大歡喜！</p><p>反之，如果只設置 <code>Upgrade:"h2c"</code> 而沒有設置 <code>HTTP2-Settings</code> 的情況下：</p><p>![flow]({{ site.url }}/assets/images/h2c-upgrade-2.png)</p><p>Server 只會把這個 request 當作 HTTP 來處理，就直接回 200 以及對應的 response data 啦～</p><h3 id=4-starting-http2-with-prior-knowledge>4. Starting HTTP/2 with Prior Knowledge</h3><p>根據規範指示，當我們收到 101 response，就需要接著發送 connection preface (<a href=https://httpwg.org/specs/rfc7540.html#known-http>RFC7540 3.4</a>) 以利 server 繼續進行 HTTP/2 connection 建立。</p><blockquote><p>Upon receiving the 101 response, the client MUST send a <strong>connection preface</strong> (Section 3.5), which includes a SETTINGS frame.</p></blockquote><p>從 h2c.go source code 也可以看到有這樣的確認機制：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// h2cUpgrade establishes a h2c connection using the HTTP/1 upgrade (Section 3.2).</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>h2cUpgrade</span><span style=color:#1f2328>(</span><span style=color:#1f2328>w</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ResponseWriter</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>r</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Request</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>net</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// more...</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>rw</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Write</span><span style=color:#1f2328>([]</span><span style=color:#6639ba>byte</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;HTTP/1.1 101 Switching Protocols\r\n&#34;</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0a3069>&#34;Connection: Upgrade\r\n&#34;</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0a3069>&#34;Upgrade: h2c\r\n\r\n&#34;</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>rw</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Flush</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// A conforming client will now send an H2 client preface which need to drain</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// since we already sent this.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>drainClientPreface</span><span style=color:#1f2328>(</span><span style=color:#1f2328>rw</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>c</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>rwConn</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>Conn</span><span style=color:#1f2328>:</span><span style=color:#fff>      </span><span style=color:#1f2328>conn</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>Reader</span><span style=color:#1f2328>:</span><span style=color:#fff>    </span><span style=color:#1f2328>io</span><span style=color:#1f2328>.</span><span style=color:#6639ba>MultiReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>initBytes</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>rw</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>BufWriter</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#6639ba>newSettingsAckSwallowWriter</span><span style=color:#1f2328>(</span><span style=color:#1f2328>rw</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Writer</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>如果 client 沒有接著發送 <code>connection preface</code> 那該連線就無法成立。</p><p>因此，我們就繼續實作 client，在收到 101 status code 後，就接著使用 <code>http2.Transport.NewClientConn</code> 來建立 client conn 並發送 client connection preface。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>tr</span><span style=color:#fff> </span><span style=color:#1f2328>http2</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Transport</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>http2Conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>tr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewClientConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>conn</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalln</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=http2transportnewclientconn>http2.Transport.NewClientConn</h4><p>client connection preface 在 NewClientConn 階段就會發送給 server 端，從 source code 可以看到相關實作。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>t</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Transport</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>newClientConn</span><span style=color:#1f2328>(</span><span style=color:#1f2328>c</span><span style=color:#fff> </span><span style=color:#1f2328>net</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Conn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>singleUse</span><span style=color:#fff> </span><span style=color:#cf222e>bool</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>ClientConn</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>t</span><span style=color:#1f2328>:</span><span style=color:#fff>                     </span><span style=color:#1f2328>t</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>tconn</span><span style=color:#1f2328>:</span><span style=color:#fff>                 </span><span style=color:#1f2328>c</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>readerDone</span><span style=color:#1f2328>:</span><span style=color:#fff>            </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>nextStreamID</span><span style=color:#1f2328>:</span><span style=color:#fff>          </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>maxFrameSize</span><span style=color:#1f2328>:</span><span style=color:#fff>          </span><span style=color:#0550ae>16</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;&lt;</span><span style=color:#fff> </span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span><span style=color:#fff>           </span><span style=color:#57606a>// spec default</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>initialWindowSize</span><span style=color:#1f2328>:</span><span style=color:#fff>     </span><span style=color:#0550ae>65535</span><span style=color:#1f2328>,</span><span style=color:#fff>              </span><span style=color:#57606a>// spec default</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>maxConcurrentStreams</span><span style=color:#1f2328>:</span><span style=color:#fff>  </span><span style=color:#0550ae>1000</span><span style=color:#1f2328>,</span><span style=color:#fff>               </span><span style=color:#57606a>// &#34;infinite&#34;, per spec. 1000 seems good enough.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>peerMaxHeaderListSize</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0550ae>0xffffffffffffffff</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#57606a>// &#34;infinite&#34;, per spec. Use 2^64-1 instead.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>streams</span><span style=color:#1f2328>:</span><span style=color:#fff>               </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>map</span><span style=color:#1f2328>[</span><span style=color:#cf222e>uint32</span><span style=color:#1f2328>]</span><span style=color:#0550ae>*</span><span style=color:#1f2328>clientStream</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>singleUse</span><span style=color:#1f2328>:</span><span style=color:#fff>             </span><span style=color:#1f2328>singleUse</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>wantSettingsAck</span><span style=color:#1f2328>:</span><span style=color:#fff>       </span><span style=color:#cf222e>true</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>pings</span><span style=color:#1f2328>:</span><span style=color:#fff>                 </span><span style=color:#6639ba>make</span><span style=color:#1f2328>(</span><span style=color:#cf222e>map</span><span style=color:#1f2328>[[</span><span style=color:#0550ae>8</span><span style=color:#1f2328>]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>]</span><span style=color:#cf222e>chan</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// skip..</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// send the client connection preface</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>bw</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Write</span><span style=color:#1f2328>(</span><span style=color:#1f2328>clientPreface</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>fr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WriteSettings</span><span style=color:#1f2328>(</span><span style=color:#1f2328>initialSettings</span><span style=color:#0550ae>...</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>fr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WriteWindowUpdate</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>transportDefaultConnFlow</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>inflow</span><span style=color:#1f2328>.</span><span style=color:#6639ba>add</span><span style=color:#1f2328>(</span><span style=color:#1f2328>transportDefaultConnFlow</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#1f2328>initialWindowSize</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>bw</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Flush</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>werr</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>werr</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>go</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>readLoop</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=5-communicating-communications>5. Communicating communications</h3><p>最後，連線建立完成，可以開始開啟新 stream 並且交換 frames！</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>req</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewRequest</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>MethodGet</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;http://localhost:9000&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>http2Conn</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RoundTrip</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>![flow]({{ site.url }}/assets/images/h2c-upgrade-3.png)</p><h2 id=831-補充關於-http2transport>8/31 補充：關於 http2.Transport</h2><p>在整合 demo code 成為一個完整的 h2c-client 時，發現一個連線 bug。</p><p>當 client 發送一個包含 HTTP/2 upgrade 的 HTTP request 時， server 在接收到後，會將其格式轉成 HTTP/2 ，並在後續建立起 HTTP/2 連線時，會把這個資訊放入 buffer 中。HTTP/2 連線建立成功， server 發送完初始 SETTINGS frames 後，就會緊接著將這個 request 處理完並且將 response 回應給 client 端。</p><p>此時，這個 response 的 stream ID 為 <code>0x1</code> (<a href=https://httpwg.org/specs/rfc7540.html#StreamIdentifiers>RFC 7540 5.1.1</a>)，但是 client 端在接收到 response 後卻會顯示 error， error 內容為收到未預期的 stream ID ，並強制關閉 connection。</p><p>查看了一下 client transport source code，發現 transport 在接收 DATA frame 時會檢查 stream ID 是否超出 request 的 stream ID。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>rl</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>clientConnReadLoop</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>processData</span><span style=color:#1f2328>(</span><span style=color:#1f2328>f</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>DataFrame</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>neverSent</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>nextStreamID</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>f</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamID</span><span style=color:#fff> </span><span style=color:#0550ae>&gt;=</span><span style=color:#fff> </span><span style=color:#1f2328>neverSent</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#57606a>// We never asked for this.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#6639ba>logf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;http2: Transport received unsolicited DATA frame; closing connection&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>ConnectionError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ErrCodeProtocol</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>看的出來是 <code>nextStreamID</code> 的問題。這時候回去看 <code>newClientConn</code> source code，會看到 <code>nextStreamID</code> 會被初始化成 <code>1</code>，而此時因為 client 端在 HTTP/2 連線建立成功後，還沒有發送任何 request，因此 <code>nextStreamID</code> 維持 1，進而造成這樣的錯誤回報。</p><p>那麼要如何避免這樣的錯誤發生呢？</p><p>一個蠻 tricky 的做法，就是:</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>tr</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>http2</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Transport</span><span style=color:#1f2328>{</span><span style=color:#1f2328>AllowHTTP</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>把 Transport 的 AllowHTTP 設定為 true。雖然根據官方 source code 的說法：</p><blockquote><p>AllowHTTP, if true, permits HTTP/2 requests using the insecure, plain-text &ldquo;http&rdquo; scheme. Note that this does not enable h2c support.</p></blockquote><p>看起來好像跟問題沒有什麼太大關係，不過這樣的設定會更動到 <code>nextStreamID</code> 的值。一樣是在 <code>newClientConn</code> method：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>t</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AllowHTTP</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>cc</span><span style=color:#1f2328>.</span><span style=color:#1f2328>nextStreamID</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0550ae>3</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>因為 nextStreamID 初始值變成 3 了，所以當接收到 response 的 stream ID 為 1 時，判斷就會是正常結果，避免掉上述的問題。</p><p>老實說，把 nextStreamID 設置為 3，對我來說是一個蠻 magic number 的行為，code 裡面也沒有解釋為什麼是 3 而不是 4,5,6,7 &mldr; ，不過既然可以解決了，就這樣吧 XD 畢竟 Go 本來的 HTTP2 package 本來就是預設 TLS 行為，這個錯誤只會發生在使用 HTTP/1.1 upgrade 後而已。</p><h2 id=sample-codes>Sample Codes</h2><h3 id=server>Server</h3><p>{%gist YuShuanHsieh/c902a1bd245b9ad52e30f832d2cc9ab3 %}</p><h3 id=client>Client</h3><p>{%gist YuShuanHsieh/e249dfe245df7612d7fdd9cb7333ba16 %}</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2019-08-18-sem-glibc/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>semaphore sem_post 在 glibc v2.0 v2.1 之比較</span>
</a><a href=https://yushuanhsieh.github.io/posts/2019-09-07-201908-study/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>2019/08月份自我學習回顧</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>