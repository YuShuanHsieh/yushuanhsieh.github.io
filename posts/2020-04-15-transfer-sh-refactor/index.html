<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Trace transfer.sh open project — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Trace transfer.sh open project</h1><div class=post-meta><time datetime=2020-04-15>April 15, 2020</time>
<span class=separator>·</span>
<span class=reading-time>8 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>因為工作需求，需要一個透過 cli 就可以 upload 和 download 的工具，剛好 open project <code>transfer.sh</code> 有提供類似的功能，不過我們有額外的需求，包含每個 request 都要能 fiter IP 和執行 HTTP Basic Auth 驗證，因此就有這個機會來分析一下 <code>transfer.sh</code> source code 並且後續可以針對我們需求來修改！</p><h2 id=source-code-分析>Source code 分析</h2><h3 id=http-router>HTTP Router</h3><p>首先來看 <code>transfer.sh</code> 的 source code，這個 project 其實程式碼蠻少的，所以大概花個幾個小時就可以大致了解運作方式。<code>transfer.sh</code> 是一個簡單的 Web server，其 path router 是使用 <code>gorilla/mux</code>，雖然 <code>gorilla/mux</code> 的 path search 是 slice 設計， route 效率不比 radix tree router 效能好，不過因為這個 Web server 的 path 也不多，所以就還可以接受。</p><h3 id=upload-files>Upload Files</h3><p>下圖為 Upload 行為簡易流程圖：</p><p><img src=/posts/transfer_1.png alt=hugo></p><p>在上傳檔案的時候，可以透過一開始 start server 的 params 設定要不要有 HTTP Basic Auth 驗證 (<code>http-auth-user</code>, <code>http-auth-pass</code>)，不過這樣子的設定也意味著 Basic Auth 的帳號密碼是直接寫死在 server struct，無法透過其他方式來對帳號密碼進行驗證 (e.g. 打 API 到其他 account service)，不太符合我們的需求，因此這是要調整的地方之一。</p><p>當使用者上傳檔案時，除了上傳檔案到指定的 storage 之外，也會額外儲存 <code>Metadata</code>。<code>Metadata</code> 包含了基本檔案資訊，以及下載次數、時限，和刪除檔案時所需要的 token，這樣使用者進行下載時，我們可以透過 <code>Metadata</code> 的內容來進行下載驗證，像是下載次數是不是過多、或是已經超過下載時限等。使用者在發送 request 時，可以透過 <code>Max-Downloads</code> , <code>Max-Days</code> 來設定這兩項數值，</p><p>這邊要額外注意的是，在上傳檔案之前，會<strong>亂數產生一個 token</strong>，接著檔案會被上傳到 <code>&lt;token>/&lt;filename></code> 的位置，以避免名稱重複所造成的衝突。此外，從 source code 可以發現，作者使用 <code>Mutex</code> 來控制 goroutine 對特定檔案進行讀寫行為，而不是發現檔案被開啟就直接回傳 error。</p><p>在上傳完檔案後，發送回給使用者的 HTTP response 除了會包含 download URL 之外，也會帶有指定的 Delete URL <code>X-Url-Delete</code> ，讓前端可以進一步地設計刪除按鈕來供使用者刪除該檔案。</p><h4 id=關於-http-auth-user-http-auth-pass>關於 <code>http-auth-user</code>, <code>http-auth-pass</code></h4><p><code>http-auth-user</code> 和 <code>http-auth-pass</code> 的驗證只會套用在 upload 相關 API 上，並不會影響 download API。所以即使設定了這個參數， download 還是允許所有使用者使用。</p><h4 id=the-difference-of-uploading-files-using-post-and-put>The difference of uploading files using <code>POST</code> and <code>PUT</code></h4><p><code>transfer.sh</code> 可以使用 <code>POST</code> 和 <code>PUT</code> 兩種 HTTP Method 來上傳檔案，主要差異在於 <code>PUT</code> 預設使用者只上傳一個檔案，因此 request 的 <code>Content-Type</code> header 就是檔案的類型，而 request body 則是檔案內容，這樣使用者也可以很方便地使用以下 cmd 來上傳檔案。(Note: &ndash;upload-file 是使用 PUT HTTP Method)</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>curl --upload-file ./example.md <span style=color:#0a3069>&#34;http://example.com/example.md&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>POST</code> 則是預期 request 的 Content Type 為 <code>multipart/form-data</code>，因此使用者可以一次上傳多個檔案，而 Response 也會包含個別檔案的下載 URL。缺點是使用 <code>POST</code> 會缺少 <code>X-Url-Delete</code> 這個 Delete Header 讓使用者可以手動刪除檔案，所以雖然它提供了比較完整的上傳功能，卻也少了些便利設計。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>url -i -X POST -H <span style=color:#0a3069>&#34;Content-Type: multipart/form-data&#34;</span> -F <span style=color:#0a3069>&#34;file=@./examples.md&#34;</span> -F <span style=color:#0a3069>&#34;file=@./examples2.md&#34;</span> <span style=color:#0a3069>&#34;http://example.com/&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=download-files>Download Files</h3><p>剛剛有提到，上傳檔案後會從 response 得到下載的 URL，而接下來的行為會根據我們怎麼使用 URL 而有所差異：如果使用者是使用瀏覽器開啟這 URL 的話，那 server 會先回傳 preview 畫面，preview 畫面會有檔案格式和檔案大小等資訊，如果是 markdown 類型的文檔甚至還可以呈現出所有內容給使用者先預覽。（實現方式是透過 <code>mux</code> 的 MatcherFunc，比對是否含有 <code>Accept: text/html</code> 這個 header，來判斷是否使用者是不是使用瀏覽器）； 反之，如果是使用像是 curl 來開啟連接，那就會直接下載檔案，而不會出現 preview 的 html 頁面。</p><p>下圖為下載檔案的簡易流程圖(省略 preview 畫面)：</p><p><img src=/posts/transfer_2.png alt=hugo></p><p>使用者發送下載的 request 後，server 會先取出 Metadata，檢查 Metadata 內的時限和下載次數是否有超過設定數值，接著再取出檔案並且回傳檔案內容。雖然取出檔案的流程比較簡單，但也有發現一些問題，例如檢查 Metadata 時發現下載已經超過時限或是下載次數時，只會直接回傳 404 Not Found，並不會主動刪除該檔案。</p><h2 id=調整項目整理>調整項目整理</h2><p>根據以上 source code 分析，列出幾個可以調整的地方：</p><ol><li>不要直接將 <code>http-auth-user</code> <code>http-auth-pass</code> 這個驗證機制直接寫死在 server struct 中，可以改用 interface 方式來處理。</li><li>Metadata 的內容長度不大，如果改用 cache 的方式來記錄，可以提高性能。</li><li>上傳後的檔案有很大機會不會被刪除，所以可能需要在檢查 Metadata 時發現過期時可以主動刪除，或是定期掃上傳後的檔案，檢查哪些檔案已沒在使用。</li><li>目前 IP Filter 是針對整個 server，而 Basic Auth 只有在上傳檔案才會有，因此需要補足下載檔案的驗證機制。</li></ol><p>接下來就會實際調整 code，來讓 code 更符合我的需求 XD</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-04-07-hugo-merge/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Multilingual Mode in Hugo</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-04-22-discourse-deployment/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Discourse Forums Deployment</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>