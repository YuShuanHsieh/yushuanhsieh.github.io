<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Discourse Forums Deployment — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Discourse Forums Deployment</h1><div class=post-meta><time datetime=2020-04-22>April 22, 2020</time>
<span class=separator>·</span>
<span class=reading-time>11 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>這兩天在試著部署 Discourse －目前主流的 forum open porject。雖然它有 cloud 版本可以用，不過因為基於一些因素，我們打算先自行部署，給團隊成員實際試用測試過後，再來看是否要使用官方提供的 Cloud 付費版本。而在部署的過程中發現蠻多問題的，所以也一併記錄下來，給想要自行部署的人參考。</p><h2 id=discourse-container>Discourse Container</h2><p>首先在 Discourse container 部份，我們選擇由 bitnami 所維護的 <a href=https://hub.docker.com/r/bitnami/discourse/>bitnami/discourse</a> 版本，原因是它提供相對完整的 configuration 和流程，事後證明這個選擇也是對的，因為我有嘗試使用 Discourse 所提供的 container 來部署，結果根本是場災難，畢竟官方所提供的 container 本來就不適合用在自行部署，除了流程複雜之外，size 也大許多 (2.5GB)。</p><h3 id=version>Version</h3><p>Discourse 版本部分，目前 (2020/04) 官方是 <code>2.5.0 beta</code>，而 bitnami/discourse 則是 <code>2.4.1</code> 也就是官方所提供的最新穩定版本，因此不會有太大的版本落差。</p><h2 id=部署環境>部署環境</h2><p>我們使用 GKE 作為部署環境，雖然只是供測試使用，可以簡單起個 GCE 就可以，但因為流程完整性，因此還是決定部署在 GKE 上。</p><h3 id=最低資源限制>最低資源限制</h3><p>Discourse 安裝建議的硬體條件：</p><ul><li>modern single core CPU, dual core recommended</li><li>1 GB RAM minimum (with swap)</li><li>64 bit Linux compatible with Docker</li><li>10 GB disk space minimum</li></ul><p>Discourse 本身分成四個部分：</p><ol><li><code>database</code> (postgres)</li><li><code>cache</code> (redis)</li><li><code>web server</code></li><li><code>sidekiq</code></li></ol><p>因為最基本就要起 4 個 pod (我習慣 1 個 container 就用 1 個 pod)，因此最少要 2 個 n1-standard 等級的 node 或是更高等級的機器。</p><h2 id=configuration>Configuration</h2><h3 id=1-cache>1. Cache</h3><h3 id=2-database>2. Database</h3><p>Discourse 的 cache 是採用 <code>redis</code>，而 database 則是 <code>postgres</code>，這兩個是蠻常見的部屬，所以就不多作說明。</p><h3 id=3-web-server>3. Web Server</h3><p>接著部屬 Discourse 的 Web server，在 <a href=https://hub.docker.com/r/bitnami/discourse/>bitnami/discourse</a> 有提供完整的 configuration 參數，可以自行查閱，以下特別提醒幾個需要注意的參數項目。</p><h4 id=default-user-name-and-password-for-admin-account>Default user name and password for admin account</h4><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#953800>DISCOURSE_USERNAME</span><span style=color:#0550ae>=</span>user
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_PASSWORD</span><span style=color:#0550ae>=</span>bitnami123
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_EMAIL</span><span style=color:#0550ae>=</span>user@example.com
</span></span></code></pre></td></tr></table></div></div><p>這三個參數主要是設定 <code>admin</code> 的帳號密碼，後續可以用這組帳號透過 Web 介面登入來修改 Discourse 的配置和樣式，所以一定要記得設定。</p><h4 id=hostname>Hostname</h4><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#953800>DISCOURSE_HOSTNAME</span><span style=color:#0550ae>=</span>www.example.com
</span></span></code></pre></td></tr></table></div></div><p>另外 <code>hostname</code> 也是必須要修改的參數，由於 asset URL 會根據 hostname 而有所不同 (簡單來說就是 Discourse 在 compile asset file 的時候，會連同 hostname 一起 compile，並且產出最後的 permalink) ，如果 hostname 設錯了，那麼 browser 就無法根據路徑正確地取回所需的資源，例如 js、 css 等。</p><p>另外，官方有建議最好 hostname 是 domain name，不要是 IP address，以免出現異常錯誤。</p><h4 id=skip-install-注意>SKIP INSTALL (注意！)</h4><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#953800>DISCOURSE_SKIP_INSTALL</span><span style=color:#0550ae>=</span>no
</span></span></code></pre></td></tr></table></div></div><p>這個參數是部屬 Discourse 的其中一個最重要數值。 Discourse container 在 run 時，由於 default 參數是 no，因此會進行建置 database 流程，此時如果你的database 已經被建立好，那<strong>程式就會直接報錯並且中止執行</strong>！</p><p>這意味著，當 Discourse 的 pod 因為不明原因中止，而 k8s 重新起一個的時候，此時沒有設定 <code>DISCOURSE_SKIP_INSTALL=yes</code>，那 pod 就永遠無法起來啦。這也變成首次部屬 Discourse 時候參數會需要調整，是我覺得稍微不友善的地方。</p><h4 id=database>Database</h4><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#953800>POSTGRESQL_ROOT_USER</span><span style=color:#0550ae>=</span>postgres
</span></span><span style=display:flex><span><span style=color:#953800>POSTGRESQL_ROOT_PASSWORD</span><span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_POSTGRESQL_USERNAME</span><span style=color:#0550ae>=</span>bn_discourse
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_POSTGRESQL_PASSWORD</span><span style=color:#0550ae>=</span>bitnami1
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_POSTGRESQL_NAME</span><span style=color:#0550ae>=</span>bitnami_application
</span></span></code></pre></td></tr></table></div></div><p>Database 有幾個令人會搞混的設定，上面有提到 Discourse container 初始會進行 database 建置作業，因此會同時需要 postgres root account 和 discourse database account 兩個帳號資訊。</p><h4 id=smtp>SMTP</h4><p>SMTP 設定關係到 notification email 寄送和帳號驗證確認信，因此是必要設定項目，如果設定後發現沒有收到 email，可以參閱官方所提供的 <a href=https://meta.discourse.org/t/troubleshooting-email-on-a-new-discourse-install/16326>Troubleshooting email on a new Discourse install</a>。</p><h3 id=4-sidekiq>4. Sidekiq</h3><p>除了 Web server 外，還需要部屬一個 <code>sidekiq</code> 來負責處理一些 backend tasks，例如寄送驗證 email 等。要注意的地方是，它與 Web server 是使用同一個 container，只是下的指令不同。</p><p>Sidekiq 的參數數值就直接 copy Web server configuration 就好，如果參數數值與 Web server 設定不一致，有可能導致系統出錯。(e.g. 系統無法寄信等)</p><p>另外，sidekiq 需要與 web server 進行溝通，所以要多兩個參數設定：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#953800>DISCOURSE_HOST</span><span style=color:#0550ae>=</span>web-server
</span></span><span style=display:flex><span><span style=color:#953800>DISCOURSE_PORT</span><span style=color:#0550ae>=</span><span style=color:#0550ae>80</span>
</span></span></code></pre></td></tr></table></div></div><p>DISCOURSE_PORT 設定要依據 web-server Service 是使用哪一個 port 而作調整。sidekiq 本身不需要與其他 pod 溝通，因此不需要建立對應的 Service。但因為會連結外面網路寄信的關係，因此要注意 VPC 設定。</p><h2 id=deployment>Deployment</h2><p>Discourse 的 kubernates configuration file 可以參閱 <a href=https://github.com/YuShuanHsieh/discourse-k8s-demo>Github discourse-k8s-demo</a>。</p><p>可以先用</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize ./ &gt; discourse_secret.yaml
</span></span></code></pre></td></tr></table></div></div><p>來產出 secret yaml (記得不要把 secret yaml 一起 commit 上去了)，並且部屬到 GKE 上。</p><p>要注意，<strong>Web server 一定要掛 volume</strong>，因為 Discourse 允許用戶上傳 avatar，以及網站所用的 logo 圖檔等，都會放在 <code>/bitnami</code> 底下。（注意：如果是官方版本，那就會在 <code>/share</code> 底下），所以記得要使用 persistant disk 去保存。更重要的是，連同加裝的 <code>plugins</code> 都會放在其中，如果沒有設定 volume 的話，pod 重啟時，除了圖檔消失造成一堆 error，連額外安裝的 plugin 都不會存在。</p><p>另外， Web server 的 <code>livenessProbe</code> 記得要設成 <code>/srv/status</code>，不然直接打 root path <code>/</code> 會有效能上的問題。而 <code>initialDelaySeconds</code> 要設長一點，因為 discourse Web server 需要蠻長的初始化時間。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>livenessProbe:
</span></span><span style=display:flex><span>  httpGet:
</span></span><span style=display:flex><span>    path: /srv/status
</span></span><span style=display:flex><span>    port: server-port
</span></span><span style=display:flex><span>  initialDelaySeconds: 300
</span></span><span style=display:flex><span>  periodSeconds: 60
</span></span></code></pre></td></tr></table></div></div><h2 id=install-plugins>Install Plugins</h2><p>Discourse 另一個重要功能就是能安插各式 plugin，其中像是 openID、oauth2 這些主流第三方驗證流程都要靠 plugin 才能使用。不過很可惜的是， bitnami/discourse container 無法透過 configuration 設定 plugins 來讓 container 剛起來時就去抓，而是要自己手動進入 pod 中去安裝，當 plugins 被安裝到 volume 設定好的空間後，接下來 pod 重啟時就不需要再安裝一次。</p><p>總結一下安裝 plugins 流程：</p><ol><li>首次部屬 web server，並等 pod 狀態變成正常運作</li><li>使用　<code>kubectl exec --it &lt;pod> -- /bin/bash</code> 進入 pod</li><li>進到指定 folder <code>cd /opt/bitnami/discourse</code></li><li>安裝 plugins <code>RAILS_ENV=production bundle exec rake plugin:install repo=PLUGIN_REPO_URL</code></li><li>在 pod 中直接 compile <code>RAILS_ENV=production bundle exec rake assets:precompile</code></li></ol><p>然後檢查 <code>/bitnami/discourse/plugins</code> 就會看到剛剛安裝的 plugin 在裡面了。</p><h2 id=總結>總結</h2><p>總結一下 Discourse 部屬的幾個要點：</p><ol><li>有 4 個 container 需要部屬： redis, postgres, web server, sidekiq</li><li>web server 和 sidekiq 使用同一個 container，其中參數設定也要一致，並且 sidekiq 需要多加 web server 的連線資訊。</li><li>須注意 <code>DISCOURSE_SKIP_INS TALL</code> 參數，避免 web server container 無法順利啟動</li><li>web server 要掛 volume，並且 plugins 需要手動安裝進去。(當然也可以選擇 clone <a href=https://github.com/bitnami/bitnami-docker-discourse>bitnami-docker-discourse</a>)，然後把自己想要的 plugins 先預裝進去，不過這樣 container 也會比較胖。</li><li>Web server 剛啟動時需要將近 1 core，後續 memory 使用也可能需要到 2.5 GB 這麼多，請先設定好 resource 限制，避免在執行時會有嚴重效能影響。</li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-04-15-transfer-sh-refactor/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Trace transfer.sh open project</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-04-29-hugo-symlinks/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Side Project - Symlink Generator for Multi-lang Hugo Site</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>