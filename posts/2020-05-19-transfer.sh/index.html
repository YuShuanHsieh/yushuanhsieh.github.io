<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Side Project - Transfer.sh — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Side Project - Transfer.sh</h1><div class=post-meta><time datetime=2020-05-19>May 19, 2020</time>
<span class=separator>·</span>
<span class=reading-time>4 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>在 <a href=https://yushuanhsieh.github.io/post/2020-04-15-transfer-sh-refactor/>Trace transfer.sh open project</a> 有提到我目前正在調整 <a href=https://github.com/dutchcoders/transfer.sh>transfer.sh</a> 這個 open source project，把它修改成內部所需要的一個 service，而之前已經改得差不多了，所以簡單地來介紹一下修改了哪些內容：</p><h2 id=需求>需求</h2><ol><li>每個 download request 能依需求驗證 IP address 和 user account / password</li><li>能使用外部 service 來驗證 user account</li><li>需能支援 curl cmd tool</li><li>k8s deployment</li></ol><h2 id=修改項目>修改項目</h2><h3 id=1-middleware-chain>1. Middleware Chain</h3><p>根據需求 1，在 <code>getHandler</code> 前加入 middleware chain，其中包含：</p><ul><li>從 metadata storage 中取出 metadata 並放到 context 中</li><li>IP address 驗證 (optional)</li><li>HTTP basic authentication (optional)</li></ul><p>之所以使用 HTTP basic authentication 是因為部分用戶可能會直接使用 curl 下載，那麼用 HTTP basic authentication 流程較簡單又方便，缺點是在瀏覽器上操作會跳出預設的 basic authentication 介面，看起來有點醜。</p><p><a href=https://github.com/YuShuanHsieh/transfer.sh/blob/master/server/server.go#L230>source code</a></p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>r</span><span style=color:#1f2328>.</span><span style=color:#6639ba>HandleFunc</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/{token}/{filename}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>s</span><span style=color:#1f2328>.</span><span style=color:#6639ba>AssignMetadata</span><span style=color:#1f2328>(</span><span style=color:#6639ba>MetadataAllowedIP</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>.</span><span style=color:#6639ba>MetadataBasicAuth</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>HandlerFunc</span><span style=color:#1f2328>(</span><span style=color:#1f2328>getHandlerFn</span><span style=color:#1f2328>)))),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>).</span><span style=color:#6639ba>Methods</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;GET&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-authenticator-interface>2. Authenticator interface</h3><p>增加 <code>Authenticator</code> interface，這樣就可以選擇是要透過 metadata 中的 username / password 來進行驗證，還是要使用 API 連結到其他 service 進行驗證。（目前也只實作 metadata 和API 兩個 Authenticators XD）</p><p>另外，在 API Authenticator 也可以自行加入想要的 header，這是因為在 cloud service 間可能會透過 api-key 這種方式來進行 request 驗證，所以 header 設定還是有其必要。</p><h3 id=3-metadata>3. Metadata</h3><p>request 驗證規則會儲存在 metadata 中。原本 project 就有 metadata 的設計，其內容是放置 delete code、到期日期、下載次數等。而在這次修改中則是增加了 <code>AuthTypes</code> <code>user</code> <code>password</code> <code>IP</code> <code>net</code> 等欄位，讓我們可以進行 IP filter 和 basic authentication。</p><p>正也因為 metadata 放入了驗證規則，每次 request 就必須取出對應的 metadata，因此原設計是將 metadata 存放在檔案內，現在看起來會有點不適用。在考量 metadata 的 bytes size 不大，放在 memory 中是一個可行的方式，所以額外增加了 metadata storage，並且實作了 redis storage，來加快 metadata 讀取速度。</p><h3 id=4-cmd-options>4. Cmd Options</h3><p>由於上面的新增項目，因此也在 cmd options 中增加對應的參數設定，並且也增加 environment variable，方便後續 deploy 。</p><table><thead><tr><th>Parameter</th><th>Description</th><th>Value</th><th>Env</th></tr></thead><tbody><tr><td>api-endpoint</td><td>the endpoint for api authenticator</td><td></td><td>API_ENDPOINT</td></tr><tr><td>api-headers</td><td>the HTTP(s) headers for api authenticator</td><td></td><td>API_HEADERS</td></tr><tr><td>meta-provider</td><td>which storage provider to use</td><td>(s3, gdrive, local, redis)</td><td></td></tr><tr><td>redis-addr</td><td>The address of redis server</td><td>localhost:6379</td><td>REDIS_ADDR</td></tr><tr><td>redis-pwd</td><td>The password of redis server</td><td></td><td>REDIS_PWD</td></tr></tbody></table><h2 id=usage>Usage</h2><p><a href=https://hub.docker.com/r/cjamhe01385/transfer>Container: cjamhe01385/transfer</a></p><p>提供 container 試用：</p><ul><li>啟動 container</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -p 8080:8080 cjamhe01385/transfer:latest --listener<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;:8080&#34;</span> --provider<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;local&#34;</span> --basedir<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;/data&#34;</span> --http-auth-user<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;user&#34;</span> --http-auth-pass<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;password&#34;</span> --meta-provider<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;redis&#34;</span> --redis-addr<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;redis:6379&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>在上傳檔案同時加入驗證規則
(記得如果 payload 有 password 要使用 HTTPS 唷 &lt;3 )</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST -H <span style=color:#0a3069>&#34;Content-Type: multipart/form-data&#34;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>-F <span style=color:#0a3069>&#34;user=user&#34;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>-F <span style=color:#0a3069>&#34;password=password&#34;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>-F <span style=color:#0a3069>&#34;file=@./examples.md&#34;</span> <span style=color:#0a3069>&#34;https://&lt;web server&gt;/examples.md&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=source-code>source code</h2><p><a href=https://github.com/YuShuanHsieh/transfer.sh>transfer.sh</a></p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-04-29-hugo-symlinks/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Side Project - Symlink Generator for Multi-lang Hugo Site</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-05-28-ingress-gce/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Introduction to ingress-gce controller</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>