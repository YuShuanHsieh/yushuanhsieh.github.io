<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Go string to slice 議題 — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Go string to slice 議題</h1><div class=post-meta><time datetime=2020-06-01>June 1, 2020</time>
<span class=separator>·</span>
<span class=reading-time>4 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>日前在看 Go runtime/string.go source code 的時候，意外看到一篇文章 <a href=https://www.cnblogs.com/mushroom/p/8998538.html>Go中string转[]byte的陷阱</a>，不過這篇文章的日期間隔已久，Go version 也從文章中的 1.10 改版到 1.14 了，所以想要更新一下這個議題現況。</p><p><img src=/posts/string-to-slice.png alt=hugo></p><h2 id=version>Version</h2><p>Go version: 1.14</p><h2 id=問題摘要>問題摘要</h2><h3 id=1-runtimestringtoslicebyte>1. runtime.stringtoslicebyte</h3><p>首先，文章中提到的例子：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#6639ba>byte</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>s1</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>append</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;a&#39;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>s2</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>append</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;b&#39;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>//fmt.Println(s1, &#34;==========&#34;, s2)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#6639ba>string</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s1</span><span style=color:#1f2328>),</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;==========&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#6639ba>string</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s2</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>在沒有 <code>fmt.Println(s1, "==========", s2)</code> 這一行的情況下，output 會產生：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>b <span style=color:#0550ae>==========</span> b
</span></span></code></pre></td></tr></table></div></div><p>的結果。</p><p>反之，如果加了 <code>fmt.Println(s1, "==========", s2)</code> ，由於 <strong>Escape Analysis</strong> 的關係，因此結果會變成：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>a <span style=color:#0550ae>==========</span> b
</span></span></code></pre></td></tr></table></div></div><p>此陷阱是由於在一開始宣告 byte slice 時，是由 string 轉換成 slice</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#6639ba>byte</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>這樣的寫法會觸發 <code>runtime.stringtoslicebyte</code> ，細究此 function：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>stringtoslicebyte</span><span style=color:#1f2328>(</span><span style=color:#1f2328>buf</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>tmpBuf</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#cf222e>string</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>buf</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;&amp;</span><span style=color:#fff> </span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>&lt;=</span><span style=color:#fff> </span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>buf</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0550ae>*</span><span style=color:#1f2328>buf</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>tmpBuf</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>buf</span><span style=color:#1f2328>[:</span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>)]</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>rawbyteslice</span><span style=color:#1f2328>(</span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#6639ba>copy</span><span style=color:#1f2328>(</span><span style=color:#1f2328>b</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>s</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>會發現 escape analysis 結果 (<code>buf != nil</code>) 有可能影響最後回傳的 []byte slice，進而導致後續 slice append 行為不同。</p><h3 id=2-byte-slice-initialization>2. byte slice initialization</h3><p>另外，在 issue <a href=https://github.com/golang/go/issues/26498>cmd/compile: constant string -> []byte and []byte -> string conversions aren&rsquo;t constant folded</a> 中也提到 byte 的行為不一致：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>a</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#6639ba>byte</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;foo&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>{</span><span style=color:#0a3069>&#39;f&#39;</span><span style=color:#1f2328>,</span><span style=color:#0a3069>&#39;o&#39;</span><span style=color:#1f2328>,</span><span style=color:#0a3069>&#39;o&#39;</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>因為前者 a 會觸發 <code>runtime.stringtoslicebyte</code> 的關係，所以 <code>[]byte("foo")</code> 比起 <code>[]byte{'f','o','o'}</code> 需要額外的執行成本，但是對使用者來說， <code>[]byte("foo")</code> 應該是更常見的寫法。</p><h2 id=optimization>Optimization</h2><p>因此，在 <a href=https://github.com/golang/go/commit/ceb0c371d9a535826497289ac7d0b206a59526e6>cmd/compile: make []byte("&mldr;") more efficient</a> 這項 commit 就針對</p><p><code>[]byte(string) conversions</code></p><p>行為做改進，不再使用 <code>stringtoslicebyte</code> ，而是定義一個與 string 相同長度的 byte array (記憶體空間根據 escape analysis 可能在 heap 或是 goroutine stack)，並且使用 string 來將此 array 初始化，再轉換成 slice 回傳。</p><p>實作方式可參閱下面的 asm code，可以看到已和陷阱文章中所提到的 asm code 有明顯差異。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// s := []byte(&#34;abc&#34;)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0021</span> <span style=color:#0550ae>00033</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0021</span> <span style=color:#0550ae>00033</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0021</span> <span style=color:#0550ae>00033</span>	LEAQ	type<span style=color:#1f2328>.[</span><span style=color:#0550ae>3</span><span style=color:#1f2328>]</span><span style=color:#6639ba>uint8</span><span style=color:#1f2328>(</span>SB<span style=color:#1f2328>),</span> AX
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0028</span> <span style=color:#0550ae>00040</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0028</span> <span style=color:#0550ae>00040</span>	MOVQ	AX<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span>SP<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x002c</span> <span style=color:#0550ae>00044</span>	CALL	runtime<span style=color:#1f2328>.</span><span style=color:#6639ba>newobject</span><span style=color:#1f2328>(</span>SB<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0031</span> <span style=color:#0550ae>0004</span><span style=color:#0550ae>9</span>	PCDATA	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0031</span> <span style=color:#0550ae>0004</span><span style=color:#0550ae>9</span>	MOVQ	<span style=color:#0550ae>8</span><span style=color:#1f2328>(</span>SP<span style=color:#1f2328>),</span> AX
</span></span><span style=display:flex><span><span style=color:#0550ae>0x0036</span> <span style=color:#0550ae>00054</span>	MOVW	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>25185</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span>AX<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>0x003b</span> <span style=color:#0550ae>0005</span><span style=color:#0550ae>9</span>	MOVB	<span style=color:#f6f8fa;background-color:#82071e>$</span><span style=color:#0550ae>99</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>(</span>AX<span style=color:#1f2328>)</span>
</span></span></code></pre></td></tr></table></div></div><p>這樣的更動自然地也就消除了一開始所提到的 string 轉 byte slice 陷阱，自 <strong>Go 1.12</strong> 版本之後，<code>[]byte(string)</code> 會回傳 cap, len 值皆為 string 長度的 byte slice，而不會受到 <code>runtime.stringtoslicebyte</code> 邏輯因素而產生 cap 為 32 的 slice (具體內容可詳見<a href=https://www.cnblogs.com/mushroom/p/8998538.html>Go中string转[]byte的陷阱</a>)。</p><h2 id=總結>總結</h2><p>由於改善 <code>[]byte(string)</code> 的 compile 結果，也消除了之前可能會遇到的陷阱，這其中從發現問題到修改過程都有值得讓人好好學習的知識和概念。</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-05-28-ingress-gce/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Introduction to ingress-gce controller</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-06-24-strings-builder/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Escape analysis issues of strings builder</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>