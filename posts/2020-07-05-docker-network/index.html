<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Cross-Network Container Communication — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Cross-Network Container Communication</h1><div class=post-meta><time datetime=2020-07-05>July 5, 2020</time>
<span class=separator>·</span>
<span class=reading-time>13 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/network/>Network</a>
<a href=https://yushuanhsieh.github.io/categories/docker/>Docker</a></div></header><div class=post-content><p>在 Docker 的網路規則中，由於 <code>DOCKER-ISOLATION-STAGE-1</code>、<code>DOCKER-ISOLATION-STAGE-2</code> 兩個 iptables chain 的關係，因此不同 Docker network 連結的 container 是無法互相溝通的。不過，我們可以透過建立 router 的手段來規避掉 chain 的限制，讓 container 收到其他 container 來的packages。此方式涉及到 <code>Linux Bridge</code> 處理封包的方式和基本網路知識，希望透過此介紹，來更了解 network stack 與 packages 處理流程。</p><h2 id=docker-container-network>Docker Container Network</h2><p>我們知道，Docker 的網路實現是基於 Linux network namespace，Linux network bridge，與 virtual ethernet device 所架構而成的(可參閱 <a href=https://success.docker.com/article/networking#linuxnetworkfundamentals>Linux Network Fundamentals</a>)。</p><p>假設我們建立兩個 container，一個連結自定義網路(User-Defined Bridge Networks) host1 與連結預設網路的 host2：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker network create h1r1br
</span></span><span style=display:flex><span>sudo docker run -d -it --network h1r1br --rm --name h1 ubuntu:16.04
</span></span><span style=display:flex><span>sudo docker run -d -it --rm --name h2 ubuntu:16.04
</span></span></code></pre></td></tr></table></div></div><p>其結構圖示如下：</p><p><img src=/posts/docker-network_1.png alt=hugo></p><p>我們可以使用 <code>brctl</code> 來查看 bridge 和 veth 關係</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>yu-shuan@:~$ brctl show
</span></span><span style=display:flex><span>bridge name	bridge id		STP enabled	interfaces
</span></span><span style=display:flex><span>br-0e510c1eeb44	 8000.02429a48a474	no		veth8b7aaa8
</span></span><span style=display:flex><span>docker0		         8000.024288b35644	no		vethfa6f0c4
</span></span></code></pre></td></tr></table></div></div><p>也可以用 <code>ifconfig</code> 來查看 bridge 與 veth 的資訊</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>yu-shuan@:~$ ifconfig br-0e510c1eeb44
</span></span><span style=display:flex><span>br-0e510c1eeb44: <span style=color:#953800>flags</span><span style=color:#0550ae>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style=color:#0550ae>1500</span>
</span></span><span style=display:flex><span>        inet 172.22.0.1  netmask 255.255.0.0  broadcast 172.22.255.255
</span></span><span style=display:flex><span>        inet6 fe80::42:9aff:fe48:a474  prefixlen <span style=color:#0550ae>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style=display:flex><span>        ether 02:42:9a:48:a4:74  txqueuelen <span style=color:#0550ae>0</span>  <span style=color:#0550ae>(</span>Ethernet<span style=color:#0550ae>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我們進入 <code>host1</code> container，來看 routing 設定：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>root@fb1431179a56:/# ip route
</span></span><span style=display:flex><span>default via 172.22.0.1 dev eth0
</span></span><span style=display:flex><span>172.22.0.0/16 dev eth0  proto kernel  scope link  src 172.22.0.2
</span></span></code></pre></td></tr></table></div></div><p>由於 host1 只有一個 interface，因此無論 Dst IP 是什麼，都會從 eth0 出去，而 host2 也同理。</p><h2 id=connection-test>Connection Test</h2><h3 id=case-1-host1-connects-to-the-internet>Case 1: host1 connects to the internet</h3><p>接著我們看一下從 host1 container 是如何與外部 internet 聯繫的。我們從 host1 container ping google server (169.254.169.254)。</p><p><img src=/posts/docker-network_2.png alt=hugo></p><p>從 host1 發送 icmp 封包，由於沒有 169.254.169.254 的 MAC 資訊，因此將封包轉送到 default gateway(dst_Mac 改成 gatyeway 的 mac address)，也就是 bridge br-0e510c1eeb44(h1r1br)，從 eth0 出去。</p><p>當封包抵達 bridge br-0e510c1eeb44 後，就是在本機端處理此封包，因此會使用本機端的 iptable 設定。同樣地，由於沒有 169.254.169.254 的資訊，因此會轉發到本機設定的 default gateway，並檢查 filter table 中的對應 rules，最後發送到外部網路。</p><h3 id=case-2-host11722202-ping-host21721702>Case 2: host1(172.22.0.2) ping host2(172.17.0.2)</h3><p>再來討論 host1 ping host2 的場景～我們第一直覺就能夠判斷一定不能通。那為什麼不能通呢？</p><p>封包處理流程跟上面第一個例子相似， icmp 封包會被轉發到本機端，其中最大的差別在於：<strong>此 icmp 封包會被 filter.FORWARD table Drop 掉</strong>，因此就無法將封包發送到目標 host2 container 中。</p><p>透過 iptables command-lin tool 來查看 table 設定：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>yu-shuan@:~$ sudo iptables -nL --line-numbers -v -t filter
</span></span><span style=display:flex><span>Chain INPUT <span style=color:#0550ae>(</span>policy ACCEPT <span style=color:#0550ae>1921</span> packets, 227K bytes<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>1</span>     199K 1215M sshguard   all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Chain FORWARD <span style=color:#0550ae>(</span>policy DROP <span style=color:#0550ae>0</span> packets, <span style=color:#0550ae>0</span> bytes<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>1</span>    <span style=color:#0550ae>49568</span>   61M DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>2</span>    <span style=color:#0550ae>49568</span>   61M DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Chain DOCKER-ISOLATION-STAGE-1 <span style=color:#0550ae>(</span><span style=color:#0550ae>1</span> references<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>1</span>     <span style=color:#0550ae>9119</span>  499K DOCKER-ISOLATION-STAGE-2  all  --  br-0e510c1eeb44 !br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>2</span>     <span style=color:#0550ae>4729</span>  252K DOCKER-ISOLATION-STAGE-2  all  --  br-5004af5170da !br-5004af5170da  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>3</span>       <span style=color:#0550ae>78</span> <span style=color:#0550ae>18422</span> DOCKER-ISOLATION-STAGE-2  all  --  br-a0789b166030 !br-a0789b166030  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>4</span>      <span style=color:#0550ae>901</span> <span style=color:#0550ae>48486</span> DOCKER-ISOLATION-STAGE-2  all  --  br-e7d606a081d9 !br-e7d606a081d9  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>5</span>        <span style=color:#0550ae>0</span>     <span style=color:#0550ae>0</span> DOCKER-ISOLATION-STAGE-2  all  --  br-e0e7a31ff7d4 !br-e0e7a31ff7d4  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>6</span>    <span style=color:#0550ae>70549</span> 8287K DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>7</span>    1161K  805M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Chain DOCKER-ISOLATION-STAGE-2 <span style=color:#0550ae>(</span><span style=color:#0550ae>6</span> references<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>1</span>        <span style=color:#0550ae>0</span>     <span style=color:#0550ae>0</span> DROP       all  --  *      br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>2</span>        <span style=color:#0550ae>0</span>     <span style=color:#0550ae>0</span> DROP       all  --  *      br-5004af5170da  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>3</span>        <span style=color:#0550ae>0</span>     <span style=color:#0550ae>0</span> DROP       all  --  *      br-a0789b166030  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>4</span>       <span style=color:#0550ae>31</span> <span style=color:#0550ae>15348</span> DROP       all  --  *      br-e7d606a081d9  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>5</span>        <span style=color:#0550ae>6</span>   <span style=color:#0550ae>504</span> DROP       all  --  *      br-e0e7a31ff7d4  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>6</span>        <span style=color:#0550ae>2</span>   <span style=color:#0550ae>168</span> DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span style=display:flex><span><span style=color:#0550ae>7</span>    <span style=color:#0550ae>85337</span> 9089K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></td></tr></table></div></div><p>封包會進入 <code>DOCKER-ISOLATION-STAGE-1</code>，接著 match 到其中 number 1 的 rule</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Chain DOCKER-ISOLATION-STAGE-1 <span style=color:#0550ae>(</span><span style=color:#0550ae>1</span> references<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>1</span>     <span style=color:#0550ae>9119</span>  499K DOCKER-ISOLATION-STAGE-2  all  --  br-0e510c1eeb44 !br-0e510c1eeb44  0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></td></tr></table></div></div><p>最後進入 <code>DOCKER-ISOLATION-STAGE-2</code>，match 到 number 6 的 rule，封包被 Drop 掉。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Chain DOCKER-ISOLATION-STAGE-2 <span style=color:#0550ae>(</span><span style=color:#0550ae>6</span> references<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>num   pkts bytes target     prot opt in     out     <span style=color:#6639ba>source</span>               destination
</span></span><span style=display:flex><span><span style=color:#0550ae>6</span>        <span style=color:#0550ae>2</span>   <span style=color:#0550ae>168</span> DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></td></tr></table></div></div><h2 id=cross-network-container-communication-via-a-router>Cross-Network Container Communication via a Router</h2><p>如果要讓兩個分別在不同 bridge 的 container 互相溝通，最重要的是如何符合 docker 本身在 iptables 所設定的規則。而在實體網路中，我們會使用 router 來連結兩個網段的網路，相同的概念也可以應用在 docker container 上，以實現跨 network bridge 溝通的目的。</p><p>首先，我們先起一個 router container，並且使用不同的 network 把 host1、host2、與 router 連結在一起。</p><p><img src=/posts/docker-network_3.png alt=hugo></p><p>如此一來，host1 的封包可以透過 h1r1br Bridge 傳送到 router1 ，接著再經過 docker0 bridge 將封包從 router1 傳送到 host2。</p><p>當然，只是將 router 1 連結 host1、host2 還不夠，我們還要設定 host1、host2 的 default gateway，這樣才能確保封包能正確地走到 router1 再傳出去。</p><p>Host1</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>ip route del default
</span></span><span style=display:flex><span>ip route add default via 172.22.0.3
</span></span></code></pre></td></tr></table></div></div><p>Host2</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>ip route del default
</span></span><span style=display:flex><span>ip route add default via 172.17.0.3
</span></span></code></pre></td></tr></table></div></div><p>經過這樣的調整後，封包處理流程會變成：</p><p><img src=/posts/docker-network_4.png alt=hugo></p><ol><li>host1 ping <code>172.17.0.2</code> (host2)</li><li>host1 routing table 沒有 172.17.0.0/16 的資訊，走 default gatway</li><li>default gatway 被設定為 <code>172.22.0.3</code> 因此 dst_mac 會變成 router1 eth0 的 mac address(如果 host1 的 arp table 沒有紀錄 <code>172.22.0.3</code> mac address，則 host1 會發送 <strong>ARP request</strong> 去詢問，而因為 <code>172.22.0.3</code> 在同一個 bridge 上，因此可以得到 ARP response)</li><li>封包傳送至 h1r1br Bridge，而由於 dst_mac <strong>不是</strong> h1r1br Bridge 的 mac address，且 <code>dst_mac</code> <code>src_mac</code> interface 皆在同一個 bridge 上，因此符合 docker 網路規範，封包不會被 drop 掉。</li></ol><h3 id=the-importance-of-bridges-decision>The importance of bridge&rsquo;s decision</h3><p>這裡有一個<strong>非常重要</strong>的概念，就是封包的 dst_mac mac address 會影響 Linux Bridge 處理封包的流程。根據 <a href=http://ebtables.netfilter.org/br_fw_ia/br_fw_ia.html>ebtables/iptables interaction on a Linux-based bridge</a> 中有提到：</p><p>The bridge&rsquo;s decision for a frame can be one of these:</p><ul><li>bridge it, if the destination MAC address is <strong>on another side of the bridge</strong>;</li><li>flood it over all the forwarding bridge ports, if the position of the box with the destination MAC is unknown to the bridge;</li><li>pass it to the higher protocol code (the IP code), if the destination MAC address is <strong>that of the bridge or of one of its ports</strong>;</li><li>ignore it, if the destination MAC address is located <strong>on the same side of the bridge</strong>.</li></ul><p>如果我們<strong>沒有</strong>設定 host1 的 default gateway 是 router1 的 eth0，那麼 default gateway 的 mac address 就會變成 h1r1br Bridge 的 mac address，並且根據上面 bridge&rsquo;s decision 所描述，會將封包 <strong>pass 到 IP Network Layer</strong>， 接著根據 <strong>routing table</strong> 來決定 output interface，此時 dst_mac mac address 就會變成 docker0，最後就會在 filter.FORWARD 階段被 Drop 掉。</p><h3 id=etableiptable-logs>etable/iptable Logs</h3><p>我們從 log 來確認剛剛的敘述是否正確。</p><ul><li>Default Gateway is router1 eth0</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817044<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>raw.PREROUTING<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-0e510c1eeb44 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span> <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:ac:16:00:03:02:42:ac:16:00:02:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64082</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1164</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817061<span style=color:#0550ae>]</span> TRACE: eb:filter:FORWARD <span style=color:#953800>IN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>veth6d5ff81 MAC <span style=color:#6639ba>source</span> <span style=color:#0550ae>=</span> 02:42:ac:16:00:02 MAC <span style=color:#953800>dest</span> <span style=color:#0550ae>=</span> 02:42:ac:16:00:03 <span style=color:#953800>proto</span> <span style=color:#0550ae>=</span> 0x0800 IP <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 IP <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2, IP <span style=color:#953800>tos</span><span style=color:#0550ae>=</span>0x00, IP <span style=color:#953800>proto</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817070<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>filter.FORWARD<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-0e510c1eeb44 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>br-0e510c1eeb44 <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>PHYSOUT</span><span style=color:#0550ae>=</span>veth6d5ff81 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:ac:16:00:03:02:42:ac:16:00:02:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64082</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1164</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817130<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>raw.PREROUTING<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-5004af5170da <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span> <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth83ddfd8 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:ac:15:00:02:02:42:ac:15:00:03:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>63</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64082</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1164</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817134<span style=color:#0550ae>]</span> TRACE: eb:filter:FORWARD <span style=color:#953800>IN</span><span style=color:#0550ae>=</span>veth83ddfd8 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>veth56a6af1 MAC <span style=color:#6639ba>source</span> <span style=color:#0550ae>=</span> 02:42:ac:15:00:03 MAC <span style=color:#953800>dest</span> <span style=color:#0550ae>=</span> 02:42:ac:15:00:02 <span style=color:#953800>proto</span> <span style=color:#0550ae>=</span> 0x0800 IP <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 IP <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2, IP <span style=color:#953800>tos</span><span style=color:#0550ae>=</span>0x00, IP <span style=color:#953800>proto</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817141<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>filter.FORWARD<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-5004af5170da <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>br-5004af5170da <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth83ddfd8 <span style=color:#953800>PHYSOUT</span><span style=color:#0550ae>=</span>veth56a6af1 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:ac:15:00:02:02:42:ac:15:00:03:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>63</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64082</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1164</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817209<span style=color:#0550ae>]</span> TRACE: eb:filter:FORWARD <span style=color:#953800>IN</span><span style=color:#0550ae>=</span>veth56a6af1 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>veth83ddfd8 MAC <span style=color:#6639ba>source</span> <span style=color:#0550ae>=</span> 02:42:ac:15:00:02 MAC <span style=color:#953800>dest</span> <span style=color:#0550ae>=</span> 02:42:ac:15:00:03 <span style=color:#953800>proto</span> <span style=color:#0550ae>=</span> 0x0800 IP <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.21.0.2 IP <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.22.0.2, IP <span style=color:#953800>tos</span><span style=color:#0550ae>=</span>0x00, IP <span style=color:#953800>proto</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 06:56:45 sdn-experi-project kernel: <span style=color:#0550ae>[</span>313896.817220<span style=color:#0550ae>]</span> TRACE: eb:filter:FORWARD <span style=color:#953800>IN</span><span style=color:#0550ae>=</span>veth6d5ff81 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>veth8b7aaa8 MAC <span style=color:#6639ba>source</span> <span style=color:#0550ae>=</span> 02:42:ac:16:00:03 MAC <span style=color:#953800>dest</span> <span style=color:#0550ae>=</span> 02:42:ac:16:00:02 <span style=color:#953800>proto</span> <span style=color:#0550ae>=</span> 0x0800 IP <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.21.0.2 IP <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.22.0.2, IP <span style=color:#953800>tos</span><span style=color:#0550ae>=</span>0x00, IP <span style=color:#953800>proto</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Default Gateway is h1r1br Bridge</li></ul><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 07:06:23 sdn-experi-project kernel: <span style=color:#0550ae>[</span>314474.517447<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>raw.PREROUTING<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-0e510c1eeb44 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span> <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:9a:48:a4:74:02:42:ac:16:00:02:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>64</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>52580</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1180</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 07:06:23 sdn-experi-project kernel: <span style=color:#0550ae>[</span>314474.517594<span style=color:#0550ae>]</span> TRACE: eb:filter:INPUT <span style=color:#953800>IN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span> MAC <span style=color:#6639ba>source</span> <span style=color:#0550ae>=</span> 02:42:ac:16:00:02 MAC <span style=color:#953800>dest</span> <span style=color:#0550ae>=</span> 02:42:9a:48:a4:74 <span style=color:#953800>proto</span> <span style=color:#0550ae>=</span> 0x0800 IP <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 IP <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2, IP <span style=color:#953800>tos</span><span style=color:#0550ae>=</span>0x00, IP <span style=color:#953800>proto</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>Jul  <span style=color:#0550ae>6</span> 07:06:23 sdn-experi-project kernel: <span style=color:#0550ae>[</span>314474.517622<span style=color:#0550ae>]</span> <span style=color:#0550ae>[</span>filter.FORWARD<span style=color:#0550ae>]</span><span style=color:#953800>IN</span><span style=color:#0550ae>=</span>br-0e510c1eeb44 <span style=color:#953800>OUT</span><span style=color:#0550ae>=</span>br-5004af5170da <span style=color:#953800>PHYSIN</span><span style=color:#0550ae>=</span>veth8b7aaa8 <span style=color:#953800>MAC</span><span style=color:#0550ae>=</span>02:42:9a:48:a4:74:02:42:ac:16:00:02:08:00 <span style=color:#953800>SRC</span><span style=color:#0550ae>=</span>172.22.0.2 <span style=color:#953800>DST</span><span style=color:#0550ae>=</span>172.21.0.2 <span style=color:#953800>LEN</span><span style=color:#0550ae>=</span><span style=color:#0550ae>84</span> <span style=color:#953800>TOS</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>PREC</span><span style=color:#0550ae>=</span>0x00 <span style=color:#953800>TTL</span><span style=color:#0550ae>=</span><span style=color:#0550ae>63</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>52580</span> DF <span style=color:#953800>PROTO</span><span style=color:#0550ae>=</span>ICMP <span style=color:#953800>TYPE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>8</span> <span style=color:#953800>CODE</span><span style=color:#0550ae>=</span><span style=color:#0550ae>0</span> <span style=color:#953800>ID</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1180</span> <span style=color:#953800>SEQ</span><span style=color:#0550ae>=</span><span style=color:#0550ae>1</span>
</span></span></code></pre></td></tr></table></div></div><p>比對 netfilter package flow：</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg alt></p><p>可以看到最重要的差異在於 default gateway 是 router1 eth0 的時候，會走 <code>bridge-level filter.FORWARD</code>，反之如果是 h1r1br Bridge， 則會走 <code>bridge-level filter.INPUT</code> 並經過 routing decision，而造成此差異的原因就在於 <strong>bridge&rsquo;s decision</strong>。</p><h2 id=結論>結論</h2><p>我們使用 router 的方式來實現 cross-network container communication，由於 Docker container network 結合 linux bridge 來實作網路模型，因此上述透過實驗來驗證封包在 bridge 的流向和處理方式，了解這樣的流程，對於未來在 debug 相關議題上都非常有幫助。</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-06-25-study-05/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>2020/05 月份自我學習回顧</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-08-04-coscup-go/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>COSCUP 2020 - Goroutine stack and local variable allocation in Go</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>