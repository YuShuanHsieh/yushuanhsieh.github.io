<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>CSE 506 Lab 環境建置 — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>CSE 506 Lab 環境建置</h1><div class=post-meta><time datetime=2020-08-24>August 24, 2020</time>
<span class=separator>·</span>
<span class=reading-time>4 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/operating-system/>Operating System</a></div></header><div class=post-content><h2 id=前言>前言</h2><p>由於下學期要上計算機結構的課程，所以趁著開課之前來複習一下 OS。這次看的課程是 UNC Operating System Implementation，基本上這課程也是引用 MIT 知名的 JOS 實作，再加上清楚明瞭的 Slides，光是一堂課就能有蠻多地收穫。</p><p>這次先來記錄一下實作 Lab1 所遇到的一些問題和環境建立過程。不得不說這課程的環境建置說明沒有很清楚，所以浪費了一些時間在配置正確環境和編譯器。</p><h2 id=環境建立>環境建立</h2><p>Host: MacPro macOS 10.15.6</p><h3 id=tools>Tools</h3><ul><li>VSCode</li><li>Vagrant</li><li>VirtualBox</li><li>Ubuntu 16.04 64 bit</li><li>GNU binutils:2.19</li><li>GNU gcc:4.1.2</li><li>GNU GDB 7.7.1 (要下載 source code 並且修改檔案)</li><li>MIT版 Qemu <code>https://github.com/geofft/qemu.git -b 6.828-1.7.0</code></li></ul><h4 id=vagrant-configuration>Vagrant Configuration</h4><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>config.vm.box <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;ubuntu/xenial64&#34;</span>
</span></span><span style=display:flex><span>  config.vm.provider <span style=color:#0a3069>&#34;virtualbox&#34;</span> <span style=color:#cf222e>do</span> <span style=color:#1f2328>|</span>vb<span style=color:#1f2328>|</span>
</span></span><span style=display:flex><span>    vb.customize <span style=color:#0550ae>[</span><span style=color:#0a3069>&#34;modifyvm&#34;</span>, :id, <span style=color:#0a3069>&#34;--nested-hw-virt&#34;</span>, <span style=color:#0a3069>&#34;on&#34;</span><span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span>  end
</span></span><span style=display:flex><span>end
</span></span></code></pre></td></tr></table></div></div><p>環境配置是在 VM 中跑 Qemu + KVM ，因此在設定 configuration 時，要將 VritualBox 的 <code>nested-hw-virt</code> 開啟。</p><p>Ubuntu 版本我是採用 <code>16.04 64 bit</code>，主要是這個版本在編譯時不會有太多問題，我曾經使用 14.0.4 版本，但是在啟動 Qemu + KVM 時會出現 KVM entry error，而更新的版本 18.04 等會出現各種編譯錯誤和 boot block 過大問題，在百般嘗試之下後，認為 16.04 64 bit 相對穩定。</p><h4 id=編譯編譯器>編譯編譯器(?)</h4><p>在進入 VM 之後，就開始下載需要的 GNU source code 並且進行編譯。</p><p>如果在課程文件，會發現 script 都是直接在 source code 底下 configuration 接著編譯，但不推薦這樣的做法，因為有可能會出現編譯錯誤。所以最好還是新建一個 folder ，然後在新的 folder 下
configuration，可以參考 <a href=https://www.danirod.es/blog/2015/i386-elf-gcc-on-mac>Installing i386-elf-gcc on MacOS X</a> 的 script 方式。</p><ol><li>binutils</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>../binutils-2.19/configure --target<span style=color:#0550ae>=</span>i386-jos-elf --disable-nls --disable-multilib --disable-werror
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>gcc</li></ol><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>../gcc-4.1.2/configure --target<span style=color:#0550ae>=</span>i386-jos-elf --disable-nls --without-headers <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>    --with-newlib --disable-threads --disable-shared <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>    --disable-libmudflap --disable-libssp --disable-werror --disable-multilib
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>gdb</li></ol><p>下載 source code 之後，需要修改 <code>gdb/remote.c</code> file 的內容，才能正確地處理轉換到 long mode (64bit) 的問題。詳細修改內容請參考 <a href=https://www.cs.unc.edu/~porter/courses/comp790/s20/gdb-7.7.1-mute-message-too-long.patch>patch</a></p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>../gdb-7.7.1/configure --target<span style=color:#0550ae>=</span>x86_64-linux-gnu <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>    --program-prefix<span style=color:#0550ae>=</span>x86_64-jos-elf- --enable-targets<span style=color:#0550ae>=</span>all --disable-werror 
</span></span></code></pre></td></tr></table></div></div><p>我的 script 和課程文件寫的有些不同，主要是我的主機不是 amd64 ，會需要 <code>--enable-targets</code> 。</p><ol start=4><li>MIT qemu</li></ol><p>在編譯前，先下載需要的 libs</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install -y zlib1g-dev libpixman-1-dev <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span>    pkg-config libglib2.0-dev  libsdl1.2-dev
</span></span></code></pre></td></tr></table></div></div><p>接著編譯</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>./configure --target-list<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;i386-softmmu x86_64-softmmu&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=vscode-remote-ssh>VSCode remote-SSH</h4><p>編譯好工具之後，接著設定 VSCode，這樣就可以直接在 host 上編寫 code。</p><p>首先要取得 private key 位置和 port</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>vagrant ssh-config
</span></span></code></pre></td></tr></table></div></div><p>然後把 private key 位置設定在 remote-ssh configuration 裡面，這樣 VSCode 就可以連進去 VM 中。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>Host 127.0.0.1
</span></span><span style=display:flex><span>  Port &lt;port&gt;
</span></span><span style=display:flex><span>  HostName 127.0.0.1
</span></span><span style=display:flex><span>  IdentityFile &lt;path&gt;
</span></span><span style=display:flex><span>  User vagrant
</span></span></code></pre></td></tr></table></div></div><p>這樣整個環境就算搭建完成了，目前使用到現在，不論是跑 qemu 或是 gdb breakpoint 都沒有太大問題。</p><h2 id=course-information>Course Information</h2><p><a href=https://www.cs.unc.edu/~porter/courses/comp790/s20/tools.html>COMP 790, Spring 2020: Operating System Implementation</a></p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-08-04-coscup-go/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>COSCUP 2020 - Goroutine stack and local variable allocation in Go</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-08-25-comp790-lab1/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>CSE 506 Lab1 - The Stack</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>