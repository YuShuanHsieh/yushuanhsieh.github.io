<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Vault Initialization and Keys Security — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Vault Initialization and Keys Security</h1><div class=post-meta><time datetime=2020-09-04>September 4, 2020</time>
<span class=separator>·</span>
<span class=reading-time>16 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a>
<a href=https://yushuanhsieh.github.io/categories/devops/>DevOps</a></div></header><div class=post-content><h2 id=預備知識>預備知識</h2><p>在閱讀下方內容之前，建議先對 Vault 架構有個基本了解，相關官方文章如下：</p><ol><li><a href=https://www.vaultproject.io/docs/internals/architecture>Vault Architecture</a></li><li><a href=https://www.vaultproject.io/docs/internals/rotation>Vault Key Rotation</a></li><li><a href=https://www.vaultproject.io/docs/concepts/seal>Vault Seal/Unseal</a></li></ol><p>另外， <code>Barrier</code> 這個元件在 Vault 相當重要，在 <a href=https://www.vaultproject.io/docs/internals/architecture>Vault Architecture</a> 頁面中有提及，可以先了解其用意，再來看它是如何被實現。</p><h2 id=問題>問題</h2><p>Vault 在進行 unseal 流程時，其中最重要的就是將加密過的 master key 解密，接著再利用 master key 解出 encryption Key，並且建立起 barrier 防護，讓 storage backend 的資料可以安全地來往於 Vault server 與 storage backend 之間。</p><p>其中，基於安全考量，我們想要確認幾件事情：</p><ol><li>Encryption Key 負責加解密 Vault 核心資訊，所以它是如何產生的？</li><li>Encryption Key 的安全性？</li><li>Barrier 與 storage backend 之間的安全性是如何被實作的？</li></ol><p>以下從 source code 逐步解析這些過程，並且找出上述幾個問題的解答。</p><h2 id=環境>環境</h2><p>Vault 1.5.3
本文主要在說明 Vault 初次 initialize 的流程</p><h2 id=vault-initialization>Vault Initialization</h2><p>要知道 encryption Key 是如何產生的，就從 Vault 初始化步驟著手。</p><p><img src=/posts/vault_1.png alt=vault></p><p>當 Vault 啟動階段，會先根據使用者的 configuration file 進行參數設定，然後進入到 Vault system 初始化流程。而初始化後的 Vault 是屬於 seal 階段，此時如果使用者設定的 seal provider 支持自動 unseal，就會進行 unseal，最後啟動完成。</p><h3 id=seal-initialization>Seal Initialization</h3><p>在 concept 文中有提到，Vault 會對 master key 進行加解密，以確保 master key 安全性。而 seal 就是提供此加解密流程的 object。</p><blockquote><p>The seal configures the seal type to use for additional data protection, such as using HSM or Cloud KMS solutions to encrypt and decrypt the master key.</p></blockquote><p>Seal 在 source code 為 interface 型態，而目前提供 <code>defaultSeal</code> 和 <code>autoSeal</code> 兩種實作 struct。透過此抽象層，我們就能應用不同 seal provider。關於 Vault 實作不同 Seal provider，可以參考 <a href=https://github.com/hashicorp/go-kms-wrapping>Go-KMS-Wrapping</a> repository，而預設的 seal provider 是 Shamir seal，也就是利用 shared shamir keys 來加解密。</p><p>Seal Initialization 會呼叫底層 seal provider 所提供的 Init function，其行為根據各 provider 需求而有所不同，也有可能這階段什麼都不需要做（例如 GCP seal provider）。</p><h3 id=barrier-initialization>Barrier Initialization</h3><p>Barrier 負責加解密往來於 Vault server 和 storage backend 的資料，因此它的初始化步驟就相當的重要。Barrier 也被抽象成一個 interface，實際實作的 struct 為 <code>AESGCMBarrier</code>。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>AESGCMBarrier</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>backend</span><span style=color:#fff> </span><span style=color:#1f2328>physical</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Backend</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>l</span><span style=color:#fff>      </span><span style=color:#1f2328>sync</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RWMutex</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>sealed</span><span style=color:#fff> </span><span style=color:#cf222e>bool</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// keyring is used to maintain all of the encryption keys, including</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// the active key used for encryption, but also prior keys to allow</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// decryption of keys encrypted under previous terms.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyring</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Keyring</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// cache is used to reduce the number of AEAD constructions we do</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>cache</span><span style=color:#fff>     </span><span style=color:#cf222e>map</span><span style=color:#1f2328>[</span><span style=color:#cf222e>uint32</span><span style=color:#1f2328>]</span><span style=color:#1f2328>cipher</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AEAD</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>cacheLock</span><span style=color:#fff> </span><span style=color:#1f2328>sync</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RWMutex</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// currentAESGCMVersionByte is prefixed to a message to allow for</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// future versioning of barrier implementations. It&#39;s var instead</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// of const to allow for testing</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>currentAESGCMVersionByte</span><span style=color:#fff> </span><span style=color:#cf222e>byte</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>initialized</span><span style=color:#fff> </span><span style=color:#1f2328>atomic</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Bool</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>首先，在初始化之前，會先產生 master key。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// vault/init.go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// BarrierKey is master key. barrierKeyShares is only used for testing. </span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>barrierKey</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>barrierKeyShares</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#6639ba>generateShares</span><span style=color:#1f2328>(</span><span style=color:#1f2328>barrierConfig</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>接著，進入到 <code>AESGCMBarrier</code> 的 <code>Initialize</code> function：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>AESGCMBarrier</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>Initialize</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>key</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>sealKey</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>reader</span><span style=color:#fff> </span><span style=color:#1f2328>io</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Reader</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// ...</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Generate encryption key</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>encrypt</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>GenerateKey</span><span style=color:#1f2328>(</span><span style=color:#1f2328>reader</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to generate encryption key: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Create a new keyring, install the keys</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyring</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>NewKeyring</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyring</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetMasterKey</span><span style=color:#1f2328>(</span><span style=color:#1f2328>key</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>AddKey</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>Key</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Term</span><span style=color:#1f2328>:</span><span style=color:#fff>    </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Value</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>encrypt</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create keyring: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>persistKeyring</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// ...</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>就可以看到產生 encryption key 的 function <code>b.GenerateKey(reader)</code>。
其中，這樣的設計很有巧思，<code>reader(io.Reader)</code> parameter 在 Vault 中又稱作 <code>secureRandomReader</code>，實際上就是 random number generator (PNG)。在預設情況下，會使用 OS 本身所提供的 random number generator，但使用者也能根據需求來使用自己想要的 generator，例如 hardware / true number generator。</p><p>此外，這邊也引入 <code>Keyring</code> 來建立起 master key 與 encryption key 的關係。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>Keyring</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>masterKey</span><span style=color:#fff>  </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>byte</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>keys</span><span style=color:#fff>       </span><span style=color:#cf222e>map</span><span style=color:#1f2328>[</span><span style=color:#cf222e>uint32</span><span style=color:#1f2328>]</span><span style=color:#0550ae>*</span><span style=color:#1f2328>Key</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>activeTerm</span><span style=color:#fff> </span><span style=color:#cf222e>uint32</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>每個 keyring 由一組 master key 與多組 encryption key 結合而成</strong>，keyring 結構設計對於 keys 來說十分重要，除了方便 Barrier 管理多組 encryption key 之外，同時也實現 master key 與 encryption key 的更新方法。</p><p>產生出 encryption key 之後，透過 <code>persistKeyring</code> 把 encryption key 使用 master key AES 加密後存到 storage 中。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>AESGCMBarrier</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>persistKeyring</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>Keyring</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Create the keyring entry</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyringBuf</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Serialize</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>defer</span><span style=color:#fff> </span><span style=color:#6639ba>memzero</span><span style=color:#1f2328>(</span><span style=color:#1f2328>keyringBuf</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to serialize keyring: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Create the AES-GCM</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>gcm</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>aeadFromKey</span><span style=color:#1f2328>(</span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>MasterKey</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Encrypt the barrier init value</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>encrypt</span><span style=color:#1f2328>(</span><span style=color:#1f2328>keyringPath</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>initialKeyTerm</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>gcm</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keyringBuf</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Create the keyring physical entry</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>pe</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>physical</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Entry</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Key</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>keyringPath</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Value</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>backend</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Put</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>pe</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to persist keyring: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Serialize the master key value</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>key</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>Key</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Term</span><span style=color:#1f2328>:</span><span style=color:#fff>    </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Value</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>MasterKey</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>keyBuf</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>key</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Serialize</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>defer</span><span style=color:#fff> </span><span style=color:#6639ba>memzero</span><span style=color:#1f2328>(</span><span style=color:#1f2328>keyBuf</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to serialize master key: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Encrypt the master key</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>activeKey</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>keyring</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ActiveKey</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>aead</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>aeadFromKey</span><span style=color:#1f2328>(</span><span style=color:#1f2328>activeKey</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Value</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#6639ba>encrypt</span><span style=color:#1f2328>(</span><span style=color:#1f2328>masterKeyPath</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>activeKey</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Term</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>aead</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keyBuf</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Update the masterKeyPath for standby instances</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>pe</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>physical</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Entry</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Key</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>masterKeyPath</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>Value</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#1f2328>.</span><span style=color:#1f2328>backend</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Put</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>pe</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to persist master key: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=encrypt-the-master-key-using-the-encryption-key>Encrypt the master key using the encryption key</h4><p>上述 source code 可以看到一個很奇怪的地方，就是 <code>Encrypt the master key</code> ，文件說 master key 是由 seal provider 所加密，為什麼這裡的 master key 是由 encryption key 加密呢？</p><p>我們在 <code>vault/barrier.go</code> 可以找到答案：</p><blockquote><p>This is encrypted by the latest key in the keyring. This is only used by standby instances to handle the case of a rekey. If the active instance does a rekey, the standby instances can no longer reload the keyring since they have the old master key.</p></blockquote><p>這段把 master key 使用 encryption key 加密，並且儲存在 <code>masterKeyPath</code>，其用途僅是針對 rekey 流程。而把 master key 使用 seal provider 加密後儲存則是在下一段 code 中出現。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// vault/init.go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>switch</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#6639ba>StoredKeysSupported</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StoredKeysSupportedShamirMaster</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#57606a>// store the master key(barrierKey)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>keysToStore</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[][]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>{</span><span style=color:#1f2328>barrierKey</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#6639ba>GetAccess</span><span style=color:#1f2328>().</span><span style=color:#1f2328>Wrapper</span><span style=color:#1f2328>.(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>aeadwrapper</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ShamirWrapper</span><span style=color:#1f2328>).</span><span style=color:#6639ba>SetAESGCMKeyBytes</span><span style=color:#1f2328>(</span><span style=color:#1f2328>sealKey</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>logger</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to set seal key&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;error&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to set seal key: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetStoredKeys</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keysToStore</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>logger</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to store keys&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;error&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to store keys: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>results</span><span style=color:#1f2328>.</span><span style=color:#1f2328>SecretShares</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>sealKeyShares</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>case</span><span style=color:#fff> </span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StoredKeysSupportedGeneric</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>keysToStore</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[][]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>{</span><span style=color:#1f2328>barrierKey</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>seal</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetStoredKeys</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>keysToStore</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>c</span><span style=color:#1f2328>.</span><span style=color:#1f2328>logger</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to store keys&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;error&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errwrap</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Wrapf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to store keys: {{err}}&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>default</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#57606a>// We don&#39;t support initializing an old-style Shamir seal anymore, so</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#57606a>// this case is only reachable by tests.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>results</span><span style=color:#1f2328>.</span><span style=color:#1f2328>SecretShares</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>barrierKeyShares</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=barrier-unseal>Barrier Unseal</h3><p>所謂的 Vault Unseal，正確來說應該是 Barrier Unseal，實際流程為：</p><ol><li>從 storage backend 中取出加密過的 keyring(bytes)</li><li>使用 master key 解密 keyring(bytes)</li><li>組成 keyring struct</li><li>Unseal 完成</li></ol><p>Barrier 需要得到正確的 keyring 才能用其中的 encryption key 來加解密 storage 的資料，因此 unseal 最重要的目的就是取得 keyring。</p><h3 id=barrier-workflow>Barrier Workflow</h3><p>了解 barrier 初始化過程後，我們來看一下資料是如何進出 Barrier 與 storage backend 的。</p><p><img src=/posts/vault_2.png alt=vault></p><p>實際實作有三層 Layer：<code>Logical</code>、<code>Barrier</code>、<code>Physical</code> Layers。當一個 request 進來，會根據 URL path 來選擇(route) secret engine 和所要執行的 operation，接著如果有資料需要更新儲存到 storage backend，就會呼叫 logical.Storage put 方法。</p><p>而 logical.Storage 只是個抽象層，實際上是執行 barrier 的 put 方法，Barrier 會先將 data 使用 keyring 中最新的 encryption key 加密後，再呼叫 physical 的 put 方法來儲存，反之亦然。</p><h3 id=generate-a-root-token>Generate a Root Token</h3><p>在 Vault 初始化時，會需要一組 root token 以供使用者進行初步驗證與設定。Root token 是由 base 62 組合而成的 24bytes 長度字串，當產生出 token 之後，會需要將 token 存入 storage 中，因此在這個階段 barrier 須維持 unseal 狀態。</p><h4 id=entropy-of-token-generation>Entropy of Token Generation</h4><p>產生 token 的 source code 有個很有意思的地方，就是討論 token entropy，<code>Information Entropy</code> 介紹可參考 <a href=https://brilliant.org/wiki/entropy-information-theory/>Entropy (Information Theory)</a>。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>const</span><span style=color:#fff> </span><span style=color:#1f2328>charset</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>const</span><span style=color:#fff> </span><span style=color:#1f2328>csLen</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>byte</span><span style=color:#1f2328>(</span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>charset</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#57606a>// Resulting entropy is ~5.95 bits/character.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>RandomWithReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>length</span><span style=color:#fff> </span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>reader</span><span style=color:#fff> </span><span style=color:#1f2328>io</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Reader</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>length</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>output</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>make</span><span style=color:#1f2328>([]</span><span style=color:#cf222e>byte</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>length</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Request a bit more than length to reduce the chance</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// of needing more than one batch of random bytes</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>batchSize</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>length</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#1f2328>length</span><span style=color:#0550ae>/</span><span style=color:#0550ae>4</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>buf</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>uuid</span><span style=color:#1f2328>.</span><span style=color:#6639ba>GenerateRandomBytesWithReader</span><span style=color:#1f2328>(</span><span style=color:#1f2328>batchSize</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>reader</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#cf222e>range</span><span style=color:#fff> </span><span style=color:#1f2328>buf</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#57606a>// Avoid bias by using a value range that&#39;s a multiple of 62</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#1f2328>&lt;</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>csLen</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#fff> </span><span style=color:#0550ae>4</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span><span style=color:#1f2328>output</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#6639ba>append</span><span style=color:#1f2328>(</span><span style=color:#1f2328>output</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>charset</span><span style=color:#1f2328>[</span><span style=color:#1f2328>b</span><span style=color:#0550ae>%</span><span style=color:#1f2328>csLen</span><span style=color:#1f2328>])</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#6639ba>len</span><span style=color:#1f2328>(</span><span style=color:#1f2328>output</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#1f2328>length</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>string</span><span style=color:#1f2328>(</span><span style=color:#1f2328>output</span><span style=color:#1f2328>),</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>另一個可以注意的地方是，除了使用 <code>crypto/rand</code> 產生出隨機 byte 之外，由於 token 有特定的 charset，避免某個 char 的分配數量不均，因此還加入 <code>b &lt; (csLen * 4)</code> 此判斷，是一個很簡單但是又易被忽略的地方。</p><blockquote><p><code>uuid.GenerateRandomBytesWithReader(batchSize, reader)</code>，此 reader 在預設情況下為 crypto/rand。</p></blockquote><h2 id=barrier-seal>Barrier Seal</h2><p>當所有需要 unseal 狀態的指令動作都執行完之後，最後一個階段就是再次將 barrier 切換到 seal 狀態，初始化完成。</p><h2 id=問題討論>問題討論</h2><p>回到一開始我們所要討論的問題：</p><h3 id=1-encryption-key-負責加解密-vault-核心資訊所以它是如何產生的>1. Encryption Key 負責加解密 Vault 核心資訊，所以它是如何產生的？</h3><p>不論是 encryption Key 或是 master key，皆是 256bit ，以供 AES-256 加密算法使用，安全度也較高。至於 random source 是利用 OS 的 random number generator，其實作方式則根據各 OS 而有所不同。</p><h3 id=2-encryption-key-的安全性>2. Encryption Key 的安全性</h3><p>上述有提到，master key 和 encryption Key 的產生仰賴 OS random number generator，而此 random number generator (PNG) 通常為 entropy input + algorithm true random number generator (<a href=https://en.wikipedia.org/wiki/Hardware_random_number_generator>TPNG or HRNG</a>)，對於需要高度資安考量的應用場景來說，會有安全疑慮。</p><p>以 Linux 來說，entropy input 來自硬體 event（例如 interrupt），其 entropy source 受到當前硬體環境、行為等影響，導致無法保證 PNG 所產生的亂數品質。</p><p>延伸閱讀：<a href=https://www.bsi.bund.de/SharedDocs/Downloads/EN/BSI/Publications/Studies/LinuxRNG/LinuxRNG_EN.pdf>Documentation and Analysis of the Linux Random Number Generator</a></p><p>當然，Vault 本身也針對此問題導入 HSM module（<a href="https://learn.hashicorp.com/tutorials/vault/hsm-entropy?in=vault/enterprise">Vault HSM Integration - Entropy Augmentation</a>），讓使用者可以設定 master key 或是 encryption Key 的生成是來自外部的安全模組，保證 encrption Key 的隨機性。</p><h3 id=3-barrier-與-storage-backend-之間的安全性是如何被實作的>3. Barrier 與 storage backend 之間的安全性是如何被實作的？</h3><p>當資料需要儲存到 storage backend 時，barrier 應為 unseal 狀態，也就是 barrier 擁有 keyring ，並且使用 keyring 中最新一把 encryption key 對資料進行加解密。keyring 可以存在多把新舊版本的 encryption key，以確保 encryption key 可以被更新，而資料也可以被前一版本的 encryption key 所解密。</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-08-25-comp790-lab1/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>CSE 506 Lab1 - The Stack</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-09-12-lab2-1/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>CSE 506 Lab2 - E820 Memory Map & Page Translation (1)</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>