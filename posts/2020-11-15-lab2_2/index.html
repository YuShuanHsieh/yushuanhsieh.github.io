<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>CSE 506 Lab2 - Memory Management and Virtual Memory Mapping — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>CSE 506 Lab2 - Memory Management and Virtual Memory Mapping</h1><div class=post-meta><time datetime=2020-11-15>November 15, 2020</time>
<span class=separator>·</span>
<span class=reading-time>13 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/operating-system/>Operating System</a></div></header><div class=post-content><h2 id=閒聊>閒聊</h2><p>上次寫完 Lab 2 source code study 之後，一晃眼就過了近兩個月。中間被各種事物攔截，加上剛好有些機遇和機會，因此挪了一些時間去準備，等事情有比較明朗後再跟大家分享。此外，學校也開學了，這學期修了偏硬體架構的課程，包含 RISC-V 和架構效能分析等，單智君教授的教學內容很好，聲音也很溫柔，非常喜歡這位教授的課程。</p><p>這時間還遇上 Macbook 螢幕完全無法顯示的意外，經由朋友提醒，2016 年產的 13 吋 Macbook Pro 有螢幕背光災情，Apple 有提供免費召回維修的服務，因此花了一些時間送修。而 Apple 的服務也還不錯，整個螢幕換新，看來又可以撐好一陣子了 &lt;3</p><h2 id=lab-2>Lab 2</h2><p><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/lab2.html>實驗說明文件</a></p><h2 id=part-1-physical-page-management>Part 1: Physical Page Management</h2><p>Part 1 是實作 physical memory allocator。在 <a href=https://yushuanhsieh.github.io/post/2020-09-12-lab2-1/>CSE 506 Lab2 - E820 Memory Map & Page Translation (1)</a> 可以看到系統在執行 kernel code 前，有先在 bootstrap 階段建立 page translation 所需的 pml4 table，以確保 kernel code 可以正確地被執行，不過在 kernel code 運行階段，我們需要建立新的 pml4 table ，來讓我們可以有更多控制權。</p><h3 id=boot_alloc>boot_alloc</h3><p>Page translation 機制最重要的就是先有 <code>pml4 table</code>，我們透過實作 <code>boot_alloc</code> 來分配 pml4 table 的記憶體空間。而在實作之前，第一個問題就是：alloc 的初始記憶體位置在哪裡？</p><p>而在 boot_alloc code 中可以看到：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>nextfree<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>extern</span> <span style=color:#cf222e>char</span> end<span style=color:#1f2328>[];</span>
</span></span><span style=display:flex><span>    nextfree <span style=color:#0550ae>=</span> <span style=color:#6639ba>ROUNDUP</span><span style=color:#1f2328>((</span><span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> end<span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>end</code> 這個 variable 是在其他地方定義，這也告訴我們只要取得 <code>end</code> address，就可以知道我們該從哪個記憶體位置開始執行 allocation。<code>end</code> variable 定義在 link script：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#1f2328>.</span><span style=color:#900;font-weight:700>bss</span> <span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0550ae>*</span><span style=color:#1f2328>(</span><span style=color:#6639ba>EXCLUDE_FILE</span><span style=color:#1f2328>(</span>vmm<span style=color:#0550ae>/</span>guest<span style=color:#0550ae>/</span>obj<span style=color:#0550ae>/</span>kern<span style=color:#0550ae>/</span>bootstrap<span style=color:#1f2328>.</span>o<span style=color:#1f2328>)</span> <span style=color:#1f2328>.</span>bss<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>PROVIDE</span><span style=color:#1f2328>(</span>end <span style=color:#0550ae>=</span> <span style=color:#1f2328>.);</span>
</span></span></code></pre></td></tr></table></div></div><p>緊接在 .bss section 下方，這也意味著記憶體位置是在 .bss section 結束之後，以確保 kernel text 和 data 這些記憶體位置不會 overlap。</p><blockquote><p>The PROVIDE keyword may be used to define a symbol, such as <code>etext</code>, only if it is referenced but not defined. The syntax is PROVIDE(symbol = expression).</p></blockquote><p>有了這些資訊就可以來實作 boot_alloc function 。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#6639ba>boot_alloc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>uint32_t</span> n<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span>nextfree<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span>result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>nextfree<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>extern</span> <span style=color:#cf222e>char</span> end<span style=color:#1f2328>[];</span>
</span></span><span style=display:flex><span>        nextfree <span style=color:#0550ae>=</span> <span style=color:#6639ba>ROUNDUP</span><span style=color:#1f2328>((</span><span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> end<span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#0550ae>=</span> nextfree<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>n<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nextfree <span style=color:#0550ae>=</span> <span style=color:#6639ba>ROUNDUP</span><span style=color:#1f2328>(</span>nextfree <span style=color:#0550ae>+</span> n<span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// npages: the number of physical pages available
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// in both base and extended memory
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>npages <span style=color:#0550ae>*</span> PGSIZE <span style=color:#0550ae>&lt;</span> <span style=color:#6639ba>PADDR</span><span style=color:#1f2328>(</span>nextfree<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;boot_alloc: out of memory</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=page_init>page_init</h3><p>接著，我們透過 <code>struct PageInfo *pages</code> 來追蹤 page 的使用狀況，將 physical memory 切割成 PGSIZE 的陣列，並用 struct PageInfo 紀錄當前 reference 次數。同時，struct PageInfo 是 list 結構，所以也用於 free page list ，這樣可以讓我們快速地找到哪些 page 是可以使用的。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> PageInfo <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>pp_link<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>uint16_t</span> pp_ref<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>在使用 page_alloc 之前，先使用 page_init 來初始化 pageInfo list。而初始化最重要的事情就是<strong>標記已被使用的 page</strong>，例如 kernel code、I/O、BIOS 等。</p><p>根據題目，我們使用圖示來看目前用到的記憶體區塊：</p><p><img src=/posts/lab2_1.png alt="memory area"></p><p>其中，已被佔用的記憶體包含：</p><ol><li>BIOS data (0x0 ~ 0x1000)</li><li>Bootstrap page table (0x7000 ~ 0xC000)
這是我們目前正在使用的 page table，所以要設為佔用。</li><li>I/O holes (0xA0000 ~ 0x100000)</li><li>bootstrap code and kernel code (0x100000 ~ end pointer)</li></ol><p>因此，我們要將對應的 page 標示已使用，並把可供使用的 page 加入到 free list 中。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>page_init</span><span style=color:#1f2328>(</span><span style=color:#cf222e>void</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>size_t</span> i<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> PageInfo<span style=color:#0550ae>*</span> last <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> io_page <span style=color:#0550ae>=</span> IOPHYSMEM <span style=color:#0550ae>/</span> PGSIZE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> free_page <span style=color:#0550ae>=</span> <span style=color:#6639ba>PADDR</span><span style=color:#1f2328>(</span><span style=color:#6639ba>boot_alloc</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>))</span> <span style=color:#0550ae>/</span> PGSIZE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pages<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>pp_ref <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    pages<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>pp_link <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>i <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> npages<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>uint64_t</span> va<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>bool</span> used <span style=color:#0550ae>=</span> <span style=color:#6639ba>false</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>].</span>pp_link <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>i <span style=color:#0550ae>&gt;=</span> io_page <span style=color:#0550ae>&amp;&amp;</span> i <span style=color:#0550ae>&lt;</span> free_page<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            used <span style=color:#0550ae>=</span> <span style=color:#6639ba>true</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        va <span style=color:#0550ae>=</span> KERNBASE <span style=color:#0550ae>+</span> i <span style=color:#0550ae>*</span> PGSIZE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>va <span style=color:#0550ae>&gt;=</span> BOOT_PAGE_TABLE_START <span style=color:#0550ae>&amp;&amp;</span> va <span style=color:#0550ae>&lt;</span> BOOT_PAGE_TABLE_END<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            used <span style=color:#0550ae>=</span> <span style=color:#6639ba>true</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>used<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>].</span>pp_ref <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>continue</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>].</span>pp_ref <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span><span style=color:#1f2328>(</span>last<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            last<span style=color:#0550ae>-&gt;</span>pp_link <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>else</span>
</span></span><span style=display:flex><span>            page_free_list <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>        last <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>pages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由於不知道 bootstrap code 的結束位置，因此把從 I/O 到 kernel code end 這段區域都標示成已使用。</p><h3 id=page_alloc--page_free>page_alloc & page_free</h3><p>而有了 page free list，要處理 page allocation 和 page free 都簡單很多，只要將 page 從 free list 中取出和放回即可。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span><span style=color:#6639ba>page_alloc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> alloc_flags<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>page_free_list<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>page <span style=color:#0550ae>=</span> page_free_list<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	page_free_list <span style=color:#0550ae>=</span> page<span style=color:#0550ae>-&gt;</span>pp_link<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>alloc_flags <span style=color:#0550ae>&amp;</span> ALLOC_ZERO<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>		<span style=color:#6639ba>memset</span><span style=color:#1f2328>(</span><span style=color:#6639ba>page2kva</span><span style=color:#1f2328>(</span>page<span style=color:#1f2328>),</span> <span style=color:#0a3069>&#39;\0&#39;</span><span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	page<span style=color:#0550ae>-&gt;</span>pp_link <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>return</span> page<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>page_free</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>pp<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>pp<span style=color:#0550ae>-&gt;</span>pp_ref <span style=color:#0550ae>!=</span> <span style=color:#0550ae>0</span> <span style=color:#0550ae>||</span> pp<span style=color:#0550ae>-&gt;</span>pp_link<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>		<span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;&#39;the page could not be freed&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	pp<span style=color:#0550ae>-&gt;</span>pp_link <span style=color:#0550ae>=</span> page_free_list<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	page_free_list <span style=color:#0550ae>=</span> pp<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=part-2-virtual-memory>Part 2: Virtual Memory</h2><p>有了初始的 pml4 table 後，接下來就是對照 <a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf>AMD64 Architecture Programmer&rsquo;s Reference Manual</a> virtual address 與 physical addresses 轉換機制，建立起 pysical pages 與 virtual memory 之間的關係。</p><blockquote><p>在 x86_64 架構中，定義了四種形態的 address：</p><ol><li>Logical addresses</li><li>Effective addresses</li><li>Linear (virtual) addresses</li><li>Physical addresses</li></ol><p>其對應關係為：</p><p><img src=/posts/address_mapping.png alt="memory area"></p><p>早先的 x86 架構多採用 segmentation translation 機制，不過由於 page translation 機制能更有助於系統軟體處理 process isolation 和 relocation 等議題，因此在當前的 x86_64 long mode 中，是以 <strong>flat</strong> 64-bit virtual-address(segmentation disabled) 實現 page translation。</p></blockquote><p>在 <code>bootstrap.S</code> file 中可以看到 GDT(Global descriptor table) 相關設定，其中透過將 code / data segment 的 base address 設為 0 來停用 segmentation。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#900;font-weight:700>gdt_64</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    SEG_NULL
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 0af9a - flag, 000000 - segment&#39;s base addr, ffff - limit
</span></span></span><span style=display:flex><span>    <span style=color:#1f2328>.</span>quad  <span style=color:#0550ae>0x00af9a000000ffff</span>            <span style=color:#f6f8fa;background-color:#82071e>#</span><span style=color:#0550ae>64</span> bit CS
</span></span><span style=display:flex><span>    <span style=color:#1f2328>.</span>quad  <span style=color:#0550ae>0x00cf92000000ffff</span>            <span style=color:#f6f8fa;background-color:#82071e>#</span><span style=color:#0550ae>64</span> bit DS
</span></span></code></pre></td></tr></table></div></div><p>:::</p><p>首先，我們需要能查找各 level page table 的 function，以利我們能依據 virtual address 一層一層地找到對應的 page table entry，其中包含：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span> <span style=color:#6639ba>pml4e_walk</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>pml4e<span style=color:#1f2328>,</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> create<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span> <span style=color:#6639ba>pdpe_walk</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pdpe_t</span> <span style=color:#0550ae>*</span>pdpe<span style=color:#1f2328>,</span><span style=color:#cf222e>const</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span><span style=color:#cf222e>int</span> create<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span> <span style=color:#6639ba>pgdir_walk</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pde_t</span> <span style=color:#0550ae>*</span>pgdir<span style=color:#1f2328>,</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> create<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>預期的查找行為：pml4e_walk (Level 4) -> pdpe_walk (Level 3) -> pgdir_walk (Level 2) -> 回傳 page table enrty (Level 1)。</p><p>根據上述內容，實作一部分的 code：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span><span style=color:#6639ba>pml4e_walk</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>pml4e<span style=color:#1f2328>,</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> create<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pdpe_t</span> <span style=color:#0550ae>*</span>pdpe<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>page <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>current_pml4e <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>pml4e<span style=color:#1f2328>[</span><span style=color:#6639ba>PML4</span><span style=color:#1f2328>(</span>va<span style=color:#1f2328>)];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// KADDR: a macro takes a physical address and returns the corresponding kernel virtual address.
</span></span></span><span style=display:flex><span>	pdpe <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>pdpe_t</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> <span style=color:#6639ba>KADDR</span><span style=color:#1f2328>(</span><span style=color:#6639ba>PTE_ADDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span>current_pml4e<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>return</span> <span style=color:#6639ba>pdpe_walk</span><span style=color:#1f2328>(</span>pdpe<span style=color:#1f2328>,</span> va<span style=color:#1f2328>,</span> create<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，在查找 table entry 過程中，當我們發現此 entry 為 NULL 時，就要幫它分配新的 physical page，分配完後繼續查找下一層 table。如此一來，就會需要我們在 Part 1 所實作的 page_alloc 和 page_free。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span><span style=color:#6639ba>pml4e_walk</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>pml4e<span style=color:#1f2328>,</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> create<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pdpe_t</span> <span style=color:#0550ae>*</span>pdpe<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>page <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>current_pml4e <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>pml4e<span style=color:#1f2328>[</span><span style=color:#6639ba>PML4</span><span style=color:#1f2328>(</span>va<span style=color:#1f2328>)];</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span><span style=color:#1f2328>(</span>create <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#0550ae>!*</span>current_pml4e<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		page <span style=color:#0550ae>=</span> <span style=color:#6639ba>page_alloc</span><span style=color:#1f2328>(</span>ALLOC_ZERO<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>page<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>			<span style=color:#cf222e>return</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		page<span style=color:#0550ae>-&gt;</span>pp_ref<span style=color:#0550ae>++</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#57606a>// permissions: PTE_P | PTE_W | PTE_U
</span></span></span><span style=display:flex><span>		<span style=color:#0550ae>*</span>current_pml4e <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>pml4e_t</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span><span style=color:#6639ba>page2pa</span><span style=color:#1f2328>(</span>page<span style=color:#1f2328>)</span> <span style=color:#0550ae>&amp;</span> <span style=color:#0550ae>~</span><span style=color:#0550ae>0xFFF</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>|</span> PTE_P <span style=color:#0550ae>|</span> PTE_W <span style=color:#0550ae>|</span> PTE_U<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	pdpe <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>pdpe_t</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> <span style=color:#6639ba>KADDR</span><span style=color:#1f2328>(</span><span style=color:#6639ba>PTE_ADDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span>current_pml4e<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span>pte <span style=color:#0550ae>=</span> <span style=color:#6639ba>pdpe_walk</span><span style=color:#1f2328>(</span>pdpe<span style=color:#1f2328>,</span> va<span style=color:#1f2328>,</span> create<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>pte <span style=color:#0550ae>&amp;&amp;</span> page<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// decrease the ref count and free the page if ref count is 0.
</span></span></span><span style=display:flex><span>		<span style=color:#6639ba>page_decref</span><span style=color:#1f2328>(</span>page<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// clear the entry
</span></span></span><span style=display:flex><span>		<span style=color:#0550ae>*</span>current_pml4e <span style=color:#0550ae>=</span> <span style=color:#0550ae>0x0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>return</span> pte<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>page = page_alloc(ALLOC_ZERO);</code>，取得目前可以使用的 physical PageInfo 之後，再透過 <code>page2pa</code> 找出 PageInfo 所對應的 physical memory address。</p><p>接著，我們根據 pml4 table enrty 來找到 Level 3 page directory pointer table。
<code>pdpe = (pdpe_t *) KADDR(PTE_ADDR(*current_pml4e));</code>，pml4 table entry 儲存的是 <strong>physical address | flags</strong>，因此我們需要使用 <code>PTE_ADDR</code> 來移除到 flags，<code>KADDR</code> 將 physical address 轉換成 virtual address。</p><blockquote><p>這邊要注意的地方是 physical address 與 virtual virtual address 的使用。由於我們將 pdpe 參數傳遞給下一個 function <code>pdpe_walk(pdpe, va, create);</code>，因此 pdpe (physical address) 需要再轉換成 virtual address 好讓 address 能在程式運行中時正確被解讀。</p></blockquote><p>實作好 pml4e_walk 之後，後續的 pdpe_walk、pgdir_walk 基本上大同小異，只要參照 <a href=https://i.imgur.com/sDBkI9T.png>virtual address translation 圖表</a> 正確地從 virtual address 取出 entry offset 即可。</p><h2 id=part-3-kernel-address-space>Part 3: Kernel Address Space</h2><p>最後，實作 <code>boot_map_region</code> 將指定的 virtual address 和 physical address 關聯起來。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>boot_map_region</span><span style=color:#1f2328>(</span><span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>pml4e<span style=color:#1f2328>,</span> <span style=color:#cf222e>uintptr_t</span> la<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> size<span style=color:#1f2328>,</span> <span style=color:#cf222e>physaddr_t</span> pa<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> perm<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>pte_t</span> <span style=color:#0550ae>*</span>pte<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>for</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> size<span style=color:#1f2328>;</span> i <span style=color:#0550ae>+=</span> PGSIZE<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		pte <span style=color:#0550ae>=</span> <span style=color:#6639ba>pml4e_walk</span><span style=color:#1f2328>(</span>pml4e<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span>la <span style=color:#0550ae>+</span> i<span style=color:#1f2328>,</span> <span style=color:#6639ba>true</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>pte<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>			<span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to find the physical memory&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>		<span style=color:#0550ae>*</span>pte <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span>pa <span style=color:#0550ae>+</span> i<span style=color:#1f2328>)</span> <span style=color:#0550ae>|</span> perm <span style=color:#0550ae>|</span> PTE_P<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>舉例來說，我們要將 pages 的 <strong>physical address</strong> 對應到 <code>UPAGES</code> virtual address 上，並且給予 user read-only 權限。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6639ba>boot_map_region</span><span style=color:#1f2328>(</span>pml4e<span style=color:#1f2328>,</span> UPAGES<span style=color:#1f2328>,</span> page_size<span style=color:#1f2328>,</span> <span style=color:#6639ba>PADDR</span><span style=color:#1f2328>(</span>pages<span style=color:#1f2328>),</span> PTE_U<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>mapping 所有的 physical address 到指定的 virtual address，只允許 kernel 使用。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6639ba>boot_map_region</span><span style=color:#1f2328>(</span>pml4e<span style=color:#1f2328>,</span> KERNBASE<span style=color:#1f2328>,</span> npages <span style=color:#0550ae>*</span> PGSIZE<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>physaddr_t</span><span style=color:#1f2328>)</span><span style=color:#0550ae>0x0</span><span style=color:#1f2328>,</span> PTE_W<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>PTE_U</code> 和 <code>PTE_W</code> 表示 permission，以用來區別 user 被允許讀寫的記憶體區域。當然還有其他 permission bit 表示，可以參閱 <a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf>AMD64 Architecture Programmer&rsquo;s Reference Manual</a> 的 5.4.1 節。</p><h2 id=recap>Recap</h2><ol><li>x86_64 架構使用 4 層 page table 來實作 page translation，透過解析 virtual address 可以取得各層級 table 的 entry offset。</li><li>注意 physical address 和 virtual address 的使用時機，配置 page table 時是使用 physical address。</li><li>PageInfo 用來表示 physical memory page 的使用狀況，透過 PageInfo 可以取得對應的 physical address 並且再轉換到 virtual address，要清楚這之間的關係。</li><li>了解基本的 memory layout，包含 real-mode address space 和 extended memory。也可以參考 source code - <a href=https://github.com/YuShuanHsieh/CSE-506-jos/blob/lab2/inc/memlayout.h>memlayout.h</a></li></ol><h2 id=source-code>Source code</h2><p><a href=https://github.com/YuShuanHsieh/CSE-506-jos>YuShuanHsieh / CSE-506-jos</a></p><h2 id=references>References</h2><ol><li><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/amd64/AMD64_Architecture_Programmers_Manual.pdf>AMD64 Architecture Programmer&rsquo;s Reference Manual: chapter 5</a></li><li><a href=https://wiki.osdev.org/Global_Descriptor_Table>Global Descriptor Table</a></li><li><a href=https://wiki.osdev.org/Setting_Up_Paging>Enable Paging</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-11-14-gophercon_2020/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>GopherCon TW 2020 場務組心得</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-11-25-lab3_1/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>CSE 506 Lab 3 - User Environments(Processes)</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>