<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>CSE 506 Lab 3 - User Environments(Processes) — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>CSE 506 Lab 3 - User Environments(Processes)</h1><div class=post-meta><time datetime=2020-11-25>November 25, 2020</time>
<span class=separator>·</span>
<span class=reading-time>14 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/operating-system/>Operating System</a></div></header><div class=post-content><h2 id=閒聊>閒聊</h2><p>之前在辦活動的時候，得知有朋友在 follow 我的 Blog ，真是讓我非常訝異，因為我一直是默默撰寫文章，而且雖然我有參與 Golang 和 GDG 社群，但是我寫的內容很常都跟 Golang 和 Google 技術沒什麼太大關係 XD 非常感謝各位的觀看，之前有近兩個月都沒更新，感覺有點罪惡，以後會盡量定期更新的。</p><p>目前除了自修 CSE 506 課程之外，還有學習 RISC-V instruction 以及 pipeline，因為過往經驗都是看 x86_64 instruction 居多，現在改看 RISC-V 還蠻不習慣的。另外就是還想學用 Rust 寫 kernel module，目前趨勢是有些 Kernel developers 嘗試將 Rust code 結合進 Linux kernel 中，再加上 Rust 的發展也蠻成熟，是時候抽空來學習一下。</p><h2 id=lab-3-exercise-part-a---user-environments>Lab 3 Exercise Part A - User Environments</h2><p>Lab 3 是我認為蠻重要的一個實驗課程，主要學習 process 的 context 組成、context switch 流程，以及 interupt handlers 的註冊和運作過程。當然，JOS 中簡化了很多步驟，不過透過學習這些概念，再回去看 Linux kernel code 就會有更深的感觸。</p><p>而為了區別與 UNIX processes 的差異，在 JOS 中是使用 <code>ENV(environment)</code> 來代表 JOS 的 process 功能， JOS environment 也有 thread 和 address space，在實驗中我們會去實作這兩個概念。</p><h3 id=user-environments>User Environments</h3><p>JOS 透過三個變數來管理 environments：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>envs <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>                   <span style=color:#57606a>/* All environments */</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>curenv <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>                 <span style=color:#57606a>/* the current env */</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>env_free_list<span style=color:#1f2328>;</span>          <span style=color:#57606a>/* Free environment list */</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 envs 為 array 結構，在 kernel 初始化時就會分配 1024 個 Env 記憶體空間大小。curenv 就是目前正在使用的 Env，而我們透過 free list 來取得目前可供使用的 Env。因此，我們重新檢視目前的記憶體佔用狀況，其中有一區塊必須用來紀錄所有 Env 狀態。</p><p><img src=/posts/CSE506-Lab3_2.png alt></p><p>接著，來觀察 Env 結構：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> Env <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> Trapframe env_tf<span style=color:#1f2328>;</span>	<span style=color:#57606a>// Saved registers
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>env_link<span style=color:#1f2328>;</span>   <span style=color:#57606a>// Free list link pointers
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>envid_t</span> env_id<span style=color:#1f2328>;</span>			<span style=color:#57606a>// Unique environment identifier
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>envid_t</span> env_parent_id<span style=color:#1f2328>;</span>		<span style=color:#57606a>// env_id of this env&#39;s parent
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>enum</span> EnvType env_type<span style=color:#1f2328>;</span>		<span style=color:#57606a>// Indicates special system environments
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> env_status<span style=color:#1f2328>;</span>		<span style=color:#57606a>// Status of the environment
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> env_runs<span style=color:#1f2328>;</span>		<span style=color:#57606a>// Number of times environment has run
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Address space
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>pml4e_t</span> <span style=color:#0550ae>*</span>env_pml4e<span style=color:#1f2328>;</span>		<span style=color:#57606a>// Kernel virtual address of top-level page dir,
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// or root of extended page tables in guest mode.
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>physaddr_t</span> env_cr3<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint8_t</span> <span style=color:#0550ae>*</span>elf<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>回顧作業系統的課程中所提到的觀念：</p><ol><li>切換 process 的時候，會需要保存目前狀態，而 <code>struct Trapframe env_tf</code> 就是用來儲存 registers 的數值</li><li>從 interrupt handler 回到指定的 process，依賴 <code>env_id</code></li><li>fork process 時候會有 parent ID，則是 <code>env_parent_id</code></li><li><code>env_status</code> 紀錄當前 process 狀態，例如 running or runnable</li><li>每個 process 有自己的 address space，則是紀錄在 <code>env_pml4e</code> 和 <code>env_cr3</code></li></ol><h4 id=create-an-envs-array>Create an envs array</h4><p>有了概念之後，就先從 envs 實作起。首先分配 size 為 <code>sizeof(struct Env) * NENV</code> 的記憶體空間，接著把該記憶體區段 mapping 到指定的 virtual address <code>UENVS</code>，其權限為 kernel read, user read。（相關 functions 實作可參考 <a href=https://yushuanhsieh.github.io/post/2020-11-15-lab2_2/>CSE 506 Lab2 - Memory Management and Virtual Memory Mapping</a>）</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>uint32_t</span> env_size <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Env<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> NENV<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>envs <span style=color:#0550ae>=</span> <span style=color:#6639ba>boot_alloc</span><span style=color:#1f2328>(</span>env_size<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6639ba>boot_map_region</span><span style=color:#1f2328>(</span>boot_pml4e<span style=color:#1f2328>,</span> UENVS<span style=color:#1f2328>,</span> env_size<span style=color:#1f2328>,</span> <span style=color:#6639ba>PADDR</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>),</span> PTE_U<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>初始化 env，並且組成 env free list 供後續使用。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>env_init</span><span style=color:#1f2328>(</span><span style=color:#cf222e>void</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>last<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	last <span style=color:#0550ae>=</span> env_free_list <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>envs<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	envs<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>env_id <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> i <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> NENV<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		envs<span style=color:#1f2328>[</span>i<span style=color:#1f2328>].</span>env_id <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		last<span style=color:#0550ae>-&gt;</span>env_link <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>envs<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>		last <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>envs<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// Per-CPU part of the initialization
</span></span></span><span style=display:flex><span>	<span style=color:#6639ba>env_init_percpu</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>Segment Register</strong></p><p>觀察 <code>env_init_percpu();</code> ，留意 segment register 的設定，在 <a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/ia32/IA32-3A.pdf>Developer&rsquo;s Manual: 3.4.2 Segment Selectors</a> 中提到，segment register 紀錄 segment selector 的值，而 segment selector 前 2 個 bit 的值為 <code>Requested Privilege Level </code>，因此 (GD_UD|<strong>3</strong>) 意味著 user level(applications)。其他 Level 可以參考 Developer&rsquo;s Manual： 4.5 PRIVILEGE LEVELS。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>asm</span> <span style=color:#6639ba>volatile</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;movw %%ax,%%gs&#34;</span> <span style=color:#0550ae>::</span> <span style=color:#0a3069>&#34;a&#34;</span> <span style=color:#1f2328>(</span>GD_UD<span style=color:#0550ae>|</span><span style=color:#0550ae>3</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>asm</span> <span style=color:#6639ba>volatile</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;movw %%ax,%%fs&#34;</span> <span style=color:#0550ae>::</span> <span style=color:#0a3069>&#34;a&#34;</span> <span style=color:#1f2328>(</span>GD_UD<span style=color:#0550ae>|</span><span style=color:#0550ae>3</span><span style=color:#1f2328>));</span>
</span></span></code></pre></td></tr></table></div></div></blockquote><h4 id=setup-an-address-space-for-env>Setup an address space for env</h4><p>每個 env 會有自己獨立的 address space，而在 JOS 中是透過建立不同 pml4 page table 來達成目的。</p><p>其中要注意的地方是，env 的 pml4[0] 被設定為 user address space，而 pml4[1] - pml4[511] 則是 kernel address space，因此每個 env 的 pml4 1 - 511 entry 都會對應到相同的 kernel page table (boot_pml4)，他們才能取得相同的資訊。而 pml4[0] 則是每個 env 都有自己的一個 table，並對應到不同的 physical memory address。</p><p><img src=/posts/CSE506-Lab3_1.png alt=CSE506-Lab3></p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>int</span> <span style=color:#6639ba>env_setup_vm</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>e<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>int</span> i<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>p <span style=color:#0550ae>=</span> <span style=color:#6639ba>NULL</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Allocate a page for the page directory
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span><span style=color:#1f2328>(</span>p <span style=color:#0550ae>=</span> <span style=color:#6639ba>page_alloc</span><span style=color:#1f2328>(</span>ALLOC_ZERO<span style=color:#1f2328>)))</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> <span style=color:#0550ae>-</span>E_NO_MEM<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p<span style=color:#0550ae>-&gt;</span>pp_ref<span style=color:#0550ae>++</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    e<span style=color:#0550ae>-&gt;</span>env_pml4e <span style=color:#0550ae>=</span> <span style=color:#6639ba>page2kva</span><span style=color:#1f2328>(</span>p<span style=color:#1f2328>);</span> <span style=color:#57606a>// entry should be a virtual address
</span></span></span><span style=display:flex><span>    e<span style=color:#0550ae>-&gt;</span>env_cr3 <span style=color:#0550ae>=</span> <span style=color:#6639ba>page2pa</span><span style=color:#1f2328>(</span>p<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// NPMLENTRIES: the num of pml4 entries
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>i <span style=color:#0550ae>=</span> <span style=color:#6639ba>PML4</span><span style=color:#1f2328>(</span>UTOP<span style=color:#1f2328>);</span> i <span style=color:#0550ae>&lt;</span> NPMLENTRIES<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	    e<span style=color:#0550ae>-&gt;</span>env_pml4e<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> boot_pml4e<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// UVPT maps the env&#39;s own page table read-only.
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// Permissions: kernel R, user R
</span></span></span><span style=display:flex><span>    e<span style=color:#0550ae>-&gt;</span>env_pml4e<span style=color:#1f2328>[</span><span style=color:#6639ba>PML4</span><span style=color:#1f2328>(</span>UVPT<span style=color:#1f2328>)]</span> <span style=color:#0550ae>=</span> e<span style=color:#0550ae>-&gt;</span>env_cr3 <span style=color:#0550ae>|</span> PTE_P <span style=color:#0550ae>|</span> PTE_U<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=env-page-allocate-helper>Env page allocate helper</h4><p>為了方便我們分配 physical address 到指定的 virtual address，我們實作一個 helper： <code>region_alloc</code> 來達成目的。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>void</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>region_alloc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>e<span style=color:#1f2328>,</span> <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>va<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> len<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>start <span style=color:#0550ae>=</span> <span style=color:#6639ba>ROUNDDOWN</span><span style=color:#1f2328>(</span>va<span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>end <span style=color:#0550ae>=</span> <span style=color:#6639ba>ROUNDUP</span><span style=color:#1f2328>(</span>va <span style=color:#0550ae>+</span> len<span style=color:#1f2328>,</span> PGSIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span><span style=color:#1f2328>(;</span> start <span style=color:#0550ae>&lt;</span> end<span style=color:#1f2328>;</span> start <span style=color:#0550ae>+=</span> PGSIZE<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>struct</span> PageInfo <span style=color:#0550ae>*</span>pp <span style=color:#0550ae>=</span> <span style=color:#6639ba>page_alloc</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>pp<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            pp<span style=color:#0550ae>-&gt;</span>pp_ref<span style=color:#0550ae>++</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>int</span> ret <span style=color:#0550ae>=</span> <span style=color:#6639ba>page_insert</span><span style=color:#1f2328>(</span>e<span style=color:#0550ae>-&gt;</span>env_pml4e<span style=color:#1f2328>,</span> pp<span style=color:#1f2328>,</span> start<span style=color:#1f2328>,</span> PTE_W <span style=color:#0550ae>|</span> PTE_U<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>ret <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;region_alloc: %e </span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span> ret<span style=color:#1f2328>);</span>	
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;region_alloc: failed to allocate a page </span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=read-a-program-content-for-user-mode>Read a program content for user mode</h4><p>因為目前 Lab 3 階段的 JOS 還沒有 file system 支援，所以是藉由切換到 user mode 後，直接執行指定 program 的方式來驗證其正確性。而為了實現此驗證方式，我們需要讀取 JOS 已經事先準備好的 program ELF ，接著把 ELF 內的相關資訊放入 Env <code>env_tf</code>。</p><p>在實作之前，要先了解如何讀取 <strong>program header</strong> 內容，以取得 <strong>program segment</strong>。</p><blockquote><p><strong>Program header</strong></p><p>The program header table tells the system how to create a process image.</p></blockquote><p>參考 <a href=https://en.wikipedia.org/wiki/Executable_and_Linkable_Format>Executable and Linkable Format</a>，找到需要資料的對應位置，其中包含：</p><ol><li><code>e_phoff</code> - Program header table 位置</li><li><code>e_phnum</code> - Program header table 的 entry 數量</li><li><code>program_header->p_memsz</code> - segment 在 memory 佔用的大小</li><li><code>program_header->p_va</code> - virtual address of segment</li><li><code>program_header->p_offset</code> - segment 在 file image 的位置</li><li><code>program_header->p_filesz</code> - segment 在 file system 佔用的大小</li></ol><blockquote><p><strong>The difference between <code>p_memsz</code> and <code>p_filesz</code></strong></p><p>For the PT_LOAD entry describing the data segment, the p_memsz may be greater than the p_filesz. The difference is the size of the .bss section which is not required to be stored on disk.</p></blockquote><p>根據 program header 的資訊，我們就可以來實作 Lab 3 的 load_icode。主要流程：</p><ol><li>從 ELF 中取得 program segment 數量</li><li>根據每個 segment 所需空間來分配適當的記憶體</li><li>把 segment 內容從 file image 複製到指定的 memory address (program_header->p_va)</li><li>建立 stack 記憶體空間供 user program 使用</li><li>將 Env 的 RIP(instruction pointer) 指向 ELF entry</li></ol><p>這邊有個地方要特別注意，就是在執行複製的時候，<strong>需要將當前 pml4 page table 切換成 Env 的 pml4 page table</strong>，原因是我們使用 region_alloc 來為指定的 Env pml4 分配 program_header->p_va 的 page，不過當前的執行環境卻是使用 boot_pml4 table，如果我們不切換成 Env pml4 的話，那麼在 <code>memmove</code> 和 <code>memset</code> 階段就會出錯，因為找不到 program_header->p_va 配置。</p><blockquote><p><strong>e_entry</strong></p><p>The virtual address to which the system first transfers control, thus starting the process.</p></blockquote><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>load_icode</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>e<span style=color:#1f2328>,</span> <span style=color:#cf222e>uint8_t</span> <span style=color:#0550ae>*</span>binary<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#0550ae>-&gt;</span>elf <span style=color:#0550ae>=</span> binary<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> Proghdr <span style=color:#0550ae>*</span>program_header<span style=color:#1f2328>,</span> <span style=color:#0550ae>*</span>end_program_header<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> Elf <span style=color:#0550ae>*</span>elf <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Elf <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> binary<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    program_header <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Proghdr <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span>binary <span style=color:#0550ae>+</span> elf<span style=color:#0550ae>-&gt;</span>e_phoff<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    end_program_header <span style=color:#0550ae>=</span> program_header <span style=color:#0550ae>+</span> elf<span style=color:#0550ae>-&gt;</span>e_phnum<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>lcr3</span><span style=color:#1f2328>(</span>e<span style=color:#0550ae>-&gt;</span>env_cr3<span style=color:#1f2328>);</span> <span style=color:#57606a>// Important!
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(;</span> program_header <span style=color:#0550ae>&lt;</span> end_program_header<span style=color:#1f2328>;</span> program_header<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>program_header<span style=color:#0550ae>-&gt;</span>p_type <span style=color:#0550ae>==</span> ELF_PROG_LOAD<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>region_alloc</span><span style=color:#1f2328>(</span>e<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> program_header<span style=color:#0550ae>-&gt;</span>p_va<span style=color:#1f2328>,</span> program_header<span style=color:#0550ae>-&gt;</span>p_memsz<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>memmove</span><span style=color:#1f2328>((</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> program_header<span style=color:#0550ae>-&gt;</span>p_va<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span>binary <span style=color:#0550ae>+</span> program_header<span style=color:#0550ae>-&gt;</span>p_offset<span style=color:#1f2328>,</span> program_header<span style=color:#0550ae>-&gt;</span>p_filesz<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>memset</span><span style=color:#1f2328>((</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span>program_header<span style=color:#0550ae>-&gt;</span>p_va <span style=color:#0550ae>+</span> program_header<span style=color:#0550ae>-&gt;</span>p_filesz<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> program_header<span style=color:#0550ae>-&gt;</span>p_memsz <span style=color:#0550ae>-</span> program_header<span style=color:#0550ae>-&gt;</span>p_filesz<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6639ba>lcr3</span><span style=color:#1f2328>(</span>boot_cr3<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6639ba>region_alloc</span><span style=color:#1f2328>(</span>e<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span><span style=color:#1f2328>)(</span>USTACKTOP <span style=color:#0550ae>-</span> PGSIZE<span style=color:#1f2328>),</span> PGSIZE<span style=color:#1f2328>);</span> <span style=color:#57606a>// the stack for user space
</span></span></span><span style=display:flex><span>    e<span style=color:#0550ae>-&gt;</span>env_tf<span style=color:#1f2328>.</span>tf_rip <span style=color:#0550ae>=</span> elf<span style=color:#0550ae>-&gt;</span>e_entry<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=create-an-env-and-run-it>Create an env and run it</h4><p>最後步驟是新建一個 Env，並且實作 kernel mode Env 切換 到 user mode Env 的流程。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>env_create</span><span style=color:#1f2328>(</span><span style=color:#cf222e>uint8_t</span> <span style=color:#0550ae>*</span>binary<span style=color:#1f2328>,</span> <span style=color:#cf222e>enum</span> EnvType type<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>env<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>int</span> ret <span style=color:#0550ae>=</span> <span style=color:#6639ba>env_alloc</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>env<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>ret <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;env_alloc: %e&#34;</span><span style=color:#1f2328>,</span> ret<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>load_icode</span><span style=color:#1f2328>(</span>env<span style=color:#1f2328>,</span> binary<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    env<span style=color:#0550ae>-&gt;</span>env_type <span style=color:#0550ae>=</span> type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而 JOS Env 共定義了五種狀態：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>enum</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    ENV_FREE <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    ENV_DYING<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    ENV_RUNNABLE<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    ENV_RUNNING<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    ENV_NOT_RUNNABLE
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>因此在執行 Env 切換流程時，要確認並且調整 Env 狀態。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>env_run</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Env <span style=color:#0550ae>*</span>e<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>e<span style=color:#0550ae>-&gt;</span>env_status <span style=color:#0550ae>!=</span> ENV_RUNNABLE<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;the env could not run&#34;</span><span style=color:#1f2328>);</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>curenv <span style=color:#0550ae>&amp;&amp;</span> curenv<span style=color:#0550ae>-&gt;</span>env_status <span style=color:#0550ae>==</span> ENV_RUNNING<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        curenv<span style=color:#0550ae>-&gt;</span>env_status <span style=color:#0550ae>=</span> ENV_RUNNABLE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    curenv <span style=color:#0550ae>=</span> e<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    curenv<span style=color:#0550ae>-&gt;</span>env_status <span style=color:#0550ae>=</span> ENV_RUNNING<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    curenv<span style=color:#0550ae>-&gt;</span>env_runs<span style=color:#0550ae>++</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>lcr3</span><span style=color:#1f2328>(</span>curenv<span style=color:#0550ae>-&gt;</span>env_cr3<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>env_pop_tf</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>(</span>curenv<span style=color:#0550ae>-&gt;</span>env_tf<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>切換 JOS Env 有兩個重要的條件：</p><ol><li>改變 address space</li><li>復原 register 數值</li></ol><p>其中，改變 address space 是使用 <code>lcr3</code>，<code>env_pop_tf</code> 則是負責將儲存在 Env 的 register 數值放回到 register。我們觀察一下 env_pop_tf 的行為：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>env_pop_tf</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Trapframe <span style=color:#0550ae>*</span>tf<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>__asm</span> <span style=color:#6639ba>__volatile</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;movq %0,%%rsp</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span>             POPA <span style=color:#57606a>// pop saved registers
</span></span></span><span style=display:flex><span>             <span style=color:#0a3069>&#34;movw (%%rsp),%%es</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#0a3069>&#34;movw 8(%%rsp),%%ds</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#0a3069>&#34;addq $16,%%rsp</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\t</span><span style=color:#0a3069>addq $16,%%rsp</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span> <span style=color:#57606a>/* skip tf_trapno and tf_errcode */</span>
</span></span><span style=display:flex><span>             <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\t</span><span style=color:#0a3069>iretq&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#0550ae>:</span> <span style=color:#0550ae>:</span> <span style=color:#0a3069>&#34;g&#34;</span> <span style=color:#1f2328>(</span>tf<span style=color:#1f2328>)</span> <span style=color:#0550ae>:</span> <span style=color:#0a3069>&#34;memory&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;iret failed&#34;</span><span style=color:#1f2328>);</span>  <span style=color:#57606a>/* mostly to placate the compiler */</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>搭配 <code>struct Trapframe</code> format：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> Trapframe <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>struct</span> PushRegs tf_regs<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_es<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_padding1<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> tf_padding2<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_ds<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_padding3<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> tf_padding4<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> tf_trapno<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>/* below here defined by x86 hardware */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> tf_err<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uintptr_t</span> tf_rip<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_cs<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_padding5<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> tf_padding6<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> tf_eflags<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>/* below here only when crossing rings, such as from user to kernel */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uintptr_t</span> tf_rsp<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_ss<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> tf_padding7<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> tf_padding8<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span> <span style=color:#6639ba>__attribute__</span><span style=color:#1f2328>((</span>packed<span style=color:#1f2328>));</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 POPA 是將 <code>struct PushRegs</code> 儲存的 register 數值放回到 register，接著 movw 與 addq 的行為其實是把 stack pointer 調整到 tf->tf_rip 位置，最後使用 <code>iretq</code> instruction，讓指定的 instruction pointer (tf_rip) 可以被執行。</p><h3 id=recap>Recap</h3><p>重新複習上述我們所完成的 Lab 內容：</p><ul><li>在 kernel mode 新建立一個 env (process)</li><li>設置 env 的 address space (pml4 table)</li><li>根據 ELF Program header 資訊配置 env，包含 program entry point</li><li>切換成 env 的 address space 並還原 env 的 registers 值</li><li>跳轉去適當的 instruction 位置 (iret)</li></ul><h2 id=references>References</h2><ol><li><a href=https://www.cs.cmu.edu/~410/doc/segments/segments.html>x86 Segmentation for the 15-410 Student</a></li><li><a href=https://en.wikipedia.org/wiki/Executable_and_Linkable_Format>Executable and Linkable Format</a></li><li><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/ia32/IA32-3A.pdf>IA-32 Developer&rsquo;s Manual</a></li><li><a href=https://wiki.osdev.org/Getting_to_Ring_3>Getting to Ring 3</a></li><li><a href=https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html>GCC-Inline-Assembly-HOWTO</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2020-11-15-lab2_2/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>CSE 506 Lab2 - Memory Management and Virtual Memory Mapping</span>
</a><a href=https://yushuanhsieh.github.io/posts/2020-12-23-web_auth/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>GDG Hsinchu 12 月 Meetup - Improve Your Web Authentication Security</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>