<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>CSE 506 Lab 3 - Interrupts — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>CSE 506 Lab 3 - Interrupts</h1><div class=post-meta><time datetime=2021-01-26>January 26, 2021</time>
<span class=separator>·</span>
<span class=reading-time>12 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/operating-system/>Operating System</a></div></header><div class=post-content><h2 id=閒聊>閒聊</h2><p>2020 年過去了，因為年底各種考試和工作， Lab3 下半部份延遲到現在才完成。雖然拖蠻久的，但是往好的方向看就是有在持續進行下去，沒有放棄就是好結局！最近心境上有蠻多變化的，其中本來對於目前工作內容很疑惑，覺得跟純軟生活落差太大，但是在工作中慢慢地發現自己對於 security 領域的認知嚴重不足，如果能好好學習 security 相關知識，對於自己和未來發展還是挺有幫助的，結合 security 與 embedded or cloud 去發展，是一個有趣又有挑戰性的目標，因此目前就朝著這方向努力，希望今年可以在 COSCUP 分享 security 相關議題。</p><h2 id=lab-3-interrupts>Lab 3 Interrupts</h2><p>在開始實作 interrupt 之前，先結合上一篇 <a href=https://yushuanhsieh.github.io/post/2020-11-25-lab3_1/>CSE 506 Lab 3 - User Environments(Processes)</a> environment(process) 的觀念，綜觀一下 interrupt 結合 environment context switch 的 interrupt handle 過程。</p><p><img src=/posts/lab3.png alt></p><p>為了讓 interrupt handler 在安全獨立的環境執行，如果當前執行的環境是在 user mode，則會從 user stack context switch 到新的 privileged stack，把當前正在執行的 program state push 到 privileged stack 上，如果此 interrupt 有 error code，也會把 error code push 上去，接著執行 interrupt handler。</p><blockquote><p>Some exceptions will push a 32-bit <strong>error code</strong> on to the top of the stack, which provides additional information about the error. <strong>This value must be pulled from the stack before returning control back to the currently running program</strong>. (i.e. before calling IRET)</p></blockquote><p>interrupt handler 執行完後，privileged stack 上的 program state push 到 user stack 上，接著 context switch ，回復當前的 program state 繼續執行下去。</p><p>有了上述概念之後，我們就可以來實作 interrupt 流程。</p><h2 id=setup-interrupts>Setup Interrupts</h2><h3 id=1-setting-up-the-idt>1. Setting Up the IDT</h3><p>每個 interrupt 都有 idenifer，當 interrupt 觸發時，會透過查找 IDT (Interrupt Descriptor Table) 來取的對應的 interrupt handler address，因此我們需要先設定 IDT。</p><p>在 x86 中有多個預設好的 identifer，本次實驗中就先以這幾項為例子：</p><p><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/i386/s09_01.htm>9.1 Identifying Interrupts</a></p><table><thead><tr><th>identifer</th><th>description</th></tr></thead><tbody><tr><td>0</td><td>Divide error</td></tr><tr><td>1</td><td>Debug exceptions</td></tr><tr><td>2</td><td>Nonmaskable interrupt</td></tr><tr><td>3</td><td>Breakpoint (one-byte INT 3 instruction)</td></tr><tr><td>4</td><td>Overflow (INTO instruction)</td></tr><tr><td>5</td><td>Bounds check (BOUND instruction)</td></tr><tr><td>6</td><td>Invalid opcode</td></tr><tr><td>7</td><td>Coprocessor not available</td></tr><tr><td>8</td><td>Double fault</td></tr><tr><td>9</td><td>(reserved)</td></tr><tr><td>10</td><td>Invalid TSS</td></tr><tr><td>11</td><td>Segment not present</td></tr><tr><td>12</td><td>Stack exception</td></tr><tr><td>13</td><td>General protection</td></tr><tr><td>14</td><td>Page fault</td></tr><tr><td>15</td><td>(reserved)</td></tr><tr><td>16</td><td>Coprecessor error</td></tr><tr><td>17-31</td><td>(reserved)</td></tr><tr><td>32-255</td><td>Available for external interrupts via INTR pin</td></tr></tbody></table><p>首先先建立代表 IDT array。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> Gatedesc idt<span style=color:#1f2328>[</span><span style=color:#0550ae>256</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>{</span> <span style=color:#0550ae>0</span> <span style=color:#1f2328>}</span> <span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>接著把定義好的 interrupt handler 放到對應的 IDT index 中。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// Set up a normal interrupt/trap gate descriptor.
</span></span></span><span style=display:flex><span><span style=color:#57606a>// - istrap: 1 for a trap (= exception) gate, 0 for an interrupt gate.
</span></span></span><span style=display:flex><span><span style=color:#57606a>// - sel: Code segment selector for interrupt/trap handler
</span></span></span><span style=display:flex><span><span style=color:#57606a>// - off: Offset in code segment for interrupt/trap handler
</span></span></span><span style=display:flex><span><span style=color:#57606a>// - dpl: Descriptor Privilege Level -
</span></span></span><span style=display:flex><span><span style=color:#57606a>//	  the privilege level required for software to invoke
</span></span></span><span style=display:flex><span><span style=color:#57606a>//	  this interrupt/trap gate explicitly using an int instruction.
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define SETGATE(gate, istrap, sel, off, dpl)			\
</span></span></span><span style=display:flex><span><span style=color:#57606a>{	                        \
</span></span></span><span style=display:flex><span><span style=color:#57606a>    (gate).gd_off_15_0 = (uint64_t) (off) &amp; 0xffff;		\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_ss = (sel);					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_ist = 0;					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_rsv1 = 0;					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_type = (istrap) ? STS_TG64 : STS_IG64;	\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_s = 0;					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_dpl = (dpl);					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_p = 1;					\
</span></span></span><span style=display:flex><span><span style=color:#57606a>	(gate).gd_off_31_16 = ((uint64_t) (off) &gt;&gt; 16) &amp; 0xffff;		\
</span></span></span><span style=display:flex><span><span style=color:#57606a>    (gate).gd_off_32_63 = ((uint64_t) (off) &gt;&gt; 32) &amp; 0xffffffff;       \
</span></span></span><span style=display:flex><span><span style=color:#57606a>    (gate).gd_rsv2 = 0;               \
</span></span></span><span style=display:flex><span><span style=color:#57606a>}
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_DIVIDE<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> DIVIDE_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_DEBUG<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> DEBUG_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_NMI<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> NMI_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_BRKPT<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> BRKPT_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>);</span>  <span style=color:#57606a>// user mode
</span></span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_OFLOW<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> OFLOW_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_BOUND<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> BOUND_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_ILLOP<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> ILLOP_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_DEVICE<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> DEVICE_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_DBLFLT<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> DBLFLT_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_TSS<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> TSS_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_SEGNP<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> SEGNP_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_STACK<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> STACK_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_GPFLT<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> GPFLT_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_PGFLT<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> PGFLT_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_FPERR<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> FPERR_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_ALIGN<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> ALIGN_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_MCHK<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> MCHK_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_SIMDERR<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> SIMDERR_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>SETGATE</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>[</span>T_SYSCALL<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> GD_KT<span style=color:#1f2328>,</span> SYSCALL_F<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>);</span> <span style=color:#57606a>// user mode
</span></span></span></code></pre></td></tr></table></div></div><p><code>T_DIVIDE</code> 和 <code>DIVIDE_F</code> 這類變數是在其他 file 中定義好的 identifer 和對應 interrupt handler function，就先不提。重點放在如何建立 IDT。我們在這邊使用到 <code>SETGATE</code> ，這個 macro 是用來對 <code>IDT Descriptor</code> 附上指定的數值，具體的 <code>IDT Descriptor</code> format 可以參考：</p><p><img src=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/i386/fig9-3.gif alt></p><p>其中很重要的是 <strong>Descriptor Privilege Level(DPL)</strong> 這個參數，它代表這個 interrupt handler 能不能從 user space 呼叫，畢竟 user 如果能任意呼叫 interrupt，那就有可能對系統造成破壞。而從上面 code 中可以看到，我們允許 user mode 的 interrupt 包含：system call 和 breakpoint 這兩項。</p><p>接著使用 <code>LIDT</code> instruction 來配置 IDT register (IDTR)。
<img src=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/i386/fig9-2.gif alt></p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>struct</span> Pseudodesc idt_pd <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span><span style=color:#0550ae>0</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>idt_pd<span style=color:#1f2328>.</span>pd_lim <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>idt<span style=color:#1f2328>)</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>idt_pd<span style=color:#1f2328>.</span>pd_base <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>uint64_t</span><span style=color:#1f2328>)</span>idt<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// Load the IDT
</span></span></span><span style=display:flex><span><span style=color:#6639ba>lidt</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>idt_pd<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-set-a-stack-for-interrupt-procedure>2. Set a stack for interrupt procedure</h3><p>配置好 interrupt handler，接下來要考慮的問題是：<strong>interrupt 是在哪個 stack 上執行的？</strong></p><p>在一開始有提到，為了確保 interrupt handler 的執行環境，我們會需要一個 privileged stack 來運行 handler，並且使用此 stack 來保存之前運行的狀態。而這個 stack address 資訊是存放在 TSS (Task State Segment) 的 stack segment，因此，我們看以下的 code：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>trap_init_percpu</span><span style=color:#1f2328>(</span><span style=color:#cf222e>void</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Setup a TSS so that we get the right stack
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// when we trap to the kernel.
</span></span></span><span style=display:flex><span>    ts<span style=color:#1f2328>.</span>ts_esp0 <span style=color:#0550ae>=</span> KSTACKTOP<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Initialize the TSS slot of the gdt.
</span></span></span><span style=display:flex><span>    <span style=color:#6639ba>SETTSS</span><span style=color:#1f2328>((</span><span style=color:#cf222e>struct</span> SystemSegdesc64 <span style=color:#0550ae>*</span><span style=color:#1f2328>)((</span>gdt_pd<span style=color:#0550ae>&gt;&gt;</span><span style=color:#0550ae>16</span><span style=color:#1f2328>)</span><span style=color:#0550ae>+</span><span style=color:#0550ae>40</span><span style=color:#1f2328>),</span>STS_T64A<span style=color:#1f2328>,</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>uint64_t</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>ts<span style=color:#1f2328>),</span><span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Taskstate<span style=color:#1f2328>),</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Load the TSS selector (like other segment selectors, the
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// bottom three bits are special; we leave them 0)
</span></span></span><span style=display:flex><span>    <span style=color:#6639ba>ltr</span><span style=color:#1f2328>(</span>GD_TSS0<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到 TSS 的配置，其中 stack pointer 被設置在 <code>KSTACKTOP</code>，這也意味著在 JOS 系統中，interrupt handler 都是在 kernel stack 上執行。</p><h2 id=example>Example</h2><h3 id=1-page-fault-in-jos-lab-3>1. Page fault in JOS lab 3</h3><p>在有了一些概念之後，我們用更具體的例子來說明 JOS 中 interrupt 運作流程，就是開發者最熟悉的 page fault。從 user space 中讀取某個沒有與 physical memory 建立 mapping 的 virtual address，由於硬體找不到此 page，進而觸發 page fault interrupt。</p><p><img src=/posts/lab3_2.png alt></p><p>上述為 JOS 觸發 page fault interrupt 過程，在例子當中，由於是 access 到沒有 mapping 的 virtual address，因此當前運行的 environment(process) 會被 free 掉。如果是一般的作業系統，在當前 process free 掉之後，就會切換到其他 process 繼續執行，不過目前 Lab 3 還沒有實作這個階段。</p><p>此外，JOS 中為了教學所需，JOS 的 interrupt handler 是使用 generic interrupt handler，在 handler 當中才去辨別不同的 interrupt identifer，並且分配給不同的 function 去執行。</p><p>在 page fault handler 中也可以看到一個 control register <code>CR2</code>，這是專門給 page-fault 使用，讓系統可以知道是哪一個 virtual address 不正確。</p><blockquote><p>CR2 — Contains the page-fault linear address (the linear address that caused a
page fault).</p></blockquote><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>page_fault_handler</span><span style=color:#1f2328>(</span><span style=color:#cf222e>struct</span> Trapframe <span style=color:#0550ae>*</span>tf<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> fault_va<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Read processor&#39;s CR2 register to find the faulting address
</span></span></span><span style=display:flex><span>    fault_va <span style=color:#0550ae>=</span> <span style=color:#6639ba>rcr2</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Handle kernel-mode page faults.
</span></span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span><span style=color:#1f2328>((</span>tf<span style=color:#0550ae>-&gt;</span>tf_cs <span style=color:#0550ae>&amp;</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>panic</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;invalid page fault in kernel mode&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// We&#39;ve already handled kernel-mode exceptions, so if we get here,
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// the page fault happened in user mode.
</span></span></span><span style=display:flex><span>    <span style=color:#57606a>// Destroy the environment that caused the fault.
</span></span></span><span style=display:flex><span>    <span style=color:#6639ba>cprintf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;[%08x] user fault va %08x ip %08x</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>        curenv<span style=color:#0550ae>-&gt;</span>env_id<span style=color:#1f2328>,</span> fault_va<span style=color:#1f2328>,</span> tf<span style=color:#0550ae>-&gt;</span>tf_rip<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>print_trapframe</span><span style=color:#1f2328>(</span>tf<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>env_destroy</span><span style=color:#1f2328>(</span>curenv<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=others>Others</h2><h3 id=general-protection-fault>General Protection Fault</h3><p>前面有提到，配置 interrupt handler 的時候需要設定 Descriptor Privilege Level(DPL)，限制 user mode 只能使用某些特定 interrupt。那麼如果 user 執行其他 Privilege Level 的
interrupt，會發生什麼事呢？</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>umain</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> argc<span style=color:#1f2328>,</span> <span style=color:#cf222e>char</span> <span style=color:#0550ae>**</span>argv<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>asm</span> <span style=color:#cf222e>volatile</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;int $14&#34;</span><span style=color:#1f2328>);</span>	<span style=color:#57606a>// page fault
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以此程式為例，在 user mode 直接使用 INT instruction 執行 page fault interrupt，當然這種行為是不被允許的，因為 page fault interrupt 只能在 kernel mode 被觸發。因此， x86 會使用另一個 interrupt handler (General Protection Fault, identifer 13) 去處理。</p><p>而 General Protection Fault interrupt 觸發時機為(<a href=https://wiki.osdev.org/Exceptions#General_Protection_Fault>x86 Exceptions</a>)：</p><ol><li>Segment error (privilege, type, limit, read/write rights).</li><li>Executing a privileged instruction while CPL != 0.</li><li>Writing a 1 in a reserved register field or writing invalid value combinations (e.g. CR0 with PE=0 and PG=1).</li><li>Referencing or accessing a null-descriptor.</li></ol><p>例子中，我們是觸發到第二條規範，因此導致 General Protection Fault。</p><h2 id=結論>結論</h2><p>此篇的重點比較不是在 Lab 3 的實作過程，而是透過 JOS 來了解 interrupt 的機制中可能會使用到哪些 register 和整體運作流程，其中包含 interrupt 的 context、TSS、和 IDT 等，都是蠻重要的知識，當然 linux kernel 的 interrupt 處理過程更為複雜，不過藉由 JOS，可以更具體地知道執行 interrupt 需要哪些要素，是我認為很重要的基礎概念。</p><h2 id=source-code>Source code</h2><p><a href=https://github.com/YuShuanHsieh/CSE-506-jos>YuShuanHsieh/CSE-506-jos</a>
branch: lab3</p><h2 id=references>References</h2><ol><li><a href=https://alex.dzyoba.com/blog/os-interrupts/>Basic x86 interrupts</a></li><li><a href=https://wiki.osdev.org/Exceptions#General_Protection_Fault>Exceptions</a></li><li><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/ia32/IA32-3A.pdf>Intel® 64 and IA-32 ArchitecturesSoftware Developer’s Manual</a></li><li><a href=https://compas.cs.stonybrook.edu/~nhonarmand/courses/sp17/cse506/ref/i386/c09.htm>Chapter 9 Exceptions and Interrupts</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2021-01-15-security_module/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Security model of password managers</span>
</a><a href=https://yushuanhsieh.github.io/posts/2021-02-11-th02-driver/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>TH02 sensor device driver</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>