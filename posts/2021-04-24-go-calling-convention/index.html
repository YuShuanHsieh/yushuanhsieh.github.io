<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>Switch to a register-based calling convention for Go functions — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>Switch to a register-based calling convention for Go functions</h1><div class=post-meta><time datetime=2021-04-24>April 24, 2021</time>
<span class=separator>·</span>
<span class=reading-time>9 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>自己對於 memory layout 相關議題都蠻感興趣的，而這次 Go 1.17 有一項效能改善的 proposal: <a href=https://go.googlesource.com/proposal/+/master/design/40724-register-calling.md><strong>switch to a register-based calling convention for Go functions</strong></a> 剛好跟 memory 有相關，因此就看了一下 proposal 文件介紹，不但複習了在計算機架構中曾接觸到的 calling convention 知識，也對於 Go 內部機制有更多認識。</p><h3 id=application-binary-interface-abi>Application Binary Interface (ABI)</h3><p>在談 calling convention 之前，先來談 ABI。Calling convention 是 <a href=https://en.wikipedia.org/wiki/Application_binary_interface>application binary interface (ABI)</a> 的一部分，而定義 ABI 最主要的目的是建立應用程式與其他應用程式或是與作業系統服務之間低階溝通方式 (依賴 machine code) ，讓應用程式能夠在特定的環境下正確執行。</p><p>在早期，通常提供硬體的廠商也會提供對應的作業系統和編譯器，因此 ABI 也就由硬體廠商所定義規範。不過現在硬體、作業系統、編譯器都可能由獨立的廠商所負責，所以具體 ABI 的實作內容會根據不同廠商而有所不同（當然愈上層的 ABI 規範要能相容底層的規範）。舉例來說，ARM 有 <a href=https://developer.arm.com/architectures/system-architectures/software-standards/abi>arm ABI</a>，而 Microsoft 作業系統有自己的 ABI，再來 Go compiler 又因為其語言特性而定義 Go ABI。</p><p><img src=/posts/stack_2.png alt></p><h3 id=calling-convention>Calling Convention</h3><p>Calling convention 主要定義 callee function 要如何處理從 caller function 接收傳遞過來的 parameters 和如何回傳結果的規範，其中具體實作方式可能包含：</p><ol><li>parameters 如何被傳遞 (e.g. stack, register)</li><li>在 callee function 中必須保存其值的 registers (callee-saved registers)</li><li>caller function 呼叫 callee function 前的準備流程和得到回傳結果後的 restore 流程</li></ol><h4 id=example>Example</h4><p>如同介紹 ABI 時所提到，calling convention 實作方式與當前的 CPU 架構、作業系統、語言編譯器有關，以 x86_64 架構、Linux 作業系統、搭配 C/C++ compiler 為例：</p><ol><li>前六個型態為 integer 或 pointer 的 parameter 會使用 register 來傳遞，其順序為：<strong>RDI, RSI, RDX, RCX, R8, R9</strong></li><li>更多的 parameter 則會使用 <strong>stack</strong> 傳遞</li><li>callee function 回傳的結果，會放在 <strong>RAX 和 RDX register</strong></li><li>如 callee function 要使用 RBX, RSP, RBP, R12–R15 等 register，則 callee 要負責保存其值</li></ol><h4 id=1-register-based-calling-convention>1. Register-based calling convention</h4><p>Register-based calling convention 顧名思義就是先以 register 來傳遞 parameter 給 callee function，上面提到在 x86_64 Linux 系統下， C program 會使用 RDI, RSI, RDX, RCX, R8, R9 表示 1 - 6 參數，這就是 register-based calling convention 的實作。</p><p>我們用簡單的 c program 搭配 objdump 來觀察 machine code</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> b<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>return</span> a <span style=color:#0550ae>+</span> b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>int</span> n <span style=color:#0550ae>=</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 disable optimization (-O0) 情況下， machine code 如下</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>100003f70: <span style=color:#0550ae>55</span>                          	pushq	%rbp
</span></span><span style=display:flex><span>100003f71: <span style=color:#0550ae>48</span> <span style=color:#0550ae>89</span> e5                    	movq	%rsp, %rbp
</span></span><span style=display:flex><span>100003f74: <span style=color:#0550ae>89</span> 7d <span style=color:#6639ba>fc</span>                    	movl	%edi, -4<span style=color:#0550ae>(</span>%rbp<span style=color:#0550ae>)</span> <span style=color:#57606a># a</span>
</span></span><span style=display:flex><span>100003f77: <span style=color:#0550ae>89</span> <span style=color:#0550ae>75</span> f8                    	movl	%esi, -8<span style=color:#0550ae>(</span>%rbp<span style=color:#0550ae>)</span> <span style=color:#57606a># b</span>
</span></span><span style=display:flex><span>100003f7a: 8b <span style=color:#0550ae>45</span> <span style=color:#6639ba>fc</span>                    	movl	-4<span style=color:#0550ae>(</span>%rbp<span style=color:#0550ae>)</span>, %eax
</span></span><span style=display:flex><span>100003f7d: <span style=color:#0550ae>03</span> <span style=color:#0550ae>45</span> f8                    	addl	-8<span style=color:#0550ae>(</span>%rbp<span style=color:#0550ae>)</span>, %eax <span style=color:#57606a># return a + b</span>
</span></span><span style=display:flex><span>100003f80: 5d                          	popq	%rbp
</span></span><span style=display:flex><span>100003f81: c3                          	retq
</span></span></code></pre></td></tr></table></div></div><p>可以看到 foo callee function 分別使用 DI , SI 來接收 a 和 b parameter，並且透過 AX register 保存其結果值。只有在 parameter 個數大於 6 的時候，才會使用 stack 空間來傳遞參數。(推薦閱讀 <a href=https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64>Stack frame layout on x86-64</a>)</p><h4 id=2-stack-based-calling-convention>2. Stack-based calling convention</h4><p>與 register-based 不同，stack-based calling convention 則是直接使用 stack 空間來傳遞參數給 callee function。由於 Go ABI 是採用 stack-based calling convention，所以我們同樣地用 Go 寫個簡單例子，並且 objdump machine code 觀察。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;fmt&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>foo</span><span style=color:#1f2328>(</span><span style=color:#1f2328>a</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff> </span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>int</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>c</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>a</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#1f2328>b</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>c</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>res</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>foo</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>在 disable optimization (<code>-gcflags '-N -l'</code>) 情況下， machine code 如下</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-shell data-lang=shell><span style=display:flex><span>109cfa0: <span style=color:#0550ae>48</span> <span style=color:#0550ae>83</span> ec <span style=color:#0550ae>10</span>                  	subq	<span style=color:#953800>$16</span>, %rsp
</span></span><span style=display:flex><span>109cfa4: <span style=color:#0550ae>48</span> <span style=color:#0550ae>89</span> 6c <span style=color:#0550ae>24</span> <span style=color:#0550ae>08</span>               	movq	%rbp, 8<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>109cfa9: <span style=color:#0550ae>48</span> 8d 6c <span style=color:#0550ae>24</span> <span style=color:#0550ae>08</span>               	leaq	8<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>, %rbp
</span></span><span style=display:flex><span>109cfae: <span style=color:#0550ae>48</span> c7 <span style=color:#0550ae>44</span> <span style=color:#0550ae>24</span> <span style=color:#0550ae>28</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span>   	movq	<span style=color:#953800>$0</span>, 40<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span>109cfb7: <span style=color:#0550ae>48</span> 8b <span style=color:#0550ae>44</span> <span style=color:#0550ae>24</span> <span style=color:#0550ae>18</span>               	movq	24<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>, %rax  <span style=color:#57606a># a</span>
</span></span><span style=display:flex><span>109cfbc: <span style=color:#0550ae>48</span> <span style=color:#0550ae>03</span> <span style=color:#0550ae>44</span> <span style=color:#0550ae>24</span> <span style=color:#0550ae>20</span>               	addq	32<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>, %rax  <span style=color:#57606a># b</span>
</span></span><span style=display:flex><span>109cfc1: <span style=color:#0550ae>48</span> <span style=color:#0550ae>89</span> <span style=color:#0550ae>04</span> <span style=color:#0550ae>24</span>                  	movq	%rax, <span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span> <span style=color:#57606a># c</span>
</span></span><span style=display:flex><span>109cfc5: <span style=color:#0550ae>48</span> <span style=color:#0550ae>89</span> <span style=color:#0550ae>44</span> <span style=color:#0550ae>24</span> <span style=color:#0550ae>28</span>               	movq	%rax, 40<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span> <span style=color:#57606a># return</span>
</span></span><span style=display:flex><span>109cfca: <span style=color:#0550ae>48</span> 8b 6c <span style=color:#0550ae>24</span> <span style=color:#0550ae>08</span>               	movq	8<span style=color:#0550ae>(</span>%rsp<span style=color:#0550ae>)</span>, %rbp
</span></span><span style=display:flex><span>109cfcf: <span style=color:#0550ae>48</span> <span style=color:#0550ae>83</span> c4 <span style=color:#0550ae>10</span>                  	addq	<span style=color:#953800>$16</span>, %rsp
</span></span><span style=display:flex><span>109cfd3: c3                           	retq
</span></span></code></pre></td></tr></table></div></div><p>可以看到 foo function 是直接從 stack 中取出其 a 與 b 的值並放到 AX register 進行計算，計算出的結果也是直接放入指定的 stack 位置中。下圖為 stack 配置：</p><p><img src=/posts/stack.png alt></p><h4 id=the-difference-between-register-based-and-stack-based-calling-convention>The difference between register-based and stack-based calling convention</h4><p>其中兩者最大的差異就在於 memory access performance，畢竟 access register 的速度還是高於 stack memory address，根據 proposal 文件指出，其效能差距約 40%。另外，文件也指出另一個 performance 議題，就是 stack-based calling convention 完全仰賴 stack memory，會增加額外的 memory traffic。</p><h3 id=why-does-go-use-stack-based-calling-convention>Why does Go use stack-based calling convention</h3><p>既然 register-based calling convention 的效能很明顯比較好，那為什麼當初設計 Go 的時候，會採用 stack-based calling convention 呢？其主要原因還是跟實作難易度和 Go 的特性有關，在文件中有提到幾點：</p><ol><li>The rules of the calling convention are simple and build on existing struct layout rules</li><li>All platforms can use essentially the same conventions, leading to shared, portable compiler and runtime code</li><li>Call frames have an obvious first-class representation, which simplifies the implementation of the go and defer statements and reflection calls.</li></ol><p>可以看到，如果 Go 初期就採用 register-based calling convention 設計，那麽在實作上難度會增加許多。不過，在經過這十一年來 Go 逐漸穩定及愈來愈多公司和開發者使用，他們可能也覺得該是重視此效能改善問題的時候了，因此預計 Go 1.17 會先基於 amd64 架構實作 register-based calling convention，再逐漸地拓展到其他 CPU 架構並且根據反應來改善實作方式。</p><h3 id=後記>後記</h3><p>如果不是因為這個 proposal，我應該都還不知道 Go 是 stack-based calling convention，甚至因為只有仔細看過 C program 的 machine code，我一直以為 parameter 都是先放在 register 的，現在才比較清楚知道原來每個語言也會根據需求來實作不同的 ABI，以及為什麼 Go 會需要專屬的 ABI 設計，而這是其中最重要的學習。</p><h3 id=references>References</h3><ol><li><a href=https://people.freebsd.org/~obrien/amd64-elf-abi.pdf>https://people.freebsd.org/~obrien/amd64-elf-abi.pdf</a></li><li><a href=https://en.wikipedia.org/wiki/X86_calling_conventions>https://en.wikipedia.org/wiki/X86_calling_conventions</a></li><li><a href=https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64>https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64</a></li></ol></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2021-04-22-life/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>近況雜談</span>
</a><a href=https://yushuanhsieh.github.io/posts/2021-04-23-life/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>CSE 506 Lab 4 - Multiprocessor Support</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>