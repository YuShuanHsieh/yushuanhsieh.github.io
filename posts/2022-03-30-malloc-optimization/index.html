<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>GCC malloc + memset Optimization — Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771496292"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>⟨/⟩</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>GCC malloc + memset Optimization</h1><div class=post-meta><time datetime=2022-03-30>March 30, 2022</time>
<span class=separator>·</span>
<span class=reading-time>5 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/c/>C</a>
<a href=https://yushuanhsieh.github.io/categories/gnu/>GNU</a></div></header><div class=post-content><p>最近踩到 compiler optimization 的一個小坑，gcc5 版本以上，開啟 optimization level 2 時，會將 malloc + memeset 轉換成 calloc。看起來似乎蠻有道理的改善，卻因為我在進行客製化 malloc 時，沒有這注意到這點，導致最後程式執行的是 libc 的 calloc 而不是我的 wrap_malloc。</p><h2 id=起因>起因</h2><p>使用 <code>void *__wrap_malloc(size_t size)</code> 將 malloc function 進行額外的處理 (<a href=http://www.samanbarghi.com/blog/2014/09/05/how-to-wrap-a-system-call-libc-function-in-linux/>How to wrap a system call (libc function) in Linux</a>)，其中一段 code 為:</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>ptr <span style=color:#0550ae>=</span> <span style=color:#6639ba>malloc</span><span style=color:#1f2328>(</span>SIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>ptr<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>memset</span><span style=color:#1f2328>(</span>ptr<span style=color:#1f2328>,</span> <span style=color:#0550ae>0x0</span><span style=color:#1f2328>,</span> SIZE<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>但實際上執行時卻不如預期執行到 malloc，dump code 之後發現這段 code 被調整成 calloc。</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// gcc version 9.4.0
</span></span></span><span style=display:flex><span><span style=color:#57606a>// gcc -O0
</span></span></span><span style=display:flex><span>mov	x0<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>#</span>SIZE
</span></span><span style=display:flex><span>bl	malloc
</span></span><span style=display:flex><span>str	x0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>ldr	x0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>cmp	x0<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>beq	<span style=color:#1f2328>.</span>L2
</span></span><span style=display:flex><span>mov	x2<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>#</span>SIZE
</span></span><span style=display:flex><span>mov	w1<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>ldr	x0<span style=color:#1f2328>,</span> <span style=color:#1f2328>[</span>sp<span style=color:#1f2328>,</span> <span style=color:#0550ae>24</span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>bl	memset
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// gcc -O2
</span></span></span><span style=display:flex><span>mov	x1<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>mov	x0<span style=color:#1f2328>,</span> <span style=color:#f6f8fa;background-color:#82071e>#</span>SIZE
</span></span><span style=display:flex><span>b	calloc
</span></span></code></pre></td></tr></table></div></div><h2 id=malloc--memset-optimization>malloc + memset Optimization</h2><p>GCC commit:
<a href="https://gcc.gnu.org/git/?p=gcc.git&amp;a=commit;h=24314386b32b93c759c6722a2c18facae15128ea">PR tree-optimization/57742 (memset(malloc(n),0,n) -> calloc(n,1))</a></p><p>calloc 看起來結果跟 malloc + memset to zero 一樣，但是根據實作差異，calloc 在某些情況下，效率會較 malloc + memset 好。</p><p>舉例來說，在 allocate 指定大小的記憶體空間時，如果這個記憶體空間所對應的 page 是當前透過 <a href=https://man7.org/linux/man-pages/man2/mmap.2.html>mmap</a> 來的，這表示此 page 對應的空間已被清空歸零，因此不需要再逐一清空。</p><blockquote><p>當 allocator 剩餘空間不足以分配指定的記憶體空間，會透過 sysmalloc 的方式，使用 mmap 向系統新申請以 page 為單位的空間，而在呼叫 mmap 時，會帶有 <code>MAP_ANONYMOUS</code> 的 flag，這也意味著 page 所有的內容會被初始化歸零。基於安全考量，如果取得沒有初始化的 page ，會導致其他使用此 physical memory 的 process 處理的資料被取得，因此一般情況下都會被初始化，不過如果因為其他因素而不需要初始化，可以透過 <code>CONFIG_MMAP_ALLOW_UNINITIALIZED</code> kernel option 來設定)</p></blockquote><p>除此之外，calloc 在將記憶體初始化歸零時，也可以透過實作來進行效能改善，以 libc 所實作的 calloc 為例：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span> <span style=color:#57606a>/* Unroll clear of &lt;= 36 bytes (72 if 8byte sizes).  We know that
</span></span></span><span style=display:flex><span><span style=color:#57606a> contents have an odd number of INTERNAL_SIZE_T-sized words;
</span></span></span><span style=display:flex><span><span style=color:#57606a> minimally 3.  */</span>
</span></span><span style=display:flex><span>d <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span>INTERNAL_SIZE_T <span style=color:#0550ae>*</span><span style=color:#1f2328>)</span> mem<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>clearsize <span style=color:#0550ae>=</span> csz <span style=color:#0550ae>-</span> SIZE_SZ<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>nclears <span style=color:#0550ae>=</span> clearsize <span style=color:#0550ae>/</span> <span style=color:#cf222e>sizeof</span> <span style=color:#1f2328>(</span>INTERNAL_SIZE_T<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#6639ba>assert</span> <span style=color:#1f2328>(</span>nclears <span style=color:#0550ae>&gt;=</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>nclears <span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>9</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>return</span> <span style=color:#6639ba>memset</span> <span style=color:#1f2328>(</span>d<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> clearsize<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>else</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>nclears <span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>4</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>      <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>      <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>4</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>      <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>nclears <span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>6</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>          <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>5</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>          <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>6</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>          <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>nclears <span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>8</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>              <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>7</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>              <span style=color:#0550ae>*</span><span style=color:#1f2328>(</span>d <span style=color:#0550ae>+</span> <span style=color:#0550ae>8</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>透過 <a href=https://en.wikipedia.org/wiki/Loop_unrolling>loop unrolling</a> 的手法來初始化小於 36 bytes 的記憶體空間。</p><h3 id=issues>Issues</h3><p>在查找相關資料的時候，看到一個有趣的討論 <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=67618">Bug 67618 - malloc+memset optimization breaks code</a>，由於此改善，導致有人抱怨 code 出現問題，主要原因是：</p><div class=highlight><div style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>ptr <span style=color:#0550ae>=</span> <span style=color:#6639ba>malloc</span><span style=color:#1f2328>(</span>SIZE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>ptr<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#6639ba>memset</span><span style=color:#1f2328>(</span>ptr<span style=color:#1f2328>,</span> <span style=color:#0550ae>0x0</span><span style=color:#1f2328>,</span> SIZE<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>即使有 if 條件判斷的情況下，一樣會被調整成 calloc。不過 committer 表示，malloc 本意是分配一個可用的空間，其內容是初始化或是非初始化，都不應影響 code 運行。</p></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2022-02-26-crypto-subsystem_1/ class="post-nav-link prev"><span class=label>← Previous</span>
<span class=title>Crypto Subsystem of Linux Kernel - Asynchronous & Synchronous</span>
</a><a href=https://yushuanhsieh.github.io/posts/2022-04-20-crypto_subsystem_async/ class="post-nav-link next"><span class=label>Next →</span>
<span class=title>Crypto Subsystem of Linux Kernel - Asynchronous Request Handling Mechanism</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>