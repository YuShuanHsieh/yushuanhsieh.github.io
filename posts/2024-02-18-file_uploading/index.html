<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A technical blog about software engineering, system design, and modern development practices."><meta name=author content="Cherie Hsieh"><title>The issue of uploading a large-size file using HTTP formdata â€” Cherie's Tech Blog</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href="/css/style.css?v=1771486583"></head><body><header class=site-header><div class=header-inner><a href=https://yushuanhsieh.github.io/ class=site-logo><span class=logo-icon>âŸ¨/âŸ©</span>
<span class=logo-text>Cherie's Tech Blog</span></a><nav class=site-nav><a href=/ class=nav-link>Home</a>
<a href=/posts/ class=nav-link>Posts</a>
<a href=/categories/ class=nav-link>Categories</a>
<a href=/about/ class=nav-link>About</a></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span></span>
<span></span>
<span></span></button></div></header><main class=site-main><article class=single-post><header class=post-header><h1 class=post-title>The issue of uploading a large-size file using HTTP formdata</h1><div class=post-meta><time datetime=2024-02-17>February 17, 2024</time>
<span class=separator>Â·</span>
<span class=reading-time>6 min read</span></div><div class=post-categories><a href=https://yushuanhsieh.github.io/categories/python/>Python</a>
<a href=https://yushuanhsieh.github.io/categories/go/>Go</a></div></header><div class=post-content><p>æ¥çºŒ<a href=/post/2024-01-27-python_fastapi_formdata/>å‰é¢æ–‡ç« </a>æåŠåˆ°ï¼Œåœ¨ä¸Šå‚³æª”æ¡ˆçš„ä½¿ç”¨æƒ…å¢ƒä¹‹ä¸‹ï¼Œå› ç‚º user request æ•¸é‡å¢å¤šï¼Œé€ æˆ service lead time å¤§å¹…æå‡çš„å•é¡Œï¼›è€Œå°è‡´ lead time å¢åŠ çš„å› ç´ ï¼Œæ ¹æ“šå¯¦é©—æ•¸æ“šï¼Œä¸»è¦æ˜¯å› ç‚ºï¼š</p><ul><li>The different implementation methods of receiving the file</li><li>The concurrency model of language runtime</li></ul><p>è‹¥è¦å¾æ ¹æœ¬ä¾†æ”¹å–„æ­¤å•é¡Œï¼Œéœ€è¦å¾å…©å€‹å±¤é¢ä¾†è‘—æ‰‹ï¼š</p><ul><li>Client side: user å¦‚ä½•å‚³é€å¤¾å¸¶æª”æ¡ˆå…§å®¹çš„ request åˆ° server</li><li>Server side: server å¦‚ä½•ä¾æ“š client ç™¼é€ request çš„æµç¨‹ä¾†è™•ç†æ­¤æª”æ¡ˆ</li></ul><p>é€éä½¿ç”¨è€…è¨ªè«‡å¾Œï¼Œæˆ‘å€‘é æœŸçš„ä½¿ç”¨æƒ…å¢ƒï¼ŒåŒ…å«ï¼š</p><ul><li>æª”æ¡ˆæœƒä½¿ç”¨ <code>multipart/form-data</code> çš„æ–¹å¼ä¾†å‚³é€ï¼Œå¦å¤– form-data ä¸­ä¹ŸæœƒåŒ…å«é¡å¤– server æ‰€éœ€çš„è³‡è¨Š</li><li>å…¶å‚³é€çš„æª”æ¡ˆå¤§å°ä¸å®šï¼Œæœ€å¤§å¯ä»¥è‡³ 1G</li><li>Client æœƒä½¿ç”¨ HTTP/1.1 protocol ä¾†ç™¼é€ requests</li></ul><p>åœ¨é€™æ¨£çš„ä½¿ç”¨å‰æä¹‹ä¸‹ï¼Œæˆ‘å€‘å°±å¯ä»¥ä¾†ç ”ç©¶ client ç«¯æ˜¯å¦‚ä½•ä¾†ç™¼é€ requestï¼Œä¸¦é€²è€Œå¾ server ç«¯ä¾†é€²è¡Œæ”¹å–„ã€‚</p><p>The previous article mentioned that in the context of uploading files, an increase in user request volume leads to a significant increase in service lead time. According to experimental data, the main factors contributing to this increase in lead time are:</p><ul><li>The various implementation methods of receiving the file.</li><li>The concurrency model of the language runtime.</li></ul><p>To fundamentally address this issue, we need to approach it from two perspectives:</p><ul><li>Client Side: How the user sends the file content to the server.</li><li>Server Side: How the server receives the file sent by the user through specific mechanisms.</li></ul><p>After conducting user interviews, our use case scenarios include:</p><ul><li>As defined by the API specifications, files will be sent using formdata, which also includes other user - information.</li><li>The size of the files sent will vary, with a maximum size of up to 1GB.</li><li>The client will use the HTTP/1.1 protocol to send requests.</li></ul><p>Based on the use cases, we can now examine how the client sends requests.</p><h2 id=client-side-sending-an-http-request-with-large-size-files>Client Side: Sending an HTTP Request with Large-Size Files</h2><p>å¾ client ç«¯é€é HTTP/1.1 protocol å‚³é€æª”æ¡ˆåˆ° server ç«¯ï¼Œæ¨™æº–åšæ³•å°±æ˜¯ä½¿ç”¨ <code>multipart/form-data</code> ä¸¦ä¸”å°‡å®Œæ•´çš„æª”æ¡ˆå…§å®¹å¤¾å¸¶åœ¨å…¶ä¸­é€å‡ºï¼›è€Œæ­¤æ™‚ HTTP request ä¸­æœƒç´€éŒ„(using <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Length>Content-Length header</a>)æ•´å€‹ request body é€£åŒæª”æ¡ˆå¤§å°çš„é•·åº¦è³‡è¨Šï¼Œè®“ server ç«¯å¯ä»¥æ ¹æ“š Content-Length header ä¾†åˆ¤æ–· request æ˜¯å¦æ¥æ”¶å®Œæˆã€‚</p><p><img src=/posts/20240217_http-request_1.png alt></p><div class=info-block>ğŸ“– <b>The workflow of sending and receiving the HTTP request</b><br>1. The client organizes a HTTP request<br>2. The OS kernel breaks it into smaller TCP packets and sends them to the server<br>3. The server OS kernel receives the TCP packets and sends them to Server application layer via the socket.<br>4. The server receives the TCP packets and organize them into a completed HTTP request according to the content-length<br>5. The server passes the HTTP request to the handlers<br></div><p>ä¾æ“šä¸Šè¿°çš„ request å‚³é€éç¨‹ï¼Œåœ¨å‚³é€æª”æ¡ˆé•·åº¦è¼ƒé•·çš„æª”æ¡ˆæ™‚ï¼Œæœƒé‡åˆ°ä¸€äº›æ½›åœ¨çš„å•é¡Œï¼š</p><ul><li>ç•¶ request body çš„é•·åº¦å¤ªé•·æ™‚ï¼Œæ ¹æ“š web framework å¯¦ä½œæ–¹å¼ä¸åŒï¼Œæœ‰å¯èƒ½æœƒ blocking åœ¨æ­¥é©Ÿ 4ï¼Œå› ç‚ºå¿…é ˆç­‰å¾…æ•´å€‹ request æ¥æ”¶å®Œå¾Œæ‰æœƒé€åˆ° handler é€²è¡Œè™•ç†</li><li>reuqest body é•·åº¦é•·ï¼Œä¹Ÿæ„å‘³è‘— server ç«¯åœ¨é‡çµ„ HTTP request éç¨‹ä¸­æœƒéœ€è¦ä½”ç”¨è¼ƒå¤šçš„è¨˜æ†¶é«”ï¼Œè€Œæ­¤æ™‚å¦‚æœ user request æ•¸é‡å¢å¤šï¼Œå°‡å° server é€ æˆè¨˜æ†¶é«”å£“åŠ›ï¼Œç”šè‡³æœ‰å¯èƒ½å› æ­¤ server å› ç‚ºè¨˜æ†¶é«”ä¸è¶³è€Œæ„å¤–çµ‚æ­¢</li></ul><p>å‚³é€å¤§å‹æª”æ¡ˆè€Œé€ æˆçš„è¨˜æ†¶é«”ä¸è¶³å•é¡Œï¼Œä¸åªæœƒç™¼ç”Ÿåœ¨ server ç«¯ï¼ŒåŒæ¨£åœ°ä¹Ÿæœƒç™¼ç”Ÿåœ¨ client ç«¯ï¼Œå› ç‚º client ç«¯ä¹Ÿéœ€è¦æŠŠæ•´å€‹æª”æ¡ˆçš„å…§å®¹è®€å–åˆ°è¨˜æ†¶é«”ä¸­ï¼Œæ‰èƒ½çµ„æˆ HTTP request é€²è¡Œç™¼é€ã€‚</p><h3 id=streaming-data---transfer-encoding-chunked>Streaming Data - Transfer-Encoding: chunked</h3><p>å¦‚æœè®€å–æ•´å€‹æª”æ¡ˆå¤§å°çš„æ–¹å¼å¤ªä½”ç”¨è¨˜æ†¶é«”ï¼Œé‚£éº¼æ˜¯å¦å¯ä»¥æŠŠæª”æ¡ˆåˆ‡åˆ†æˆå°æ®µå†ç™¼é€çµ¦ server å‘¢ï¼Ÿæˆ‘å€‘å¯ä»¥é€é <a href=https://en.wikipedia.org/wiki/Chunked_transfer_encoding>Chunked transfer encoding</a> é€™å€‹æ©Ÿåˆ¶ä¾†å¹«åŠ©æˆ‘å€‘å¯¦ç¾æ­¤æƒ³æ³•ã€‚</p><div class=info-block>ğŸ“– <b>7.1. Chunked Transfer Coding</b><br>The chunked transfer coding wraps content in order to transfer it as a series of chunks, each with its own size indicator, followed by an OPTIONAL trailer section containing trailer fields.</div><p>Chunked transfer encoding æœ€åˆçš„æƒ³æ³•æ˜¯ç”¨ä¾†ç™¼é€æœªçŸ¥é•·åº¦çš„ request æˆ– responseï¼ŒæŠŠè³‡æ–™åˆ‡åˆ†æˆå¤šå€‹å°æ®µçš„ chunked data ä¸¦åˆ†åˆ¥ä½¿ç”¨ HTTP request é€è‡³ serverï¼Œå…¶ä¸­æœ€å¤§çš„å·®ç•°å°±æ˜¯ä¸ä½¿ç”¨ Content-Length ä¾†æå‰è¨»æ˜ body çš„é•·åº¦ï¼Œè€Œæ˜¯æ”¹æ¡ç”¨ zero-length chunk ä¾†å‘ŠçŸ¥ server æ­¤ HTTP request body ä¸­åŒ…å«æœ€å¾Œä¸€æ®µçš„è³‡æ–™ã€‚</p><p><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Transfer-Encoding#examples>The example of chunked encoding</a></p><p>é‹ç”¨é€™æ¨£çš„æ©Ÿåˆ¶ï¼ŒåŸæœ¬åŒ…å«å®Œæ•´æª”æ¡ˆå…§å®¹çš„ä¸€å€‹ HTTP requestï¼Œè¢«æ‹†åˆ†æˆå¤šå€‹åŒ…å«éƒ¨åˆ†å…§å®¹çš„ HTTP requestï¼Œè€Œ HTTP handler å°±å¯ä»¥ä¾æ“šéœ€æ±‚ä¾†è™•ç†é€™äº›è¢«åˆ†æ®µçš„å…§å®¹ï¼Œä¾‹å¦‚æš«å­˜åˆ°æœ¬åœ°ç«¯ä»¥ä¾›å¾ŒçºŒä½¿ç”¨ï¼Œé€™æ¨£ä¹Ÿå°±èƒ½é¿å…å› ç‚ºè³‡æ–™é•·åº¦éé•·é€ æˆçš„è¨˜æ†¶é«”ä¸è¶³å•é¡Œã€‚</p><h2 id=server-side-receive-an-http-request-with-large-size-files>Server Side: Receive an HTTP Request with Large-Size Files</h2></div><footer class=post-footer><div class=post-nav><a href=https://yushuanhsieh.github.io/posts/2024-01-27-python_fastapi_formdata/ class="post-nav-link prev"><span class=label>â† Previous</span>
<span class=title>Python FastAPI FormData æ•ˆèƒ½è­°é¡Œ</span>
</a><a href=https://yushuanhsieh.github.io/posts/2024-03-09-golang_routing/ class="post-nav-link next"><span class=label>Next â†’</span>
<span class=title>å¾ Golang 1.22 routing enhancement çœ‹å°ˆæ¡ˆé–‹ç™¼</span></a></div></footer></article></main><footer class=site-footer><div class=footer-inner><p class=footer-copyright>&copy; 2026 Cherie's Tech Blog. All rights reserved.</p><p class=footer-powered>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></p></div></footer></body></html>